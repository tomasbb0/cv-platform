<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CV Editor Platform</title>
    <style>
      :root {
        --bg: #0f0f0f;
        --panel: #1a1a1a;
        --border: #2a2a2a;
        --text: #e0e0e0;
        --muted: #888;
        --accent: #3b82f6;
        --accent-hover: #2563eb;
        --danger: #ef4444;
        --success: #22c55e;
        --paper-w: 210mm;
        --paper-h: 297mm;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family:
          "SF Pro Display",
          -apple-system,
          BlinkMacSystemFont,
          "Inter",
          sans-serif;
        background: var(--bg);
        color: var(--text);
        height: 100vh;
        overflow: hidden;
      }

      /* â•â•â• LAYOUT â•â•â• */
      .app {
        display: flex;
        height: 100vh;
      }
      /* â•â•â• CHAT PANEL (far left) â•â•â• */
      .chat-panel {
        width: 320px;
        min-width: 280px;
        max-width: 400px;
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        background: var(--panel);
        overflow: hidden;
        transition: width 0.2s;
      }
      .chat-panel.collapsed {
        width: 0;
        min-width: 0;
        overflow: hidden;
        border: none;
      }
      .chat-panel.collapsed * {
        display: none;
      }
      .chat-header {
        padding: 10px 14px;
        background: #151515;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
      }
      .chat-header h2 {
        font-size: 13px;
        font-weight: 700;
        flex: 1;
        letter-spacing: 0.3px;
      }
      .chat-header h2 span {
        color: var(--accent);
      }
      .chat-config {
        padding: 10px 14px;
        border-bottom: 1px solid var(--border);
        background: #161616;
        flex-shrink: 0;
      }
      .chat-config label {
        font-size: 10px;
        font-weight: 600;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: block;
        margin-bottom: 4px;
      }
      .chat-config select,
      .chat-config input[type="password"],
      .chat-config input[type="text"] {
        width: 100%;
        padding: 6px 10px;
        background: #222;
        border: 1px solid var(--border);
        border-radius: 5px;
        color: var(--text);
        font-size: 11px;
        font-family: inherit;
        margin-bottom: 6px;
      }
      .chat-config .connect-row {
        display: flex;
        gap: 6px;
        align-items: center;
      }
      .chat-config .connect-status {
        font-size: 10px;
        flex: 1;
      }
      .chat-config .connect-status.connected {
        color: var(--success);
      }
      .chat-config .connect-status.disconnected {
        color: var(--muted);
      }
      .chat-config .connect-status.error {
        color: var(--danger);
      }
      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .chat-msg {
        max-width: 95%;
        padding: 8px 12px;
        border-radius: 10px;
        font-size: 12px;
        line-height: 1.5;
        word-wrap: break-word;
      }
      .chat-msg.assistant {
        background: #1e293b;
        color: #e0e0e0;
        align-self: flex-start;
        border-bottom-left-radius: 2px;
      }
      .chat-msg.user {
        background: var(--accent);
        color: #fff;
        align-self: flex-end;
        border-bottom-right-radius: 2px;
      }
      .chat-msg.system {
        background: transparent;
        color: var(--muted);
        font-size: 10px;
        text-align: center;
        align-self: center;
        font-style: italic;
      }
      .chat-msg code {
        background: rgba(0, 0, 0, 0.3);
        padding: 1px 4px;
        border-radius: 3px;
        font-size: 11px;
      }
      .chat-msg pre {
        background: rgba(0, 0, 0, 0.3);
        padding: 8px;
        border-radius: 6px;
        overflow-x: auto;
        margin: 6px 0;
        font-size: 11px;
      }
      .chat-input-area {
        padding: 10px;
        border-top: 1px solid var(--border);
        background: #151515;
        flex-shrink: 0;
      }
      .chat-input-row {
        display: flex;
        gap: 6px;
        align-items: flex-end;
      }
      .chat-input-row textarea {
        flex: 1;
        resize: none;
        padding: 8px 10px;
        background: #222;
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-size: 12px;
        font-family: inherit;
        min-height: 36px;
        max-height: 120px;
        line-height: 1.4;
      }
      .chat-input-row textarea:focus {
        outline: none;
        border-color: var(--accent);
      }
      .chat-input-row .send-btn {
        background: var(--accent);
        border: none;
        color: #fff;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: background 0.15s;
      }
      .chat-input-row .send-btn:hover {
        background: var(--accent-hover);
      }
      .chat-input-row .send-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      .chat-attach-btn {
        background: none;
        border: 1px solid var(--border);
        color: var(--muted);
        width: 36px;
        height: 36px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.15s;
      }
      .chat-attach-btn:hover {
        color: var(--text);
        border-color: var(--text);
      }
      .chat-attachments {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
        margin-bottom: 6px;
      }
      .chat-attachment-tag {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: #2a2a2a;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 10px;
        color: var(--muted);
      }
      .chat-attachment-tag .remove-att {
        cursor: pointer;
        color: var(--danger);
        font-weight: 700;
      }
      /* â•â•â• DIFF/COMMIT UI â•â•â• */
      .diff-block {
        background: #111;
        border: 1px solid var(--border);
        border-radius: 8px;
        margin: 8px 0;
        overflow: hidden;
        font-size: 11px;
      }
      .diff-header {
        padding: 6px 10px;
        background: #1a1a2e;
        color: var(--accent);
        font-weight: 600;
        font-size: 10px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .diff-header input[type="checkbox"] {
        accent-color: var(--accent);
      }
      .diff-row {
        padding: 4px 10px;
        font-family: "SF Mono", "Fira Code", monospace;
      }
      .diff-row.before {
        background: #2d1515;
        color: #f87171;
      }
      .diff-row.after {
        background: #152d15;
        color: #4ade80;
      }
      .diff-actions {
        padding: 8px 10px;
        display: flex;
        gap: 6px;
      }
      /* â•â•â• INSTRUCTIONS COLLAPSIBLE â•â•â• */
      .chat-instructions {
        border-top: 1px solid var(--border);
        flex-shrink: 0;
      }
      .chat-instructions summary {
        padding: 8px 14px;
        font-size: 10px;
        font-weight: 600;
        color: var(--muted);
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .chat-instructions .inst-body {
        padding: 8px 14px;
        font-size: 10px;
        color: var(--muted);
        line-height: 1.6;
        max-height: 200px;
        overflow-y: auto;
      }
      .chat-instructions .inst-body h4 {
        color: var(--text);
        margin: 6px 0 2px;
        font-size: 11px;
      }
      .chat-instructions .inst-body code {
        background: #222;
        padding: 1px 4px;
        border-radius: 3px;
      }
      .toggle-chat-btn {
        position: fixed;
        top: 50%;
        left: 0;
        transform: translateY(-50%);
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 0 6px 6px 0;
        padding: 8px 4px;
        font-size: 12px;
        cursor: pointer;
        z-index: 100;
        writing-mode: vertical-rl;
        font-weight: 600;
        font-size: 10px;
        letter-spacing: 0.5px;
      }
      .chat-panel:not(.collapsed) ~ .toggle-chat-btn {
        display: none;
      }
      .editor-panel {
        width: 40%;
        min-width: 350px;
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .preview-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        overflow-y: auto;
        background: #252525;
      }

      /* â•â•â• TOOLBAR â•â•â• */
      .toolbar {
        padding: 12px 16px;
        background: var(--panel);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 10px;
        flex-shrink: 0;
      }
      .toolbar h1 {
        font-size: 14px;
        font-weight: 700;
        letter-spacing: 0.5px;
        flex: 1;
      }
      .toolbar h1 span {
        color: var(--accent);
      }
      .btn {
        padding: 6px 14px;
        border: none;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s;
        font-family: inherit;
      }
      .btn-primary {
        background: var(--accent);
        color: #fff;
      }
      .btn-primary:hover {
        background: var(--accent-hover);
      }
      .btn-secondary {
        background: #333;
        color: var(--text);
      }
      .btn-secondary:hover {
        background: #444;
      }
      .btn-danger {
        background: var(--danger);
        color: #fff;
      }
      .btn-danger:hover {
        background: #dc2626;
      }
      .btn-sm {
        padding: 4px 8px;
        font-size: 10px;
      }

      /* â•â•â• STATUS BAR â•â•â• */
      .status-bar {
        padding: 6px 16px;
        background: #111;
        border-top: 1px solid var(--border);
        font-size: 10px;
        color: var(--muted);
        display: flex;
        justify-content: space-between;
        flex-shrink: 0;
      }
      .fit-indicator {
        font-weight: 700;
      }
      .fit-ok {
        color: var(--success);
      }
      .fit-warn {
        color: #f59e0b;
      }
      .fit-over {
        color: var(--danger);
      }

      /* â•â•â• EDITOR SECTIONS â•â•â• */
      .editor-content {
        flex: 1;
        overflow-y: auto;
        padding: 12px;
      }
      .section-block {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 8px;
        margin-bottom: 8px;
        overflow: hidden;
      }
      .section-header {
        padding: 8px 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        user-select: none;
        background: #222;
        border-bottom: 1px solid var(--border);
      }
      .section-header:hover {
        background: #282828;
      }
      .section-title {
        flex: 1;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .section-actions {
        display: flex;
        gap: 4px;
      }
      .section-body {
        padding: 8px 12px;
      }
      .section-body.collapsed {
        display: none;
      }
      .chevron {
        transition: transform 0.2s;
        font-size: 10px;
        color: var(--muted);
      }
      .chevron.open {
        transform: rotate(90deg);
      }

      /* â•â•â• JOB BLOCKS â•â•â• */
      .job-block {
        background: #1e1e1e;
        border: 1px solid var(--border);
        border-radius: 6px;
        margin-bottom: 6px;
        padding: 8px 10px;
      }
      .job-header {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 6px;
      }
      .job-header input {
        flex: 1;
        background: transparent;
        border: 1px solid transparent;
        color: var(--text);
        font-size: 11px;
        padding: 4px 6px;
        border-radius: 4px;
        font-family: inherit;
      }
      .job-header input:focus {
        border-color: var(--accent);
        outline: none;
        background: #111;
      }
      .job-header input.company {
        font-weight: 700;
      }
      .job-header input.role {
        font-style: italic;
        color: var(--muted);
      }

      /* â•â•â• BULLET ITEMS â•â•â• */
      .bullet-list {
        list-style: none;
      }
      .bullet-item {
        display: flex;
        align-items: flex-start;
        gap: 6px;
        padding: 3px 0;
        border-radius: 4px;
        position: relative;
      }
      .bullet-item:hover {
        background: rgba(255, 255, 255, 0.03);
      }
      .bullet-drag {
        cursor: grab;
        color: var(--muted);
        font-size: 10px;
        padding: 4px 2px;
        flex-shrink: 0;
        user-select: none;
      }
      .bullet-drag:active {
        cursor: grabbing;
      }
      .bullet-text {
        flex: 1;
        background: transparent;
        border: 1px solid transparent;
        color: var(--text);
        font-size: 11px;
        padding: 3px 5px;
        border-radius: 4px;
        font-family: inherit;
        resize: vertical;
        min-height: 22px;
        line-height: 1.4;
      }
      .bullet-text:focus {
        border-color: var(--accent);
        outline: none;
        background: #111;
      }
      .bullet-actions {
        display: flex;
        gap: 2px;
        opacity: 0;
        transition: opacity 0.15s;
        flex-shrink: 0;
      }
      .bullet-item:hover .bullet-actions {
        opacity: 1;
      }
      .icon-btn {
        background: none;
        border: none;
        color: var(--muted);
        cursor: pointer;
        font-size: 12px;
        padding: 2px 4px;
        border-radius: 3px;
        transition: all 0.1s;
      }
      .icon-btn:hover {
        color: var(--text);
        background: #333;
      }
      .icon-btn.delete:hover {
        color: var(--danger);
      }
      .icon-btn.eye {
        opacity: 0.7;
      }
      .icon-btn.eye.hidden-item {
        opacity: 0.3;
      }
      .item-hidden {
        opacity: 0.35;
        text-decoration: line-through;
      }
      .item-hidden input,
      .item-hidden textarea {
        text-decoration: line-through;
        color: var(--muted) !important;
      }
      .section-block.item-hidden > .section-header {
        opacity: 0.4;
      }
      .section-block.item-hidden > .section-header .section-title {
        text-decoration: line-through;
      }
      .job-block.item-hidden {
        opacity: 0.35;
        border-style: dashed;
      }

      /* â•â•â• SIMPLE FIELDS â•â•â• */
      .field-row {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 4px;
      }
      .field-label {
        font-size: 10px;
        color: var(--muted);
        font-weight: 600;
        min-width: 60px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
      }
      .field-input {
        flex: 1;
        background: transparent;
        border: 1px solid transparent;
        color: var(--text);
        font-size: 11px;
        padding: 4px 6px;
        border-radius: 4px;
        font-family: inherit;
      }
      .field-input:focus {
        border-color: var(--accent);
        outline: none;
        background: #111;
      }
      textarea.field-input {
        resize: vertical;
        min-height: 40px;
        line-height: 1.4;
        width: 100%;
        display: block;
      }

      /* â•â•â• LEADERSHIP ITEMS â•â•â• */
      .leadership-item {
        display: flex;
        align-items: flex-start;
        gap: 6px;
        margin-bottom: 4px;
      }
      .leadership-item input {
        background: transparent;
        border: 1px solid transparent;
        color: var(--text);
        font-size: 11px;
        padding: 3px 5px;
        border-radius: 4px;
        font-family: inherit;
      }
      .leadership-item input:focus {
        border-color: var(--accent);
        outline: none;
        background: #111;
      }
      .leadership-item .name {
        width: 160px;
        font-weight: 700;
      }
      .leadership-item .desc {
        flex: 1;
      }

      /* â•â•â• SKILLS â•â•â• */
      .skill-row {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 4px;
      }
      .skill-row input.skill-label {
        width: 120px;
        background: transparent;
        border: 1px solid transparent;
        color: var(--text);
        font-size: 11px;
        padding: 3px 5px;
        border-radius: 4px;
        font-family: inherit;
        font-weight: 700;
      }
      .skill-row input.skill-value {
        flex: 1;
        background: transparent;
        border: 1px solid transparent;
        color: var(--text);
        font-size: 11px;
        padding: 3px 5px;
        border-radius: 4px;
        font-family: inherit;
      }
      .skill-row input:focus {
        border-color: var(--accent);
        outline: none;
        background: #111;
      }

      /* â•â•â• PREVIEW / PAPER â•â•â• */
      .preview-toolbar {
        padding: 8px 16px;
        display: flex;
        gap: 10px;
        align-items: center;
        width: 100%;
        max-width: 820px;
        margin-bottom: 10px;
      }
      .preview-toolbar .zoom-label {
        font-size: 11px;
        color: var(--muted);
      }
      .zoom-slider {
        width: 100px;
        accent-color: var(--accent);
      }

      .paper-wrapper {
        position: relative;
        flex-shrink: 0;
      }
      .paper {
        width: 210mm;
        height: 297mm;
        background: #fff;
        color: #000;
        padding: 10mm 14mm;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        font-size: 9pt;
        line-height: 1.35;
        overflow: hidden;
        transform-origin: top center;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        position: relative;
      }
      /* â•â•â• Semantic HTML resets (ATS-friendly) â•â•â• */
      .paper h1,
      .paper h2,
      .paper h3,
      .paper p,
      .paper ul,
      .paper li {
        margin: 0;
        padding: 0;
        border: 0;
        font-size: inherit;
        font-weight: inherit;
        font-style: inherit;
        color: inherit;
        line-height: inherit;
        list-style: none;
      }
      .paper .cv-name {
        text-align: center;
        font-size: 15pt;
        font-weight: 700;
        margin-bottom: 2px;
      }
      .paper .cv-contact {
        text-align: center;
        font-size: 7.5pt;
        color: #555;
        margin-bottom: 6px;
      }
      .paper .cv-section-title {
        font-size: 9.5pt;
        font-weight: 700;
        border-bottom: 1px solid #000;
        padding-bottom: 1px;
        margin-top: 5px;
        margin-bottom: 3px;
        text-transform: uppercase;
      }
      .paper .cv-summary {
        font-size: 7.5pt;
        margin-bottom: 4px;
        line-height: 1.4;
      }
      .paper .cv-company {
        font-size: 8.5pt;
        font-weight: 700;
        margin-top: 3px;
        position: relative;
      }
      .paper .cv-location {
        position: absolute;
        right: 0;
        font-weight: 400;
        font-size: 7.5pt;
        color: #555;
      }
      .paper .cv-role {
        font-size: 8pt;
        font-style: italic;
        color: #333;
        margin-bottom: 1px;
        position: relative;
      }
      .paper .cv-dates {
        position: absolute;
        right: 0;
        font-style: normal;
        font-size: 7.5pt;
        color: #555;
      }
      .paper .cv-bullet {
        font-size: 7.5pt;
        padding-left: 10px;
        text-indent: -8px;
        margin-left: 8px;
        margin-bottom: 0.5px;
        line-height: 1.35;
      }
      .paper .cv-leadership {
        font-size: 7.5pt;
        margin-top: 3px;
        margin-bottom: 1px;
        line-height: 1.35;
      }
      .paper .cv-leadership strong {
        font-weight: 700;
      }
      .paper .cv-skill {
        font-size: 7.5pt;
        margin-bottom: 1px;
        line-height: 1.35;
      }
      .paper .cv-skill strong {
        font-weight: 700;
      }
      .paper .cv-edu-detail {
        font-size: 7.5pt;
        padding-left: 10px;
        text-indent: -8px;
        margin-left: 8px;
        margin-bottom: 0.5px;
        line-height: 1.35;
      }

      /* Page overflow indicator */
      .overflow-line {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--danger);
        z-index: 10;
        display: none;
      }

      /* â•â•â• ADD BUTTONS â•â•â• */
      .add-row {
        display: flex;
        justify-content: center;
        padding: 4px 0;
      }
      .add-btn {
        background: none;
        border: 1px dashed var(--border);
        color: var(--muted);
        font-size: 11px;
        padding: 4px 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s;
        font-family: inherit;
      }
      .add-btn:hover {
        border-color: var(--accent);
        color: var(--accent);
        background: rgba(59, 130, 246, 0.05);
      }

      /* â•â•â• DRAG AND DROP â•â•â• */
      .dragging {
        opacity: 0.4;
      }
      .drag-over {
        border-top: 2px solid var(--accent) !important;
      }

      /* â•â•â• STYLE PANEL â•â•â• */
      .style-panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 8px;
        margin: 0 16px 10px;
        max-width: 820px;
        width: calc(100% - 32px);
      }
      .style-panel.collapsed .style-body {
        display: none;
      }
      .style-toggle {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        cursor: pointer;
        font-size: 11px;
        color: var(--muted);
        user-select: none;
      }
      .style-toggle:hover {
        color: var(--text);
      }
      .style-toggle .chevron {
        font-size: 8px;
        transition: transform 0.2s;
      }
      .style-panel:not(.collapsed) .style-toggle .chevron {
        transform: rotate(90deg);
      }
      .style-body {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px 16px;
        padding: 6px 12px 10px;
      }
      @media (max-width: 600px) {
        .style-body {
          grid-template-columns: 1fr;
        }
      }
      .style-row {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .style-row label {
        font-size: 10px;
        color: var(--muted);
        min-width: 75px;
        white-space: nowrap;
      }
      .style-row select,
      .style-row input[type="range"] {
        flex: 1;
        min-width: 0;
      }
      .style-row select {
        background: #222;
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 2px 4px;
        font-size: 10px;
        font-family: inherit;
      }
      .style-row input[type="range"] {
        height: 14px;
        accent-color: var(--accent);
      }
      .style-row .style-val {
        font-size: 9px;
        color: var(--accent);
        min-width: 32px;
        text-align: right;
        font-weight: 600;
      }
      .style-row .auto-btn {
        background: none;
        border: 1px solid var(--border);
        color: var(--muted);
        font-size: 8px;
        padding: 1px 4px;
        border-radius: 3px;
        cursor: pointer;
        font-family: inherit;
        white-space: nowrap;
      }
      .style-row .auto-btn:hover {
        border-color: var(--accent);
        color: var(--accent);
      }
      .style-row .auto-btn.active {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
      }

      /* â•â•â• MARGIN GUIDES â•â•â• */
      .margin-guide {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        z-index: 5;
        display: none;
      }
      .margin-guide.visible {
        display: block;
      }
      .margin-guide-inner {
        position: absolute;
        border: 1px dashed rgba(59, 130, 246, 0.25);
        border-radius: 1px;
      }

      /* â•â•â• PRINT BORDER GUIDE â•â•â• */
      .print-border {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        z-index: 6;
        display: none;
        border: 2px solid rgba(239, 68, 68, 0.4);
        border-radius: 2px;
      }
      .print-border.visible {
        display: block;
      }

      /* â•â•â• PRINT â•â•â• */
      @page {
        size: A4;
        margin: 0;
      }
      @media print {
        * {
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }
        html,
        body {
          margin: 0 !important;
          padding: 0 !important;
          background: #fff !important;
          width: 210mm !important;
          height: 297mm !important;
          overflow: hidden !important;
        }
        .app {
          display: block !important;
          background: #fff !important;
        }
        .editor-panel,
        .preview-toolbar,
        .style-panel,
        .status-bar,
        .toolbar,
        .overflow-line,
        .margin-guide,
        .print-border {
          display: none !important;
        }
        .preview-panel {
          padding: 0 !important;
          background: #fff !important;
          overflow: visible !important;
          display: block !important;
          width: 210mm !important;
          height: 297mm !important;
        }
        .paper-wrapper {
          position: static !important;
          width: 210mm !important;
          height: 297mm !important;
        }
        .paper {
          box-shadow: none !important;
          transform: none !important;
          margin: 0 !important;
          width: 210mm !important;
          height: 297mm !important;
          overflow: hidden !important;
          position: static !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <!-- â•â•â• FAR LEFT: AI CHAT â•â•â• -->
      <div class="chat-panel" id="chat-panel">
        <div class="chat-header">
          <h2>ğŸ¤– <span>AI</span> ASSISTANT</h2>
          <button
            class="btn btn-sm btn-secondary"
            onclick="toggleChatPanel()"
            title="Hide chat"
          >
            âœ•
          </button>
        </div>
        <div class="chat-config" id="chat-config">
          <label>AI Provider</label>
          <select id="ai-provider" onchange="onProviderChange()">
            <option value="ollama" selected>
              ğŸ  Local / Ollama â€” Free, No API Key
            </option>
            <option value="groq">Groq â€” Free (Llama 3.3 70B)</option>
            <option value="openrouter">
              OpenRouter â€” Free (Llama 3.3 / Gemini / Qwen)
            </option>
            <option value="cerebras">
              Cerebras â€” Free (Llama 3.3 70B, ultra-fast)
            </option>
            <option value="gemini">
              Google Gemini â€” Free tier (2.5 Flash)
            </option>
            <option value="openai">OpenAI (GPT-4o)</option>
            <option value="claude">Anthropic Claude (Sonnet 4)</option>
          </select>
          <div id="ollama-model-row" style="margin-top: 6px">
            <label style="font-size: 11px">Ollama Model</label>
            <div style="display: flex; gap: 4px; align-items: center">
              <select
                id="ollama-model-select"
                style="
                  flex: 1;
                  font-size: 11px;
                  padding: 4px 6px;
                  background: var(--surface);
                  color: var(--text);
                  border: 1px solid var(--border);
                  border-radius: 4px;
                "
              >
                <option value="">Click "Detect Models" â†’</option>
              </select>
              <button
                class="btn btn-sm"
                onclick="detectOllamaModels()"
                style="font-size: 10px; padding: 2px 8px; white-space: nowrap"
              >
                ğŸ” Detect
              </button>
            </div>
            <div
              id="ollama-status"
              style="font-size: 9px; color: var(--muted); margin-top: 3px"
            >
              Install Ollama: <code>brew install ollama</code> then
              <code>ollama pull qwen2.5:32b</code>
            </div>
          </div>
          <div id="api-key-row">
            <label>API Key</label>
            <input
              type="password"
              id="ai-api-key"
              placeholder="Paste your API key..."
            />
          </div>
          <div class="connect-row">
            <button class="btn btn-sm btn-primary" onclick="connectAI()">
              Connect
            </button>
            <span class="connect-status disconnected" id="ai-status"
              >â— Not connected</span
            >
          </div>
          <div
            style="
              margin-top: 8px;
              display: flex;
              align-items: center;
              gap: 8px;
            "
          >
            <label
              style="
                display: inline-flex;
                align-items: center;
                gap: 5px;
                cursor: pointer;
                font-size: 11px;
                color: var(--text);
                margin: 0;
              "
            >
              <input
                type="checkbox"
                id="ai-premium-thinking"
                onchange="onThinkingToggle()"
                style="accent-color: #f59e0b; cursor: pointer"
              />
              ğŸ§  Premium Thinking
            </label>
            <span
              id="thinking-label"
              style="font-size: 9px; color: var(--muted)"
              >Off â€” faster responses</span
            >
          </div>
        </div>
        <div class="chat-messages" id="chat-messages">
          <div class="chat-msg system">
            Connect an AI provider above to start
          </div>
        </div>
        <div class="chat-input-area">
          <div class="chat-attachments" id="chat-attachments"></div>
          <div class="chat-input-row">
            <button
              class="chat-attach-btn"
              onclick="document.getElementById('chat-file-input').click()"
              title="Attach document"
            >
              ğŸ“
            </button>
            <input
              type="file"
              id="chat-file-input"
              accept=".txt,.md,.pdf,.doc,.docx,.json,.csv"
              style="display: none"
              onchange="handleAttachment(this)"
              multiple
            />
            <textarea
              id="chat-input"
              placeholder="Ask the AI to tailor your CV..."
              rows="1"
              onkeydown="
                if (event.key === 'Enter' && !event.shiftKey) {
                  event.preventDefault();
                  sendMessage();
                }
              "
              oninput="autoGrow(this)"
            ></textarea>
            <button
              class="send-btn"
              id="chat-send-btn"
              onclick="sendMessage()"
              disabled
            >
              â–¶
            </button>
          </div>
        </div>
        <details class="chat-instructions">
          <summary>â„¹ï¸ How to get started</summary>
          <div class="inst-body">
            <h4>ğŸ 
            Run AI models locally on your Mac. Zero cost, full privacy.<br />
            1. Install: <code>brew install ollama</code><br />
            2. Start: <code>ollama serve</code><br />
            3. Pull a model: <code>ollama pull qwen2.5:32b</code><br />
            4. Click "Detect" above â†’ select model â†’ Connect<br />
            Recommended: <strong>qwen2.5:32b</strong> (32GB Mac) or <strong>deepseek-r1:32b</strong> ğŸ§ <br />
            <h4>ğŸŸ¢ Groq (Free â€” Recommended Cloud)</h4>
            Completely free, no credit card ne            Completely free, no credit card ne            Completely
            2. Sign up /             2. Sign up /          />
            3. Copy and paste above. Uses <strong>Llama 3.3 70B</strong>.<br />
            <h4>ğŸŒ OpenRouter (Free models            <h4>ğŸŒ OpenRouter (Frlable, no credit card needed.<br />
            1. Go to <code>openrouter.ai/keys</code><br />
            2. Sign up â†’ Create Key â†’ Copy and paste above<br />
            3. Auto-uses free <strong>Llama 3.3 70B</strong>.<br />
            <h4>âš¡ Cerebras (Free, ultra-fast)</h4>
            Free tier, extremely fast inference (2000+ tok/s).<br />
            1. Go to <code>cloud.cerebras.ai</code><br />
            2. Sign up â†’ API Keys â†’ Create â†’ paste above<br />
            3. Uses <strong>Llama 3.3 70B</strong>.<br />
            <h4>ğŸ”´ Google Gemini (Free tier)</h4>
            1. Go to <code>aistudio.google.com/apikey</code><br />
            2. Create API key â†’ Copy and paste above<br />
            3. Free tier: 15 RPM. Uses Gemini 2.5 Flash.<br />
            <h4>ğŸ”µ OpenAI (GPT-4o)</h4>
            1. Go to <code>platform.openai.com/api-keys</code><br />
            2. Create a new key â†’ Copy and paste above<br />
            3. Requires billing setup. ~$0.005/message.<br />
            <h4>ğŸŸ£ Anthropic (Claude Sonnet 4)</h4>
            1. Go to <code>console.anthropic.com</code><br />
            2. Settings â†’ API Keys â†’ Create Key<b            2. Settings â†’ API Keng setup. ~$0.003/message.
                                 s>
      </div>
      <button
        class="toggle-chat-btn"
        id="toggle-chat-btn"
        onclick="toggleChatPanel()"
      >
        ğŸ’¬ AI Chat
      </button>

      <!-- â•â•â• CENTER: EDITOR â•â•â• -->
      <div class="editor-panel">
        <div class="toolbar">
          <h1><span>CV</span> EDITOR</h1>
          <select
            id="profile-select"
            onchange="loadProfile(this.value)"
            style="
              background: #333;
              color: #e0e0e0;
              border: 1px solid #444;
              border-radius: 4px;
              padding: 3px 6px;
              font-size: 10px;
              font-family: inherit;
              max-width: 130px;
            "
          ></select>
          <button
            class="btn btn-primary btn-sm"
            onclick="saveCurrentProfile()"
            title="Save current profile (âŒ˜S)"
          >
            ğŸ’¾
          </button>
          <button
            class="btn btn-secondary btn-sm"
            onclick="saveAsProfile()"
            title="Save as new tag"
          >
            Save Asâ€¦
          </button>
          <button
            class="btn btn-secondary btn-sm"
            onclick="deleteProfile()"
            title="Delete selected profile"
          >
            ğŸ—‘
          </button>
          <span
            id="profile-indicator"
            style="
              font-size: 10px;
              color: #3b82f6;
              font-weight: 600;
              max-width: 120px;
              overflow: hidden;
              text-overflow: ellipsis;
              white-space: nowrap;
            "
          ></span>
          <button class="btn btn-primary btn-sm" onclick="exportPDF()">
            ğŸ“„ PDF
          </button>
          <button
            class="btn btn-secondary btn-sm"
            onclick="exportProfiles()"
            title="Export all profiles as JSON"
          >
            â¬‡ Backup
          </button>
          <button
            class="btn btn-secondary btn-sm"
            onclick="importProfiles()"
            title="Import profiles from JSON"
          >
            â¬† Restore
          </button>
          <button class="btn btn-secondary btn-sm" onclick="addSection()">
            +
          </button>
          <button class="btn btn-secondary btn-sm" onclick="resetToDefault()">
            Reset
          </button>
        </div>
        <div class="editor-content" id="editor"></div>
        <div class="status-bar">
          <span id="fit-status" class="fit-indicator fit-ok"
            >âœ“ Fits on 1 page</span
          >
          <span id="scale-info">Scale: 100%</span>
        </div>
      </div>

      <!-- â•â•â• RIGHT: PREVIEW â•â•â• -->
      <div class="preview-panel">
        <div class="preview-toolbar">
          <span class="zoom-label">Zoom:</span>
          <input
            type="range"
            class="zoom-slider"
            min="20"
            max="200"
            value="100"
            oninput="setZoom(this.value)"
          />
          <span class="zoom-label" id="zoom-val">65%</span>
        </div>

        <!-- â•â•â• STYLE CONTROLS â•â•â• -->
        <div class="style-panel collapsed" id="style-panel">
          <div class="style-toggle" onclick="toggleStylePanel()">
            <span class="chevron">â–¶</span>
            <span>âš™ Typography &amp; Layout</span>
          </div>
          <div class="style-body">
            <!-- Row 1: Body Font -->
            <div class="style-row">
              <label>Body Font</label>
              <select
                id="style-body-font"
                onchange="setStyleFont('bodyFont', this.value)"
              >
                <option value="'Helvetica Neue', Helvetica, Arial, sans-serif">
                  Helvetica Neue
                </option>
                <option value="'Times New Roman', Times, serif">
                  Times New Roman
                </option>
                <option value="Garamond, 'EB Garamond', serif">Garamond</option>
                <option value="Calibri, 'Gill Sans', sans-serif">
                  Calibri
                </option>
                <option value="Georgia, serif">Georgia</option>
                <option value="Cambria, serif">Cambria</option>
                <option value="Arial, sans-serif">Arial</option>
                <option value="'Palatino Linotype', Palatino, serif">
                  Palatino
                </option>
              </select>
            </div>
            <!-- Row 2: Title Font -->
            <div class="style-row">
              <label>Title Font</label>
              <select
                id="style-title-font"
                onchange="setStyleFont('titleFont', this.value)"
              >
                <option value="'Helvetica Neue', Helvetica, Arial, sans-serif">
                  Helvetica Neue
                </option>
                <option value="'Times New Roman', Times, serif">
                  Times New Roman
                </option>
                <option value="Garamond, 'EB Garamond', serif">Garamond</option>
                <option value="Calibri, 'Gill Sans', sans-serif">
                  Calibri
                </option>
                <option value="Georgia, serif">Georgia</option>
                <option value="Cambria, serif">Cambria</option>
                <option value="Arial, sans-serif">Arial</option>
                <option value="'Palatino Linotype', Palatino, serif">
                  Palatino
                </option>
              </select>
            </div>
            <!-- Row 3: Letter Spacing -->
            <div class="style-row">
              <label>Letter Sp.</label>
              <input
                type="range"
                min="-50"
                max="100"
                value="0"
                step="5"
                id="style-letter-spacing"
                oninput="setStyleVal('letterSpacing', this.value / 100)"
              />
              <span class="style-val" id="style-letter-spacing-val">0px</span>
            </div>
            <!-- Row 3b: Body Font Size -->
            <div class="style-row">
              <label>Body Size</label>
              <input
                type="range"
                min="60"
                max="100"
                value="75"
                step="1"
                id="style-font-size"
                oninput="setStyleVal('bodySize', this.value / 10)"
              />
              <span class="style-val" id="style-font-size-val">auto</span>
              <button
                class="auto-btn active"
                id="btn-auto-fontsize"
                onclick="toggleAuto('bodySize')"
              >
                A
              </button>
            </div>
            <!-- Row 3c: Title Font Size -->
            <div class="style-row">
              <label>Title Size</label>
              <input
                type="range"
                min="70"
                max="130"
                value="95"
                step="1"
                id="style-title-size"
                oninput="setStyleVal('titleSize', this.value / 10)"
              />
              <span class="style-val" id="style-title-size-val">auto</span>
              <button
                class="auto-btn active"
                id="btn-auto-titlesize"
                onclick="toggleAuto('titleSize')"
              >
                A
              </button>
            </div>
            <!-- Row 4: Paragraph Spacing -->
            <div class="style-row">
              <label>Para. Gap</label>
              <input
                type="range"
                min="0"
                max="30"
                value="5"
                step="1"
                id="style-para-gap"
                oninput="setStyleVal('bulletGap', this.value / 10)"
              />
              <span class="style-val" id="style-para-gap-val">auto</span>
              <button
                class="auto-btn active"
                id="btn-auto-para"
                onclick="toggleAuto('bulletGap')"
              >
                A
              </button>
            </div>
            <!-- Row 5: Section Spacing -->
            <div class="style-row">
              <label>Section Gap</label>
              <input
                type="range"
                min="20"
                max="160"
                value="50"
                step="5"
                id="style-section-gap"
                oninput="setStyleVal('sectionGap', this.value / 10)"
              />
              <span class="style-val" id="style-section-gap-val">auto</span>
              <button
                class="auto-btn active"
                id="btn-auto-section"
                onclick="toggleAuto('sectionGap')"
              >
                A
              </button>
            </div>
            <!-- Row 6: Margins -->
            <div class="style-row">
              <label>Margins</label>
              <input
                type="range"
                min="50"
                max="200"
                value="100"
                step="5"
                id="style-margins"
                oninput="setStyleVal('margins', this.value / 10)"
              />
              <span class="style-val" id="style-margins-val">auto</span>
              <button
                class="auto-btn active"
                id="btn-auto-margins"
                onclick="toggleAuto('margins')"
              >
                A
              </button>
            </div>
            <!-- Row 7: Line Height -->
            <div class="style-row">
              <label>Line Height</label>
              <input
                type="range"
                min="110"
                max="180"
                value="135"
                step="5"
                id="style-line-height"
                oninput="setStyleVal('lineHeight', this.value / 100)"
              />
              <span class="style-val" id="style-line-height-val">auto</span>
              <button
                class="auto-btn active"
                id="btn-auto-lineheight"
                onclick="toggleAuto('lineHeight')"
              >
                A
              </button>
            </div>
            <!-- Row 8: Visual guides -->
            <div class="style-row" style="gap: 10px">
              <label style="min-width: auto">Guides</label>
              <label
                style="
                  font-size: 9px;
                  display: flex;
                  align-items: center;
                  gap: 3px;
                  cursor: pointer;
                  min-width: auto;
                "
              >
                <input
                  type="checkbox"
                  id="chk-margins"
                  onchange="toggleGuides('margins')"
                  style="margin: 0"
                />
                Margins
              </label>
              <label
                style="
                  font-size: 9px;
                  display: flex;
                  align-items: center;
                  gap: 3px;
                  cursor: pointer;
                  min-width: auto;
                "
              >
                <input
                  type="checkbox"
                  id="chk-printborder"
                  onchange="toggleGuides('printborder')"
                  style="margin: 0"
                />
                Print Border
              </label>
            </div>
          </div>
        </div>

        <div class="paper-wrapper">
          <div class="paper" id="paper">
            <!-- Rendered CV goes here -->
            <div class="print-border" id="print-border"></div>
          </div>
          <div class="overflow-line" id="overflow-line"></div>
          <div class="margin-guide" id="margin-guide">
            <div class="margin-guide-inner" id="margin-guide-inner"></div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.3/jspdf.umd.min.js"></script>
    <script>
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // CV DATA MODEL
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const DEFAULT_CV = {
        name: "TomÃ¡s Maria Burnay Batalha",
        contact:
          "Lisbon, Portugal (Open to Relocation to Dublin) | (+351) 936 124 118 | tomas.b.batalha@gmail.com | linkedin.com/in/tomasmbatalha",
        sections: [
          {
            id: "summary",
            type: "summary",
            title: "PROFESSIONAL SUMMARY",
            content:
              "Former Google intern and startup Co-Founder with full-cycle new business sales experience. Built a â‚¬147K B2B pipeline from zero via multi-channel outreach, consultative selling, and enterprise deal closing. Managed a 2,311-account territory at Amazon, outperforming full-time colleagues. Seeking to bring builder mentality and commercial execution to Google's New Business Sales team.",
          },
          {
            id: "experience",
            type: "jobs",
            title: "WORK EXPERIENCE",
            jobs: [
              {
                company: "Pairwire | New York, USA (Remote)",
                role: "Co-Founder and Head of Sales | February 2024 â€“ December 2025",
                bullets: [
                  "Built â‚¬147K pipeline of contracted enterprise pilots from zero in 11 months pre-funding through outbound prospecting, cold calling, consulting, and relationship management",
                  "Closed 23 enterprise engagements including Fortune 500 and Big 4 firms across 6-9 month full-cycle sales processes",
                  "Engineered an AI-powered outbound engine processing 7,000+ leads, automating 80% of prospecting via custom tech stack (Python, Expand.io, AI-enhanced workflows)",
                  "Led end-to-end deal management from first touch to contract close, managing entire funnel with no sales team or brand recognition",
                  "Created partnership and investor pitch materials; led negotiations with Google, Web Summit, and enterprise decision-makers",
                ],
              },
              {
                company: "Google, Large Customer Sales | Lisbon, Portugal",
                role: "Business Analyst Intern | May 2024 â€“ August 2024",
                bullets: [
                  'Led the "Future Trends" segment at Google\'s flagship partner event, presenting personally researched insights on Peak Season activation and media readiness to 237+ senior advertising clients',
                  "Designed and automated three globally scalable dashboards using Apps Script and GMP tools to analyze ROAS vs. profit and CPA vs. conversions, projecting $1.41M in annual savings for media spend decisions",
                  "Built a reporting platform for Partner Managers using Looker Studio, Analytics 360, and Apps Script, delivering an estimated â‚¬315K in annual efficiency gains",
                ],
              },
              {
                company: "Amazon, Amazon Business | Madrid, Spain",
                role: "Business Development Intern | May 2022 â€“ November 2022",
                bullets: [
                  "Led the B2B retail expansion into Portugal, managing a portfolio of 2,311 companies through prospecting, outreach, and account activation",
                  "Outperformed KPI benchmarks by 21x in company account configurations during the Portugal B2B rollout",
                  "Raised territory share from 56% below to 25% above team average, outperforming full-time colleagues in the region",
                  "Compiled a 19-page strategic report on B2B eCommerce based on 8 company territories and 54 targeted client interviews",
                ],
              },
              {
                company: "Ernst & Young, Financial Services | Lisbon, Portugal",
                role: "Assurance Associate | February 2022 â€“ April 2022",
                bullets: [
                  "Audited asset portfolios worth â‚¬41.3 billion across 3 insurance firms, developing rigorous data verification and attention to detail",
                ],
              },
            ],
          },
          {
            id: "education",
            type: "education",
            title: "EDUCATION",
            schools: [
              {
                institution:
                  "Rotterdam School of Management | Rotterdam, Netherlands",
                degree: "MSc in Strategic Management | GPA: 8/10",
                details: [
                  "Relevant Courses: Applied Machine Learning to Strategy (9.3/10), Python Fundamentals (8.3/10)",
                ],
              },
              {
                institution: "National University of Singapore | Singapore",
                degree:
                  "Exchange Semester | MBA-aligned coursework in Strategy and Innovation",
                details: [
                  "Built a commercial and financial plan for a NUS PhD venture: 70% energy savings, 45% unit margins, 278% ROI in a $1.5B market",
                ],
              },
              {
                institution:
                  "Nova School of Business and Economics | Lisbon, Portugal",
                degree: "BSc in Management | GPA: 16/20",
                details: [
                  "Statistics (20/20), Procurement Management (19/20), Economics of the European Union (19/20)",
                ],
              },
            ],
          },
          {
            id: "leadership",
            type: "leadership",
            title: "LEADERSHIP & ACTIVITIES",
            items: [
              {
                name: "Nova Thirst Project",
                desc: "Founder & President: Led 23 volunteers, raised â‚¬2,539 for water access, organized 4 events including one with 35 NGOs (2020-2021)",
              },
              {
                name: "Nova Tech Club",
                desc: "Digital Transformation Consultant: Developed a job platform prototype and organized corporate events and workshops (2020-2021)",
              },
              {
                name: "Nova Social Consulting (WWF)",
                desc: "Pro Bono Consultant: Assessed organizational structure, identified 155 improvement areas, delivered 6 presentations to senior management (2020-2021)",
              },
            ],
          },
          {
            id: "skills",
            type: "skills",
            title: "SKILLS",
            skills: [
              {
                label: "Sales & Marketing:",
                value:
                  "Google Ads, YouTube Ads, Google Display Network, CRM (Salesforce), LinkedIn Sales Navigator, Apollo, Full-Cycle Sales, Pipeline Management, Cold Outreach, Consultative Selling",
              },
              {
                label: "Technical:",
                value:
                  "Python, Apps Script, Visual Basic for Applications (VBA), SQL, Looker Studio, Power BI, DAX",
              },
              {
                label: "Certifications:",
                value:
                  "Google Ads Certified, Bloomberg Market Concepts, Microsoft Excel Specialist, TOEFL iBT",
              },
              {
                label: "Languages:",
                value:
                  "Portuguese (Native), English (Fluent), Spanish (Fluent), French (Beginner)",
              },
            ],
          },
        ],
      };
      let cv = JSON.parse(JSON.stringify(DEFAULT_CV));
      let zoomLevel = 65;
      let debounceTimer = null;
      let resizeTimer = null;
      let lastAutoFitState = null;

      // â•â•â• BUILT-IN CV PROFILES (seeded on first visit) â•â•â•
      const GOOGLE_AE_CV = {
        name: "TomÃ¡s Maria Burnay Batalha",
        contact:
          "Lisbon, Portugal (Open to Relocation to Dublin) | (+351) 936 124 118 | tomas.b.batalha@gmail.com | linkedin.com/in/tomasmbatalha",
        sections: [
          {
            id: "summary",
            type: "summary",
            title: "PROFESSIONAL SUMMARY",
            content:
              "Former Google intern and startup Co-Founder with full-cycle new business sales experience. Built a â‚¬147K B2B pipeline from zero via multi-channel outreach, consultative selling, and enterprise deal closing. Managed a 2,311-account territory at Amazon, outperforming full-time colleagues. Seeking to bring builder mentality and commercial execution to Google's New Business Sales team.",
          },
          {
            id: "experience",
            type: "jobs",
            title: "WORK EXPERIENCE",
            jobs: [
              {
                company: "Pairwire | New York, USA (Remote)",
                role: "Co-Founder and Head of Sales | February 2024 â€“ December 2025",
                bullets: [
                  "Built â‚¬147K pipeline of contracted enterprise pilots from zero in 11 months pre-funding through outbound prospecting, cold calling, consulting, and relationship management",
                  "Closed 23 enterprise engagements including Fortune 500 and Big 4 firms across 6-9 month full-cycle sales processes",
                  "Engineered an AI-powered outbound engine processing 7,000+ leads, automating 80% of prospecting via custom tech stack (Python, Expand.io, AI-enhanced workflows)",
                  "Led end-to-end deal management from first touch to contract close, managing entire funnel with no sales team or brand recognition",
                  "Created partnership and investor pitch materials; led negotiations with Google, Web Summit, and enterprise decision-makers",
                ],
              },
              {
                company: "Google, Large Customer Sales | Lisbon, Portugal",
                role: "Business Analyst Intern | May 2024 â€“ August 2024",
                bullets: [
                  'Led the "Future Trends" segment at Google\'s flagship partner event, presenting personally researched insights on Peak Season activation and media readiness to 237+ senior advertising clients',
                  "Designed and automated three globally scalable dashboards using Apps Script and GMP tools to analyze ROAS vs. profit and CPA vs. conversions, projecting $1.41M in annual savings for media spend decisions",
                  "Built a reporting platform for Partner Managers using Looker Studio, Analytics 360, and Apps Script, delivering an estimated â‚¬315K in annual efficiency gains",
                ],
              },
              {
                company: "Amazon, Amazon Business | Madrid, Spain",
                role: "Business Development Intern | May 2022 â€“ November 2022",
                bullets: [
                  "Led the B2B retail expansion into Portugal, managing a portfolio of 2,311 companies through prospecting, outreach, and account activation",
                  "Outperformed KPI benchmarks by 21x in company account configurations during the Portugal B2B rollout",
                  "Raised territory share from 56% below to 25% above team average, outperforming full-time colleagues in the region",
                  "Compiled a 19-page strategic report on B2B eCommerce based on 8 company territories and 54 targeted client interviews",
                ],
              },
              {
                company: "Ernst & Young, Financial Services | Lisbon, Portugal",
                role: "Assurance Associate | February 2022 â€“ April 2022",
                bullets: [
                  "Audited asset portfolios worth â‚¬41.3 billion across 3 insurance firms, developing rigorous data verification and attention to detail",
                ],
              },
            ],
          },
          {
            id: "education",
            type: "education",
            title: "EDUCATION",
            schools: [
              {
                institution:
                  "Rotterdam School of Management | Rotterdam, Netherlands",
                degree: "MSc in Strategic Management | GPA: 8/10",
                details: [
                  "Relevant Courses: Applied Machine Learning to Strategy (9.3/10), Python Fundamentals (8.3/10)",
                ],
              },
              {
                institution: "National University of Singapore | Singapore",
                degree:
                  "Exchange Semester | MBA-aligned coursework in Strategy and Innovation",
                details: [
                  "Built a commercial and financial plan for a NUS PhD venture: 70% energy savings, 45% unit margins, 278% ROI in a $1.5B market",
                ],
              },
              {
                institution:
                  "Nova School of Business and Economics | Lisbon, Portugal",
                degree: "BSc in Management | GPA: 16/20",
                details: [
                  "Statistics (20/20), Procurement Management (19/20), Economics of the European Union (19/20)",
                ],
              },
            ],
          },
          {
            id: "leadership",
            type: "leadership",
            title: "LEADERSHIP & ACTIVITIES",
            items: [
              {
                name: "Nova Thirst Project",
                desc: "Founder & President: Led 23 volunteers, raised â‚¬2,539 for water access, organized 4 events including one with 35 NGOs (2020-2021)",
              },
              {
                name: "Nova Tech Club",
                desc: "Digital Transformation Consultant: Developed a job platform prototype and organized corporate events and workshops (2020-2021)",
              },
              {
                name: "Nova Social Consulting (WWF)",
                desc: "Pro Bono Consultant: Assessed organizational structure, identified 155 improvement areas, delivered 6 presentations to senior management (2020-2021)",
              },
            ],
          },
          {
            id: "skills",
            type: "skills",
            title: "SKILLS",
            skills: [
              {
                label: "Sales & Marketing:",
                value:
                  "Google Ads, YouTube Ads, Google Display Network, CRM (Salesforce), LinkedIn Sales Navigator, Apollo, Full-Cycle Sales, Pipeline Management, Cold Outreach, Consultative Selling",
              },
              {
                label: "Technical:",
                value:
                  "Python, Apps Script, Visual Basic for Applications (VBA), SQL, Looker Studio, Power BI, DAX",
              },
              {
                label: "Certifications:",
                value:
                  "Google Ads Certified, Bloomberg Market Concepts, Microsoft Excel Specialist, TOEFL iBT",
              },
              {
                label: "Languages:",
                value:
                  "Portuguese (Native), English (Fluent), Spanish (Fluent), French (Beginner)",
              },
            ],
          },
        ],
      };

      const BUILT_IN_PROFILES = {
        "Google AE Final": GOOGLE_AE_CV,
      };

      // â•â•â• PROFILE / TAG SYSTEM â•â•â•
      const PROFILES_KEY = "cv-profiles";
      const ACTIVE_KEY = "cv-active-profile";
      let activeProfile = null;

      // â•â•â• STYLE / TYPOGRAPHY SYSTEM â•â•â•
      const STYLE_DEFAULTS = {
        bodyFont: "'Helvetica Neue', Helvetica, Arial, sans-serif",
        titleFont: "'Helvetica Neue', Helvetica, Arial, sans-serif",
        letterSpacing: 0,
        bodySize: null, // null = auto (autoFit controls it)
        titleSize: null, // null = auto (autoFit controls it)
        sectionGap: null, // null = auto (autoFit controls it)
        bulletGap: null,
        margins: null, // null = auto
        lineHeight: null,
        showGuides: false,
        showPrintBorder: false,
      };
      // userStyle: values the user has explicitly set; null = auto
      let userStyle = JSON.parse(JSON.stringify(STYLE_DEFAULTS));

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // INIT
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      function init() {
        // Seed built-in profiles if they don't exist yet
        const profiles = getProfiles();
        let seeded = false;
        Object.keys(BUILT_IN_PROFILES).forEach(function (name) {
          if (!profiles[name]) {
            profiles[name] = JSON.parse(
              JSON.stringify(BUILT_IN_PROFILES[name]),
            );
            seeded = true;
          }
        });
        if (seeded) setProfiles(profiles);

        loadProfileList();
        const activeName = localStorage.getItem(ACTIVE_KEY);
        if (activeName) {
          loadProfile(activeName, true);
        } else {
          const saved = localStorage.getItem("cv-editor-data");
          if (saved) {
            try {
              cv = JSON.parse(saved);
            } catch (e) {
              cv = JSON.parse(JSON.stringify(DEFAULT_CV));
            }
          }
          // Restore style from CV data
          if (cv.style) {
            userStyle = Object.assign(
              JSON.parse(JSON.stringify(STYLE_DEFAULTS)),
              cv.style,
            );
          }
          syncStyleUI();
        }
        renderEditor();
        renderPreview();
        autoZoom();
        window.addEventListener("resize", () => {
          clearTimeout(resizeTimer);
          resizeTimer = setTimeout(autoZoom, 200);
        });
        // Initialize AI provider UI state (show/hide Ollama row etc.)
        onProviderChange();
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // EDITOR RENDERING
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      function renderEditor() {
        const editor = document.getElementById("editor");
        let html = "";

        // Name & Contact
        html += `
              <div class="section-block">
                <div class="section-header" onclick="toggleSection(this)">
                  <span class="chevron open">â–¶</span>
                  <span class="section-title">Header</span>
                </div>
                <div class="section-body">
                  <div class="field-row">
                    <span class="field-label">Name</span>
                    <input class="field-input" value="${esc(cv.name)}" oninput="cv.name=this.value;schedulePreview()">
                  </div>
                  <div class="field-row">
                    <span class="field-label">Contact</span>
                    <input class="field-input" value="${esc(cv.contact)}" oninput="cv.contact=this.value;schedulePreview()">
                  </div>
                </div>
              </div>
            `;

        // Sections
        cv.sections.forEach((sec, si) => {
          const secHidden = sec.hidden ? "item-hidden" : "";
          html += `<div class="section-block ${secHidden}" draggable="true" ondragstart="dragSection(event,${si})" ondragover="dragOverSection(event,${si})" ondrop="dropSection(event,${si})" ondragend="dragEnd(event)">`;
          html += `
                <div class="section-header" onclick="toggleSection(this)">
                  <span class="chevron open">â–¶</span>
                  <span class="section-title">${esc(sec.title)}</span>
                  <div class="section-actions" onclick="event.stopPropagation()">
                    <button class="icon-btn eye ${sec.hidden ? "hidden-item" : ""}" onclick="toggleHide('section',${si})" title="${sec.hidden ? "Show" : "Hide"} section">${sec.hidden ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>' : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>'}</button>
                    <button class="icon-btn" onclick="moveSectionUp(${si})" title="Move up">â†‘</button>
                    <button class="icon-btn" onclick="moveSectionDown(${si})" title="Move down">â†“</button>
                    <button class="icon-btn delete" onclick="removeSection(${si})" title="Remove section">âœ•</button>
                  </div>
                </div>
                <div class="section-body">
                  <div class="field-row" style="margin-bottom:6px">
                    <span class="field-label">Title</span>
                    <input class="field-input" value="${esc(sec.title)}" oninput="cv.sections[${si}].title=this.value;schedulePreview();updateSectionTitle(this,${si})">
                  </div>
              `;

          if (sec.type === "summary") {
            html += `<textarea class="field-input" rows="3" oninput="cv.sections[${si}].content=this.value;schedulePreview()">${esc(sec.content)}</textarea>`;
          } else if (sec.type === "jobs") {
            sec.jobs.forEach((job, ji) => {
              const jobHidden = job.hidden ? "item-hidden" : "";
              html += `<div class="job-block ${jobHidden}" draggable="true" ondragstart="dragJob(event,${si},${ji})" ondragover="dragOverJob(event,${si},${ji})" ondrop="dropJob(event,${si},${ji})" ondragend="dragEnd(event)">`;
              html += `
                    <div class="job-header">
                      <input class="company" value="${esc(job.company)}" oninput="cv.sections[${si}].jobs[${ji}].company=this.value;schedulePreview()" placeholder="Company | Location">
                      <button class="icon-btn eye ${job.hidden ? "hidden-item" : ""}" onclick="toggleHide('job',${si},${ji})" title="${job.hidden ? "Show" : "Hide"} job">${job.hidden ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>' : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>'}</button>
                      <button class="icon-btn" onclick="moveJobUp(${si},${ji})">â†‘</button>
                      <button class="icon-btn" onclick="moveJobDown(${si},${ji})">â†“</button>
                      <button class="icon-btn delete" onclick="removeJob(${si},${ji})">âœ•</button>
                    </div>
                    <div class="job-header">
                      <input class="role" value="${esc(job.role)}" oninput="cv.sections[${si}].jobs[${ji}].role=this.value;schedulePreview()" placeholder="Role | Dates">
                    </div>
                    <ul class="bullet-list">
                  `;
              job.bullets.forEach((b, bi) => {
                const bHidden = (job.hiddenBullets || []).includes(bi);
                html += `
                      <li class="bullet-item ${bHidden ? "item-hidden" : ""}" draggable="true" ondragstart="dragBullet(event,${si},${ji},${bi})" ondragover="dragOverBullet(event,${si},${ji},${bi})" ondrop="dropBullet(event,${si},${ji},${bi})" ondragend="dragEnd(event)">
                        <span class="bullet-drag" title="Drag to reorder">â ¿</span>
                        <textarea class="bullet-text" rows="1" oninput="autoGrow(this);cv.sections[${si}].jobs[${ji}].bullets[${bi}]=this.value;schedulePreview()">${esc(b)}</textarea>
                        <div class="bullet-actions">
                          <button class="icon-btn eye ${bHidden ? "hidden-item" : ""}" onclick="toggleHide('bullet',${si},${ji},${bi})" title="${bHidden ? "Show" : "Hide"}">${bHidden ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>' : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>'}</button>
                          <button class="icon-btn" onclick="moveBulletUp(${si},${ji},${bi})">â†‘</button>
                          <button class="icon-btn" onclick="moveBulletDown(${si},${ji},${bi})">â†“</button>
                          <button class="icon-btn delete" onclick="removeBullet(${si},${ji},${bi})">âœ•</button>
                        </div>
                      </li>
                    `;
              });
              html += `</ul>`;
              html += `<div class="add-row"><button class="add-btn" onclick="addBullet(${si},${ji})">+ Add bullet</button></div>`;
              html += `</div>`;
            });
            html += `<div class="add-row"><button class="add-btn" onclick="addJob(${si})">+ Add job</button></div>`;
          } else if (sec.type === "education") {
            sec.schools.forEach((sch, ei) => {
              const schHidden = sch.hidden ? "item-hidden" : "";
              html += `<div class="job-block ${schHidden}">`;
              html += `
                    <div class="job-header">
                      <input class="company" value="${esc(sch.institution)}" oninput="cv.sections[${si}].schools[${ei}].institution=this.value;schedulePreview()">
                      <button class="icon-btn eye ${sch.hidden ? "hidden-item" : ""}" onclick="toggleHide('school',${si},${ei})" title="${sch.hidden ? "Show" : "Hide"}">${sch.hidden ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>' : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>'}</button>
                      <button class="icon-btn" onclick="moveSchoolUp(${si},${ei})">â†‘</button>
                      <button class="icon-btn" onclick="moveSchoolDown(${si},${ei})">â†“</button>
                      <button class="icon-btn delete" onclick="removeSchool(${si},${ei})">âœ•</button>
                    </div>
                    <div class="job-header">
                      <input class="role" value="${esc(sch.degree)}" oninput="cv.sections[${si}].schools[${ei}].degree=this.value;schedulePreview()">
                    </div>
                    <ul class="bullet-list">
                  `;
              (sch.details || []).forEach((d, di) => {
                const dHidden = (sch.hiddenDetails || []).includes(di);
                html += `
                      <li class="bullet-item ${dHidden ? "item-hidden" : ""}">
                        <span class="bullet-drag">â ¿</span>
                        <textarea class="bullet-text" rows="1" oninput="autoGrow(this);cv.sections[${si}].schools[${ei}].details[${di}]=this.value;schedulePreview()">${esc(d)}</textarea>
                        <div class="bullet-actions">
                          <button class="icon-btn eye ${dHidden ? "hidden-item" : ""}" onclick="toggleHide('eduDetail',${si},${ei},${di})" title="${dHidden ? "Show" : "Hide"}">${dHidden ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>' : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>'}</button>
                          <button class="icon-btn delete" onclick="removeEduDetail(${si},${ei},${di})">âœ•</button>
                        </div>
                      </li>
                    `;
              });
              html += `</ul>`;
              html += `<div class="add-row"><button class="add-btn" onclick="addEduDetail(${si},${ei})">+ Add detail</button></div>`;
              html += `</div>`;
            });
            html += `<div class="add-row"><button class="add-btn" onclick="addSchool(${si})">+ Add school</button></div>`;
          } else if (sec.type === "leadership") {
            sec.items.forEach((item, li) => {
              const liHidden = item.hidden ? "item-hidden" : "";
              html += `
                    <div class="leadership-item ${liHidden}">
                      <input class="name" value="${esc(item.name)}" oninput="cv.sections[${si}].items[${li}].name=this.value;schedulePreview()">
                      <input class="desc" value="${esc(item.desc)}" oninput="cv.sections[${si}].items[${li}].desc=this.value;schedulePreview()">
                      <button class="icon-btn eye ${item.hidden ? "hidden-item" : ""}" onclick="toggleHide('leadership',${si},${li})" title="${item.hidden ? "Show" : "Hide"}">${item.hidden ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>' : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>'}</button>
                      <button class="icon-btn" onclick="moveLeadershipUp(${si},${li})">â†‘</button>
                      <button class="icon-btn" onclick="moveLeadershipDown(${si},${li})">â†“</button>
                      <button class="icon-btn delete" onclick="removeLeadership(${si},${li})">âœ•</button>
                    </div>
                  `;
            });
            html += `<div class="add-row"><button class="add-btn" onclick="addLeadership(${si})">+ Add activity</button></div>`;
          } else if (sec.type === "skills") {
            sec.skills.forEach((sk, ki) => {
              const skHidden = sk.hidden ? "item-hidden" : "";
              html += `
                    <div class="skill-row ${skHidden}">
                      <input class="skill-label" value="${esc(sk.label)}" oninput="cv.sections[${si}].skills[${ki}].label=this.value;schedulePreview()">
                      <input class="skill-value" value="${esc(sk.value)}" oninput="cv.sections[${si}].skills[${ki}].value=this.value;schedulePreview()">
                      <button class="icon-btn eye ${sk.hidden ? "hidden-item" : ""}" onclick="toggleHide('skill',${si},${ki})" title="${sk.hidden ? "Show" : "Hide"}">${sk.hidden ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>' : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>'}</button>
                      <button class="icon-btn delete" onclick="removeSkill(${si},${ki})">âœ•</button>
                    </div>
                  `;
            });
            html += `<div class="add-row"><button class="add-btn" onclick="addSkill(${si})">+ Add skill</button></div>`;
          }

          html += `</div></div>`;
        });

        editor.innerHTML = html;

        // Auto-grow textareas
        document.querySelectorAll(".bullet-text").forEach((ta) => autoGrow(ta));
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // PREVIEW RENDERING + AUTO-FIT
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      function renderPreview() {
        const paper = document.getElementById("paper");
        // ATS-friendly: use semantic HTML (h1/h2/h3/p/ul/li)
        let html = `<h1 class="cv-name">${esc(cv.name)}</h1>`;
        html += `<p class="cv-contact">${esc(cv.contact)}</p>`;

        // Helper: split "Name | Location" or "Title | Dates" on pipe
        function splitPipe(text) {
          const idx = text.indexOf(" | ");
          if (idx > -1)
            return [text.substring(0, idx), text.substring(idx + 3)];
          return [text, ""];
        }

        cv.sections.forEach((sec) => {
          if (sec.hidden) return;
          html += `<h2 class="cv-section-title">${esc(sec.title)}</h2>`;

          if (sec.type === "summary") {
            html += `<p class="cv-summary">${esc(sec.content)}</p>`;
          } else if (sec.type === "jobs") {
            sec.jobs.forEach((job) => {
              if (job.hidden) return;
              const [companyName, companyLoc] = splitPipe(job.company);
              const [roleTitle, roleDates] = splitPipe(job.role);
              html += `<h3 class="cv-company">${esc(companyName)}${companyLoc ? `<span class="cv-location">${esc(companyLoc)}</span>` : ""}</h3>`;
              html += `<p class="cv-role">${esc(roleTitle)}${roleDates ? `<span class="cv-dates">${esc(roleDates)}</span>` : ""}</p>`;
              html += `<ul>`;
              job.bullets.forEach((b, bi) => {
                if ((job.hiddenBullets || []).includes(bi)) return;
                html += `<li class="cv-bullet">- ${esc(b)}</li>`;
              });
              html += `</ul>`;
            });
          } else if (sec.type === "education") {
            sec.schools.forEach((sch) => {
              if (sch.hidden) return;
              const [instName, instLoc] = splitPipe(sch.institution);
              const [degName, degExtra] = splitPipe(sch.degree);
              html += `<h3 class="cv-company">${esc(instName)}${instLoc ? `<span class="cv-location">${esc(instLoc)}</span>` : ""}</h3>`;
              html += `<p class="cv-role">${esc(degName)}${degExtra ? `<span class="cv-dates">${esc(degExtra)}</span>` : ""}</p>`;
              html += `<ul>`;
              (sch.details || []).forEach((d, di) => {
                if ((sch.hiddenDetails || []).includes(di)) return;
                html += `<li class="cv-edu-detail">- ${esc(d)}</li>`;
              });
              html += `</ul>`;
            });
          } else if (sec.type === "leadership") {
            sec.items.forEach((item) => {
              if (item.hidden) return;
              html += `<h3 class="cv-company">${esc(item.name)}</h3>`;
              const colonIdx = item.desc.indexOf(": ");
              if (colonIdx > -1) {
                const role = item.desc.substring(0, colonIdx);
                const detail = item.desc.substring(colonIdx + 2);
                html += `<p class="cv-role">${esc(role)}</p>`;
                html += `<ul><li class="cv-bullet">- ${esc(detail)}</li></ul>`;
              } else {
                html += `<ul><li class="cv-bullet">- ${esc(item.desc)}</li></ul>`;
              }
            });
          } else if (sec.type === "skills") {
            sec.skills.forEach((sk) => {
              if (sk.hidden) return;
              html += `<p class="cv-skill"><strong>${esc(sk.label)}</strong> ${esc(sk.value)}</p>`;
            });
          }
        });

        paper.innerHTML = html;
        autoFit();
      }

      function autoFit() {
        const paper = document.getElementById("paper");
        const checkOverflow = () => paper.scrollHeight > paper.clientHeight;
        const getFillRatio = () => paper.scrollHeight / paper.clientHeight;

        // Count total content entries to determine if page should be filled
        const countEntries = () => {
          let count = 0;
          cv.sections.forEach((sec) => {
            count++; // section header
            if (sec.type === "summary") count += 1;
            else if (sec.type === "jobs")
              sec.jobs.forEach((j) => {
                count += 2;
                count += j.bullets.length;
              });
            else if (sec.type === "education")
              sec.schools.forEach((s) => {
                count += 2;
                count += (s.details || []).length;
              });
            else if (sec.type === "leadership") count += sec.items.length;
            else if (sec.type === "skills") count += sec.skills.length;
          });
          return count;
        };

        // â”€â”€ BASE VALUES (benchmark defaults) â”€â”€
        const BASE = {
          sectionGap: 5,
          companyGap: 3,
          bulletGap: 0.5,
          lineHeight: 1.35,
          nameSize: 15,
          contactSize: 7.5,
          contactMargin: 6,
          sectionTitleSize: 9.5,
          companySize: 8.5,
          roleSize: 8,
          bodySize: 7.5,
          padV: 10,
          padH: 14,
        };

        // Apply user-locked values as overrides to BASE
        const locked = {};
        if (userStyle.titleSize !== null) {
          BASE.sectionTitleSize = userStyle.titleSize;
          BASE.companySize = userStyle.titleSize - 1;
          BASE.roleSize = userStyle.titleSize - 1.5;
          locked.sectionTitleSize = true;
          locked.companySize = true;
          locked.roleSize = true;
        }
        if (userStyle.bodySize !== null) {
          BASE.bodySize = userStyle.bodySize;
          locked.bodySize = true;
        }
        if (userStyle.sectionGap !== null) {
          BASE.sectionGap = userStyle.sectionGap;
          locked.sectionGap = true;
        }
        if (userStyle.bulletGap !== null) {
          BASE.bulletGap = userStyle.bulletGap;
          locked.bulletGap = true;
        }
        if (userStyle.lineHeight !== null) {
          BASE.lineHeight = userStyle.lineHeight;
          locked.lineHeight = true;
        }
        if (userStyle.margins !== null) {
          BASE.padV = userStyle.margins;
          BASE.padH = userStyle.margins + 4;
          locked.padV = true;
          locked.padH = true;
        }

        // Apply fonts and letter-spacing (always user-controlled, not auto-adjustable)
        const applyFonts = () => {
          paper.style.fontFamily = userStyle.bodyFont;
          paper.style.letterSpacing = userStyle.letterSpacing + "px";
          paper
            .querySelectorAll(".cv-name, .cv-section-title")
            .forEach((el) => {
              el.style.fontFamily = userStyle.titleFont;
            });
        };

        const applyState = (state) => {
          paper.style.padding = `${state.padV}mm ${state.padH}mm`;
          paper
            .querySelectorAll(".cv-name")
            .forEach((el) => (el.style.fontSize = state.nameSize + "pt"));
          paper.querySelectorAll(".cv-contact").forEach((el) => {
            el.style.fontSize = state.contactSize + "pt";
            el.style.marginBottom = state.contactMargin + "px";
          });
          paper.querySelectorAll(".cv-section-title").forEach((el) => {
            el.style.fontSize = state.sectionTitleSize + "pt";
            el.style.marginTop = state.sectionGap + "px";
          });
          paper.querySelectorAll(".cv-company").forEach((el) => {
            el.style.fontSize = state.companySize + "pt";
            el.style.marginTop = state.companyGap + "px";
          });
          paper.querySelectorAll(".cv-role").forEach((el) => {
            el.style.fontSize = state.roleSize + "pt";
          });
          paper
            .querySelectorAll(
              ".cv-bullet, .cv-edu-detail, .cv-leadership, .cv-skill, .cv-summary",
            )
            .forEach((el) => {
              el.style.fontSize = state.bodySize + "pt";
              el.style.lineHeight = String(state.lineHeight);
              el.style.marginBottom = state.bulletGap + "px";
            });
          paper.querySelectorAll(".cv-location, .cv-dates").forEach((el) => {
            el.style.fontSize = state.bodySize + "pt";
          });
        };

        // Filter expansion/compression steps to exclude locked properties
        const filterSteps = (steps) =>
          steps.filter((step) => {
            for (const key of Object.keys(step)) {
              if (locked[key]) return false;
            }
            return true;
          });

        // â”€â”€ STEP 1: Start from base + apply fonts â”€â”€
        let state = { ...BASE };
        applyFonts();
        applyState(state);

        const entries = countEntries();
        const TOO_SPARSE = entries < 10;

        // â”€â”€ STEP 2: EXPAND if content doesn't fill the page â”€â”€
        if (!checkOverflow() && !TOO_SPARSE) {
          const expansionSteps = filterSteps([
            { sectionGap: 6 },
            { sectionGap: 7 },
            { sectionGap: 8 },
            { sectionGap: 9 },
            { sectionGap: 10 },
            { sectionGap: 12 },
            { sectionGap: 14 },
            { companyGap: 4 },
            { companyGap: 5 },
            { companyGap: 6 },
            { bulletGap: 1 },
            { bulletGap: 1.5 },
            { bulletGap: 2 },
            { contactMargin: 8 },
            { contactMargin: 10 },
            { contactMargin: 12 },
            { lineHeight: 1.4 },
            { lineHeight: 1.45 },
            { padV: 11, padH: 15 },
            { padV: 12, padH: 16 },
          ]);

          let expLevel = 0;
          while (!checkOverflow() && expLevel < expansionSteps.length) {
            const prev = { ...state };
            Object.assign(state, expansionSteps[expLevel]);
            applyState(state);
            if (checkOverflow()) {
              state = prev;
              applyState(state);
              break;
            }
            expLevel++;
          }
        }

        // â”€â”€ STEP 3: COMPRESS if content overflows â”€â”€
        if (checkOverflow()) {
          state = { ...BASE };
          applyState(state);

          const compressionSteps = filterSteps([
            { sectionGap: 4.5 },
            { sectionGap: 4 },
            { sectionGap: 3.5 },
            { sectionGap: 3 },
            { companyGap: 2.5 },
            { companyGap: 2 },
            { companyGap: 1.5 },
            { bulletGap: 0.3 },
            { bulletGap: 0.1 },
            { bulletGap: 0 },
            { lineHeight: 1.3 },
            { lineHeight: 1.25 },
            { lineHeight: 1.2 },
            { contactMargin: 4 },
            { contactMargin: 3 },
            { bodySize: 7.2 },
            { bodySize: 7.0 },
            { bodySize: 6.8 },
            { sectionTitleSize: 9.0, companySize: 8.0, roleSize: 7.5 },
            { sectionTitleSize: 8.5, companySize: 7.5, roleSize: 7.0 },
            { nameSize: 14, contactSize: 7 },
            { nameSize: 13, contactSize: 6.5 },
            { padV: 9, padH: 13 },
            { padV: 8, padH: 12 },
            { padV: 7, padH: 10 },
            { padV: 6, padH: 9 },
          ]);

          let compLevel = 0;
          while (checkOverflow() && compLevel < compressionSteps.length) {
            Object.assign(state, compressionSteps[compLevel]);
            applyState(state);
            compLevel++;
          }
        }

        // â”€â”€ UPDATE MARGIN GUIDES â”€â”€
        lastAutoFitState = { ...state };
        updateMarginGuides(state);

        // â”€â”€ STATUS BAR â”€â”€
        const fitStatus = document.getElementById("fit-status");
        const scaleInfo = document.getElementById("scale-info");
        const overflowLine = document.getElementById("overflow-line");
        const ratio = getFillRatio();
        const fillPct = Math.round(ratio * 100);

        if (checkOverflow()) {
          fitStatus.textContent = "âœ• Overflows â€” reduce content";
          fitStatus.className = "fit-indicator fit-over";
          overflowLine.style.display = "block";
        } else if (TOO_SPARSE) {
          fitStatus.textContent = "â—‹ Sparse content â€” add more to fill page";
          fitStatus.className = "fit-indicator fit-warn";
          overflowLine.style.display = "none";
        } else if (fillPct >= 92) {
          fitStatus.textContent = "âœ“ Perfectly filled";
          fitStatus.className = "fit-indicator fit-ok";
          overflowLine.style.display = "none";
        } else if (fillPct >= 80) {
          fitStatus.textContent = "âœ“ Well balanced";
          fitStatus.className = "fit-indicator fit-ok";
          overflowLine.style.display = "none";
        } else {
          fitStatus.textContent = "âœ“ Fits comfortably";
          fitStatus.className = "fit-indicator fit-ok";
          overflowLine.style.display = "none";
        }

        const bodyFont = state.bodySize;
        const lh = state.lineHeight;
        scaleInfo.textContent = `Fill: ${fillPct}% | Body: ${bodyFont}pt | LH: ${lh} | Gaps: ${state.sectionGap}px`;
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // SECTION OPERATIONS
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      function moveSectionUp(i) {
        if (i <= 0) return;
        [cv.sections[i - 1], cv.sections[i]] = [
          cv.sections[i],
          cv.sections[i - 1],
        ];
        renderEditor();
        renderPreview();
      }
      function moveSectionDown(i) {
        if (i >= cv.sections.length - 1) return;
        [cv.sections[i], cv.sections[i + 1]] = [
          cv.sections[i + 1],
          cv.sections[i],
        ];
        renderEditor();
        renderPreview();
      }
      function removeSection(i) {
        if (!confirm(`Remove section "${cv.sections[i].title}"?`)) return;
        cv.sections.splice(i, 1);
        renderEditor();
        renderPreview();
      }
      function addSection() {
        const type = prompt(
          "Section type: summary, jobs, education, leadership, or skills",
          "jobs",
        );
        if (!type) return;
        const title = prompt("Section title:", "NEW SECTION");
        if (!title) return;
        const sec = { id: "sec_" + Date.now(), type, title };
        if (type === "summary") sec.content = "";
        else if (type === "jobs") sec.jobs = [];
        else if (type === "education") sec.schools = [];
        else if (type === "leadership") sec.items = [];
        else if (type === "skills") sec.skills = [];
        cv.sections.push(sec);
        renderEditor();
        renderPreview();
      }
      function updateSectionTitle(input, si) {
        // Update the header display
        const block = input.closest(".section-block");
        const titleSpan = block.querySelector(".section-title");
        titleSpan.textContent = input.value;
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // JOB OPERATIONS
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      function addJob(si) {
        cv.sections[si].jobs.push({ company: "", role: "", bullets: [""] });
        renderEditor();
        renderPreview();
      }
      function removeJob(si, ji) {
        if (!confirm("Remove this job?")) return;
        cv.sections[si].jobs.splice(ji, 1);
        renderEditor();
        renderPreview();
      }
      function moveJobUp(si, ji) {
        if (ji <= 0) return;
        const jobs = cv.sections[si].jobs;
        [jobs[ji - 1], jobs[ji]] = [jobs[ji], jobs[ji - 1]];
        renderEditor();
        renderPreview();
      }
      function moveJobDown(si, ji) {
        const jobs = cv.sections[si].jobs;
        if (ji >= jobs.length - 1) return;
        [jobs[ji], jobs[ji + 1]] = [jobs[ji + 1], jobs[ji]];
        renderEditor();
        renderPreview();
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // BULLET OPERATIONS
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      function addBullet(si, ji) {
        cv.sections[si].jobs[ji].bullets.push("");
        renderEditor();
        renderPreview();
      }
      function removeBullet(si, ji, bi) {
        cv.sections[si].jobs[ji].bullets.splice(bi, 1);
        renderEditor();
        renderPreview();
      }
      function moveBulletUp(si, ji, bi) {
        if (bi <= 0) return;
        const bullets = cv.sections[si].jobs[ji].bullets;
        [bullets[bi - 1], bullets[bi]] = [bullets[bi], bullets[bi - 1]];
        renderEditor();
        renderPreview();
      }
      function moveBulletDown(si, ji, bi) {
        const bullets = cv.sections[si].jobs[ji].bullets;
        if (bi >= bullets.length - 1) return;
        [bullets[bi], bullets[bi + 1]] = [bullets[bi + 1], bullets[bi]];
        renderEditor();
        renderPreview();
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // EDUCATION OPERATIONS
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      function addSchool(si) {
        cv.sections[si].schools.push({
          institution: "",
          degree: "",
          details: [],
        });
        renderEditor();
        renderPreview();
      }
      function removeSchool(si, ei) {
        if (!confirm("Remove this school?")) return;
        cv.sections[si].schools.splice(ei, 1);
        renderEditor();
        renderPreview();
      }
      function moveSchoolUp(si, ei) {
        if (ei <= 0) return;
        const schools = cv.sections[si].schools;
        [schools[ei - 1], schools[ei]] = [schools[ei], schools[ei - 1]];
        renderEditor();
        renderPreview();
      }
      function moveSchoolDown(si, ei) {
        const schools = cv.sections[si].schools;
        if (ei >= schools.length - 1) return;
        [schools[ei], schools[ei + 1]] = [schools[ei + 1], schools[ei]];
        renderEditor();
        renderPreview();
      }
      function addEduDetail(si, ei) {
        cv.sections[si].schools[ei].details.push("");
        renderEditor();
        renderPreview();
      }
      function removeEduDetail(si, ei, di) {
        cv.sections[si].schools[ei].details.splice(di, 1);
        renderEditor();
        renderPreview();
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // LEADERSHIP OPERATIONS
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      function addLeadership(si) {
        cv.sections[si].items.push({ name: "", desc: "" });
        renderEditor();
        renderPreview();
      }
      function removeLeadership(si, li) {
        cv.sections[si].items.splice(li, 1);
        renderEditor();
        renderPreview();
      }
      function moveLeadershipUp(si, li) {
        if (li <= 0) return;
        const items = cv.sections[si].items;
        [items[li - 1], items[li]] = [items[li], items[li - 1]];
        renderEditor();
        renderPreview();
      }
      function moveLeadershipDown(si, li) {
        const items = cv.sections[si].items;
        if (li >= items.length - 1) return;
        [items[li], items[li + 1]] = [items[li + 1], items[li]];
        renderEditor();
        renderPreview();
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // HIDE/SHOW TOGGLE
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      function toggleHide(type, si, ji, bi) {
        switch (type) {
          case "section":
            cv.sections[si].hidden = !cv.sections[si].hidden;
            break;
          case "job":
            cv.sections[si].jobs[ji].hidden = !cv.sections[si].jobs[ji].hidden;
            break;
          case "bullet": {
            const job = cv.sections[si].jobs[ji];
            if (!job.hiddenBullets) job.hiddenBullets = [];
            const idx = job.hiddenBullets.indexOf(bi);
            if (idx === -1) job.hiddenBullets.push(bi);
            else job.hiddenBullets.splice(idx, 1);
            break;
          }
          case "school":
            cv.sections[si].schools[ji].hidden =
              !cv.sections[si].schools[ji].hidden;
            break;
          case "eduDetail": {
            const sch = cv.sections[si].schools[ji];
            if (!sch.hiddenDetails) sch.hiddenDetails = [];
            const idx = sch.hiddenDetails.indexOf(bi);
            if (idx === -1) sch.hiddenDetails.push(bi);
            else sch.hiddenDetails.splice(idx, 1);
            break;
          }
          case "leadership":
            cv.sections[si].items[ji].hidden =
              !cv.sections[si].items[ji].hidden;
            break;
          case "skill":
            cv.sections[si].skills[ji].hidden =
              !cv.sections[si].skills[ji].hidden;
            break;
        }
        renderEditor();
        renderPreview();
      }
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // SKILLS OPERATIONS
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      function addSkill(si) {
        cv.sections[si].skills.push({ label: "", value: "" });
        renderEditor();
        renderPreview();
      }
      function removeSkill(si, ki) {
        cv.sections[si].skills.splice(ki, 1);
        renderEditor();
        renderPreview();
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // DRAG AND DROP â€” SECTIONS
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      let dragType = null,
        dragFrom = null;

      function dragSection(e, i) {
        dragType = "section";
        dragFrom = { si: i };
        e.dataTransfer.effectAllowed = "move";
        e.target.classList.add("dragging");
      }
      function dragOverSection(e, i) {
        if (dragType !== "section") return;
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
      }
      function dropSection(e, i) {
        if (dragType !== "section") return;
        e.preventDefault();
        const from = dragFrom.si;
        if (from === i) return;
        const item = cv.sections.splice(from, 1)[0];
        cv.sections.splice(i, 0, item);
        renderEditor();
        renderPreview();
      }

      // DRAG â€” JOBS
      function dragJob(e, si, ji) {
        dragType = "job";
        dragFrom = { si, ji };
        e.dataTransfer.effectAllowed = "move";
        e.stopPropagation();
        e.target.classList.add("dragging");
      }
      function dragOverJob(e, si, ji) {
        if (dragType !== "job" || dragFrom.si !== si) return;
        e.preventDefault();
        e.stopPropagation();
      }
      function dropJob(e, si, ji) {
        if (dragType !== "job" || dragFrom.si !== si) return;
        e.preventDefault();
        e.stopPropagation();
        const from = dragFrom.ji;
        if (from === ji) return;
        const jobs = cv.sections[si].jobs;
        const item = jobs.splice(from, 1)[0];
        jobs.splice(ji, 0, item);
        renderEditor();
        renderPreview();
      }

      // DRAG â€” BULLETS
      function dragBullet(e, si, ji, bi) {
        dragType = "bullet";
        dragFrom = { si, ji, bi };
        e.dataTransfer.effectAllowed = "move";
        e.stopPropagation();
        e.target.classList.add("dragging");
      }
      function dragOverBullet(e, si, ji, bi) {
        if (dragType !== "bullet" || dragFrom.si !== si || dragFrom.ji !== ji)
          return;
        e.preventDefault();
        e.stopPropagation();
      }
      function dropBullet(e, si, ji, bi) {
        if (dragType !== "bullet" || dragFrom.si !== si || dragFrom.ji !== ji)
          return;
        e.preventDefault();
        e.stopPropagation();
        const from = dragFrom.bi;
        if (from === bi) return;
        const bullets = cv.sections[si].jobs[ji].bullets;
        const item = bullets.splice(from, 1)[0];
        bullets.splice(bi, 0, item);
        renderEditor();
        renderPreview();
      }

      function dragEnd(e) {
        dragType = null;
        dragFrom = null;
        document
          .querySelectorAll(".dragging")
          .forEach((el) => el.classList.remove("dragging"));
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // UTILITIES
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      function esc(s) {
        if (!s) return "";
        return s
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }

      function autoGrow(el) {
        el.style.height = "auto";
        el.style.height = el.scrollHeight + "px";
      }

      function toggleSection(header) {
        const body = header.nextElementSibling;
        const chevron = header.querySelector(".chevron");
        body.classList.toggle("collapsed");
        chevron.classList.toggle("open");
      }

      function setZoom(val) {
        zoomLevel = parseInt(val);
        document.getElementById("zoom-val").textContent = zoomLevel + "%";
        document.querySelector(".zoom-slider").value = zoomLevel;
        document.getElementById("paper").style.transform =
          `scale(${zoomLevel / 100})`;
      }

      function autoZoom() {
        const panel = document.querySelector(".paper-wrapper");
        const toolbar = document.querySelector(".toolbar");
        const stylePanel = document.getElementById("style-panel");
        const paperW = 793.7; // 210mm in px
        const paperH = 1122.5; // 297mm in px
        const availW = panel.clientWidth - 40;
        const spUsed =
          (toolbar ? toolbar.offsetHeight : 0) +
          (stylePanel && !stylePanel.classList.contains("collapsed")
            ? stylePanel.offsetHeight
            : 0);
        const availH = panel.clientHeight - spUsed - 40;
        const scaleW = availW / paperW;
        const scaleH = availH / paperH;
        const scale = Math.min(scaleW, scaleH);
        const zoom = Math.max(20, Math.min(200, Math.round(scale * 100)));
        setZoom(zoom);
      }

      // ===================================================
      // STYLE / TYPOGRAPHY CONTROLS
      // ===================================================
      function toggleStylePanel() {
        const panel = document.getElementById("style-panel");
        panel.classList.toggle("collapsed");
        setTimeout(autoZoom, 50);
      }

      function setStyleFont(prop, val) {
        userStyle[prop] = val;
        cv.style = JSON.parse(JSON.stringify(userStyle));
        renderPreview();
        schedulePreview();
      }

      function setStyleVal(prop, val) {
        userStyle[prop] = val;
        updateStyleValDisplay(prop, val);
        const btnMap = {
          bodySize: "btn-auto-fontsize",
          titleSize: "btn-auto-titlesize",
          bulletGap: "btn-auto-para",
          sectionGap: "btn-auto-section",
          margins: "btn-auto-margins",
          lineHeight: "btn-auto-lineheight",
        };
        const btnId = btnMap[prop];
        if (btnId) document.getElementById(btnId).classList.remove("active");
        cv.style = JSON.parse(JSON.stringify(userStyle));
        renderPreview();
        schedulePreview();
      }

      function toggleAuto(prop) {
        const btnMap = {
          bodySize: "btn-auto-fontsize",
          titleSize: "btn-auto-titlesize",
          bulletGap: "btn-auto-para",
          sectionGap: "btn-auto-section",
          margins: "btn-auto-margins",
          lineHeight: "btn-auto-lineheight",
        };
        if (userStyle[prop] === null) {
          const defaults = {
            bodySize: 7.5,
            titleSize: 9.5,
            bulletGap: 0.5,
            sectionGap: 5,
            margins: 10,
            lineHeight: 1.35,
          };
          userStyle[prop] = defaults[prop];
          document.getElementById(btnMap[prop]).classList.remove("active");
        } else {
          userStyle[prop] = null;
          document.getElementById(btnMap[prop]).classList.add("active");
        }
        updateStyleValDisplay(prop, userStyle[prop]);
        cv.style = JSON.parse(JSON.stringify(userStyle));
        renderPreview();
        schedulePreview();
      }

      function updateStyleValDisplay(prop, val) {
        const map = {
          bodySize: "style-font-size-val",
          titleSize: "style-title-size-val",
          bulletGap: "style-para-gap-val",
          sectionGap: "style-section-gap-val",
          margins: "style-margins-val",
          lineHeight: "style-line-height-val",
          letterSpacing: "style-letter-spacing-val",
        };
        const el = document.getElementById(map[prop]);
        if (!el) return;
        if (val === null) {
          el.textContent = "auto";
        } else if (prop === "letterSpacing") {
          el.textContent = val.toFixed(2) + "px";
        } else if (prop === "bodySize" || prop === "titleSize") {
          el.textContent = val.toFixed(1) + "pt";
        } else if (prop === "lineHeight") {
          el.textContent = val.toFixed(2);
        } else if (prop === "margins") {
          el.textContent = val.toFixed(1) + "mm";
        } else {
          el.textContent = val.toFixed(1) + "px";
        }
      }

      function syncStyleUI() {
        const bf = document.getElementById("style-body-font");
        const tf = document.getElementById("style-title-font");
        if (bf) {
          for (const opt of bf.options) {
            if (opt.value === userStyle.bodyFont) opt.selected = true;
          }
        }
        if (tf) {
          for (const opt of tf.options) {
            if (opt.value === userStyle.titleFont) opt.selected = true;
          }
        }
        document.getElementById("style-letter-spacing").value =
          userStyle.letterSpacing * 100;
        updateStyleValDisplay("letterSpacing", userStyle.letterSpacing);
        const syncSlider = (prop, sliderId, btnId, defVal) => {
          const slider = document.getElementById(sliderId);
          const btn = document.getElementById(btnId);
          if (userStyle[prop] !== null) {
            slider.value = userStyle[prop] * 10;
            btn.classList.remove("active");
            updateStyleValDisplay(prop, userStyle[prop]);
          } else {
            slider.value = defVal * 10;
            btn.classList.add("active");
            updateStyleValDisplay(prop, null);
          }
        };
        syncSlider("bodySize", "style-font-size", "btn-auto-fontsize", 7.5);
        syncSlider("titleSize", "style-title-size", "btn-auto-titlesize", 9.5);
        syncSlider("bulletGap", "style-para-gap", "btn-auto-para", 0.5);
        syncSlider("sectionGap", "style-section-gap", "btn-auto-section", 5);
        syncSlider("margins", "style-margins", "btn-auto-margins", 10);
        syncSlider(
          "lineHeight",
          "style-line-height",
          "btn-auto-lineheight",
          1.35,
        );
        document.getElementById("chk-margins").checked = !!userStyle.showGuides;
        document
          .getElementById("margin-guide")
          .classList.toggle("visible", !!userStyle.showGuides);
        document.getElementById("chk-printborder").checked =
          !!userStyle.showPrintBorder;
        document
          .getElementById("print-border")
          .classList.toggle("visible", !!userStyle.showPrintBorder);
      }

      function toggleGuides(type) {
        if (type === "margins") {
          userStyle.showGuides = document.getElementById("chk-margins").checked;
          document
            .getElementById("margin-guide")
            .classList.toggle("visible", userStyle.showGuides);
        } else if (type === "printborder") {
          userStyle.showPrintBorder =
            document.getElementById("chk-printborder").checked;
          document
            .getElementById("print-border")
            .classList.toggle("visible", userStyle.showPrintBorder);
        }
        cv.style = JSON.parse(JSON.stringify(userStyle));
      }

      function updateMarginGuides(state) {
        const inner = document.getElementById("margin-guide-inner");
        if (!inner) return;
        const pctTop = (state.padV / 297) * 100;
        const pctBot = pctTop;
        const pctLeft = (state.padH / 210) * 100;
        const pctRight = pctLeft;
        inner.style.top = pctTop + "%";
        inner.style.left = pctLeft + "%";
        inner.style.right = pctRight + "%";
        inner.style.bottom = pctBot + "%";
      }

      function schedulePreview() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          renderPreview();
          // Auto-save to current profile quietly
          if (activeProfile) {
            const profiles = getProfiles();
            profiles[activeProfile] = JSON.parse(JSON.stringify(cv));
            setProfiles(profiles);
          }
          localStorage.setItem("cv-editor-data", JSON.stringify(cv));
        }, 150);
      }

      function saveToStorage() {
        // Legacy: also saves to old key for backward compat
        localStorage.setItem("cv-editor-data", JSON.stringify(cv));
        if (activeProfile) {
          saveCurrentProfile(true);
        } else {
          alert("Saved! Use 'Save As' to save with a tag.");
        }
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // PROFILE / TAG MANAGEMENT
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      function getProfiles() {
        try {
          return JSON.parse(localStorage.getItem(PROFILES_KEY) || "{}");
        } catch (e) {
          return {};
        }
      }

      function setProfiles(profiles) {
        localStorage.setItem(PROFILES_KEY, JSON.stringify(profiles));
      }

      function loadProfileList() {
        const sel = document.getElementById("profile-select");
        const profiles = getProfiles();
        const names = Object.keys(profiles).sort();
        sel.innerHTML = '<option value="">â€” Unsaved Draft â€”</option>';
        names.forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          if (name === activeProfile) opt.selected = true;
          sel.appendChild(opt);
        });
        updateProfileIndicator();
      }

      function updateProfileIndicator() {
        const ind = document.getElementById("profile-indicator");
        if (ind) ind.textContent = activeProfile ? "ğŸ· " + activeProfile : "";
      }

      function loadProfile(name, silent) {
        if (!name) {
          // Switching to "unsaved draft" â€” load from legacy storage or default
          activeProfile = null;
          localStorage.removeItem(ACTIVE_KEY);
          const saved = localStorage.getItem("cv-editor-data");
          if (saved) {
            try {
              cv = JSON.parse(saved);
            } catch (e) {
              cv = JSON.parse(JSON.stringify(DEFAULT_CV));
            }
          } else {
            cv = JSON.parse(JSON.stringify(DEFAULT_CV));
          }
          // Restore style
          if (cv.style) {
            userStyle = Object.assign(
              JSON.parse(JSON.stringify(STYLE_DEFAULTS)),
              cv.style,
            );
          } else {
            userStyle = JSON.parse(JSON.stringify(STYLE_DEFAULTS));
          }
          syncStyleUI();
          renderEditor();
          renderPreview();
          updateProfileIndicator();
          return;
        }
        const profiles = getProfiles();
        if (profiles[name]) {
          cv = JSON.parse(JSON.stringify(profiles[name]));
          activeProfile = name;
          localStorage.setItem(ACTIVE_KEY, name);
          // Restore style
          if (cv.style) {
            userStyle = Object.assign(
              JSON.parse(JSON.stringify(STYLE_DEFAULTS)),
              cv.style,
            );
          } else {
            userStyle = JSON.parse(JSON.stringify(STYLE_DEFAULTS));
          }
          syncStyleUI();
          renderEditor();
          renderPreview();
          loadProfileList();
          if (!silent) {
            showToast("Loaded: " + name);
          }
        }
      }

      function saveAsProfile() {
        const suggested = activeProfile || "";
        const name = prompt(
          'Save CV with tag name (e.g. "Google AE", "Sales CV", "Consulting"):',
          suggested,
        );
        if (!name || !name.trim()) return;
        const tag = name.trim();
        const profiles = getProfiles();
        if (
          profiles[tag] &&
          !confirm('Overwrite existing profile "' + tag + '"?')
        )
          return;
        profiles[tag] = JSON.parse(JSON.stringify(cv));
        setProfiles(profiles);
        activeProfile = tag;
        localStorage.setItem(ACTIVE_KEY, tag);
        localStorage.setItem("cv-editor-data", JSON.stringify(cv));
        loadProfileList();
        showToast("Saved: " + tag);
      }

      function saveCurrentProfile(quiet) {
        if (!activeProfile) {
          saveAsProfile();
          return;
        }
        const profiles = getProfiles();
        profiles[activeProfile] = JSON.parse(JSON.stringify(cv));
        setProfiles(profiles);
        localStorage.setItem("cv-editor-data", JSON.stringify(cv));
        if (!quiet) showToast("Saved: " + activeProfile);
      }

      function deleteProfile() {
        const sel = document.getElementById("profile-select");
        const name = sel.value;
        if (!name) {
          alert("Select a profile to delete.");
          return;
        }
        if (!confirm('Delete profile "' + name + '"? This cannot be undone.'))
          return;
        const profiles = getProfiles();
        delete profiles[name];
        setProfiles(profiles);
        if (activeProfile === name) {
          activeProfile = null;
          localStorage.removeItem(ACTIVE_KEY);
        }
        loadProfileList();
        showToast("Deleted: " + name);
      }

      function showToast(msg) {
        let toast = document.getElementById("cv-toast");
        if (!toast) {
          toast = document.createElement("div");
          toast.id = "cv-toast";
          toast.style.cssText =
            "position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#22c55e;color:#fff;padding:8px 20px;border-radius:8px;font-size:12px;font-weight:600;z-index:9999;opacity:0;transition:opacity 0.3s;pointer-events:none;font-family:inherit;";
          document.body.appendChild(toast);
        }
        toast.textContent = msg;
        toast.style.opacity = "1";
        setTimeout(() => {
          toast.style.opacity = "0";
        }, 2000);
      }

      function resetToDefault() {
        if (!confirm("Reset to default CV data? All changes will be lost."))
          return;
        cv = JSON.parse(JSON.stringify(DEFAULT_CV));
        localStorage.removeItem("cv-editor-data");
        renderEditor();
        renderPreview();
      }

      function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: "mm", format: "a4" });
        const W = 210,
          H = 297;
        const s = lastAutoFitState || {
          padV: 10,
          padH: 14,
          nameSize: 15,
          contactSize: 7.5,
          contactMargin: 6,
          sectionTitleSize: 9.5,
          companySize: 8.5,
          roleSize: 8,
          bodySize: 7.5,
          sectionGap: 5,
          companyGap: 3,
          bulletGap: 0.5,
          lineHeight: 1.35,
        };
        const left = s.padH;
        const cW = W - 2 * s.padH;
        let y = s.padV;
        const ptToMm = 0.353;
        const lh = (sz) => sz * ptToMm * s.lineHeight;

        // NAME
        doc.setFont("helvetica", "bold");
        doc.setFontSize(s.nameSize);
        y += s.nameSize * ptToMm;
        doc.text(cv.name, W / 2, y, { align: "center" });
        y += 2;

        // CONTACT
        doc.setFont("helvetica", "normal");
        doc.setFontSize(s.contactSize);
        doc.setTextColor(85, 85, 85);
        y += s.contactSize * ptToMm;
        doc.text(cv.contact, W / 2, y, { align: "center" });
        y += s.contactMargin * ptToMm + 2;
        doc.setTextColor(0, 0, 0);

        // SECTIONS
        cv.sections.forEach((sec) => {
          if (sec.hidden) return;

          // Section title
          y += s.sectionGap * ptToMm;
          doc.setFont("helvetica", "bold");
          doc.setFontSize(s.sectionTitleSize);
          y += s.sectionTitleSize * ptToMm;
          doc.text(sec.title.toUpperCase(), left, y);
          y += 0.5;
          doc.setLineWidth(0.2);
          doc.line(left, y, W - s.padH, y);
          y += 2;

          if (sec.type === "summary") {
            doc.setFont("helvetica", "normal");
            doc.setFontSize(s.bodySize);
            const lines = doc.splitTextToSize(sec.content, cW);
            const lineH = lh(s.bodySize);
            lines.forEach((line) => {
              y += lineH;
              doc.text(line, left, y);
            });
            y += 1;
          } else if (sec.type === "jobs") {
            sec.jobs.forEach((job) => {
              if (job.hidden) return;
              // Company
              y += s.companyGap * ptToMm;
              doc.setFont("helvetica", "bold");
              doc.setFontSize(s.companySize);
              y += s.companySize * ptToMm;
              doc.text(job.company, left, y);
              // Role
              doc.setFont("helvetica", "bolditalic");
              doc.setFontSize(s.roleSize);
              doc.setTextColor(51, 51, 51);
              y += s.roleSize * ptToMm;
              doc.text(job.role, left, y);
              doc.setTextColor(0, 0, 0);
              y += 0.5;
              // Bullets
              doc.setFont("helvetica", "normal");
              doc.setFontSize(s.bodySize);
              const lineH = lh(s.bodySize);
              job.bullets.forEach((b, bi) => {
                if ((job.hiddenBullets || []).includes(bi)) return;
                const wrapped = doc.splitTextToSize("- " + b, cW - 5);
                wrapped.forEach((line, li) => {
                  y += lineH;
                  doc.text(line, left + (li === 0 ? 0 : 3), y);
                });
                y += s.bulletGap * ptToMm;
              });
            });
          } else if (sec.type === "education") {
            sec.schools.forEach((sch) => {
              if (sch.hidden) return;
              y += s.companyGap * ptToMm;
              doc.setFont("helvetica", "bold");
              doc.setFontSize(s.companySize);
              y += s.companySize * ptToMm;
              doc.text(sch.institution, left, y);
              doc.setFont("helvetica", "bolditalic");
              doc.setFontSize(s.roleSize);
              doc.setTextColor(51, 51, 51);
              y += s.roleSize * ptToMm;
              doc.text(sch.degree, left, y);
              doc.setTextColor(0, 0, 0);
              y += 0.5;
              doc.setFont("helvetica", "normal");
              doc.setFontSize(s.bodySize);
              const lineH = lh(s.bodySize);
              (sch.details || []).forEach((d, di) => {
                if ((sch.hiddenDetails || []).includes(di)) return;
                const wrapped = doc.splitTextToSize("- " + d, cW - 5);
                wrapped.forEach((line, li) => {
                  y += lineH;
                  doc.text(line, left + (li === 0 ? 0 : 3), y);
                });
                y += s.bulletGap * ptToMm;
              });
            });
          } else if (sec.type === "leadership") {
            doc.setFont("helvetica", "normal");
            doc.setFontSize(s.bodySize);
            const lineH = lh(s.bodySize);
            sec.items.forEach((item) => {
              if (item.hidden) return;
              const text = item.name + " \u2014 " + item.desc;
              const wrapped = doc.splitTextToSize(text, cW);
              wrapped.forEach((line) => {
                y += lineH;
                doc.text(line, left, y);
              });
              y += s.bulletGap * ptToMm;
            });
          } else if (sec.type === "skills") {
            doc.setFontSize(s.bodySize);
            const lineH = lh(s.bodySize);
            sec.skills.forEach((sk) => {
              if (sk.hidden) return;
              doc.setFont("helvetica", "bold");
              const labelW = doc.getTextWidth(sk.label + " ");
              doc.text(sk.label, left, y + lineH);
              doc.setFont("helvetica", "normal");
              const valLines = doc.splitTextToSize(" " + sk.value, cW - labelW);
              doc.text(valLines[0], left + labelW, y + lineH);
              y += lineH;
              for (let i = 1; i < valLines.length; i++) {
                y += lineH;
                doc.text(valLines[i], left, y);
              }
              y += s.bulletGap * ptToMm;
            });
          }
        });

        const filename = (activeProfile || "cv-draft") + ".pdf";
        doc.save(filename);
        showToast("PDF exported: " + filename);
      }

      /* â•â•â• PROFILE EXPORT / IMPORT â•â•â• */
      function exportProfiles() {
        const profiles = getProfiles();
        const keys = Object.keys(profiles);
        if (keys.length === 0) {
          alert("No saved profiles to export.");
          return;
        }
        const blob = new Blob([JSON.stringify(profiles, null, 2)], {
          type: "application/json",
        });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "cv-profiles-backup.json";
        a.click();
        URL.revokeObjectURL(a.href);
        showToast("Exported " + keys.length + " profile(s)");
      }

      function importProfiles() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".json";
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (ev) => {
            try {
              const imported = JSON.parse(ev.target.result);
              if (typeof imported !== "object" || Array.isArray(imported))
                throw new Error("Bad format");
              const existing = getProfiles();
              let count = 0;
              for (const [name, data] of Object.entries(imported)) {
                if (existing[name]) {
                  if (
                    !confirm(
                      'Profile "' + name + '" already exists. Overwrite?',
                    )
                  )
                    continue;
                }
                existing[name] = data;
                count++;
              }
              setProfiles(existing);
              loadProfileList();
              showToast("Imported " + count + " profile(s)");
            } catch (err) {
              alert("Invalid file: " + err.message);
            }
          };
          reader.readAsText(file);
        };
        input.click();
      }

      // Keyboard shortcut: Cmd+S to save current profile
      document.addEventListener("keydown", (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === "s") {
          e.preventDefault();
          saveCurrentProfile();
        }
      });

      // Start
      init();

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // AI CHAT ASSISTANT
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      let aiConnected = false;
      let aiProvider = "ollama";
      let aiApiKey = "";
      let chatHistory = []; // {role, content}
      let chatAttachments = []; // {name, text}
      let aiStreaming = false;
      let pendingChanges = []; // diff suggestions
      let premiumThinking = false; // reasoning mode toggle
      let ollamaModel = ""; // selected Ollama model

      // Dual-model system: CHAT model (fast) for conversation, EDIT model (best) for CV changes
      const AI_CHAT_MODELS = {
        openai: "gpt-4o-mini",
        gemini: "gemini-2.5-flash",
        claude: "claude-sonnet-4-20250514",
        groq: "llama-3.3-70b-versatile",
        openrouter: "meta-llama/llama-3.3-70b-instruct:free",
        cerebras: "llama-3.3-70b",
        ollama: "auto", // resolved at runtime from ollamaModel
      };

      const AI_EDIT_MODELS = {
        openai: "gpt-4o",
        gemini: "gemini-2.5-pro",
        claude: "claude-opus-4-20250514",
        groq: "llama-3.3-70b-versatile",
        openrouter: "meta-llama/llama-3.3-70b-instruct:free",
        cerebras: "llama-3.3-70b",
        ollama: "auto",
      };

      // ğŸ§  Premium Thinking: reasoning/extended thinking models
      const AI_THINKING_MODELS = {
        openai: "o3",
        gemini: "gemini-2.5-pro", // same model, but with thinkingConfig
        claude: "claude-opus-4-20250514", // same model, but with extended thinking
        groq: "deepseek-r1-distill-llama-70b",
        openrouter: "deepseek/deepseek-r1:free",
        cerebras: "llama-3.3-70b", // no reasoning model on cerebras
        ollama: "auto",
      };

      const AI_MODEL_LABELS = {
        openai: {
          chat: "GPT-4o Mini",
          edit: "GPT-4o",
          thinking: "o3 (reasoning)",
        },
        gemini: {
          chat: "Gemini 2.5 Flash",
          edit: "Gemini 2.5 Pro",
          thinking: "Gemini 2.5 Pro (deep think)",
        },
        claude: {
          chat: "Sonnet 4",
          edit: "Opus 4",
          thinking: "Opus 4 (extended thinking)",
        },
        groq: {
          chat: "Llama 3.3 70B",
          edit: "Llama 3.3 70B",
          thinking: "DeepSeek R1 70B",
        },
        openrouter: {
          chat: "Llama 3.3 70B",
          edit: "Llama 3.3 70B",
          thinking: "DeepSeek R1 (free)",
        },
        cerebras: {
          chat: "Llama 3.3 70B",
          edit: "Llama 3.3 70B",
          thinking: "Llama 3.3 70B",
        },
        ollama: {
          chat: "Local Model",
          edit: "Local Model",
          thinking: "Local Model",
        },
      };

      const AI_ENDPOINTS = {
        openai: "https://api.openai.com/v1/chat/completions",
        gemini: null, // special handling
        claude: "https://api.anthropic.com/v1/messages",
        groq: "https://api.groq.com/openai/v1/chat/completions",
        openrouter: "https://openrouter.ai/api/v1/chat/completions",
        cerebras: "https://api.cerebras.ai/v1/chat/completions",
        ollama: "http://localhost:11434/v1/chat/completions",
      };

      // â•â•â• OLLAMA MODEL DETECTION â•â•â•
      // Ranked preference for Ollama models (best first)
      const OLLAMA_MODEL_RANK = [
        "qwen2.5:72b",
        "llama3.3:70b",
        "deepseek-r1:70b",
        "qwen3:72b",
        "deepseek-r1:32b",
        "qwen2.5:32b",
        "qwen3:32b",
        "llama3.1:70b",
        "deepseek-r1:14b",
        "qwen2.5:14b",
        "phi4:14b",
        "gemma2:27b",
        "mistral-small:22b",
        "qwen2.5:7b",
        "llama3.1:8b",
        "gemma2:9b",
        "phi3:14b",
        "llama3.2:3b",
        "qwen2.5:3b",
        "phi3:3.8b",
      ];

      async function detectOllamaModels() {
        const sel = document.getElementById("ollama-model-select");
        const status = document.getElementById("ollama-status");
        status.textContent = "ğŸ”„ Detecting...";
        status.style.color = "#f59e0b";
        try {
          const resp = await fetch("http://localhost:11434/api/tags", {
            signal: AbortSignal.timeout(3000),
          });
          if (!resp.ok) throw new Error("Ollama not responding");
          const data = await resp.json();
          const models = (data.models || []).map((m) => m.name);
          if (models.length === 0) {
            status.textContent =
              "âš ï¸ No models installed. Run: ollama pull qwen2.5:32b";
            status.style.color = "#ef4444";
            return;
          }
          // Sort by preference rank
          models.sort((a, b) => {
            const aR = OLLAMA_MODEL_RANK.findIndex((r) => a.startsWith(r));
            const bR = OLLAMA_MODEL_RANK.findIndex((r) => b.startsWith(r));
            return (aR === -1 ? 999 : aR) - (bR === -1 ? 999 : bR);
          });
          sel.innerHTML = "";
          models.forEach((m) => {
            const opt = document.createElement("option");
            opt.value = m;
            const sizeTag = m.includes(":")
              ? m.split(":")[1].toUpperCase()
              : "";
            const isReasoning =
              m.includes("deepseek-r1") || m.includes("qwen3");
            opt.textContent = m + (isReasoning ? " ğŸ§ " : "");
            sel.appendChild(opt);
          });
          ollamaModel = models[0];
          sel.value = ollamaModel;
          sel.onchange = () => {
            ollamaModel = sel.value;
          };
          // Update labels
          const shortName = ollamaModel.split(":")[0];
          AI_MODEL_LABELS.ollama = {
            chat: shortName,
            edit: shortName,
            thinking: shortName + " ğŸ§ ",
          };
          status.textContent =
            "âœ… Found " + models.length + " model(s) â€” best: " + ollamaModel;
          status.style.color = "#22c55e";
        } catch (e) {
          status.innerHTML =
            "âŒ Ollama not running. Start it: <code>ollama serve</code>";
          status.style.color = "#ef4444";
        }
      }

      // Detect if message needs CV editing (uses EDIT model) vs general chat
      function needsEditModel(userMsg) {
        const editKeywords =
          /tailor|change|edit|improve|modify|update|rewrite|rephrase|optimize|fix|replace|adjust|bullet|summary|job description|JD|role|position|application|hired|ATS/i;
        return editKeywords.test(userMsg);
      }

      function toggleChatPanel() {
        const p = document.getElementById("chat-panel");
        const b = document.getElementById("toggle-chat-btn");
        p.classList.toggle("collapsed");
        b.style.display = p.classList.contains("collapsed") ? "" : "none";
      }

      function onProviderChange() {
        aiProvider = document.getElementById("ai-provider").value;
        aiConnected = false;
        updateAIStatus("disconnected", "â— Not connected");
        onThinkingToggle(); // update label
        // Show/hide Ollama model selector and API key
        const isOllama = aiProvider === "ollama";
        document.getElementById("ollama-model-row").style.display = isOllama
          ? ""
          : "none";
        document.getElementById("api-key-row").style.display = isOllama
          ? "none"
          : "";
      }

      function onThinkingToggle() {
        premiumThinking = document.getElementById(
          "ai-premium-thinking",
        ).checked;
        const label = document.getElementById("thinking-label");
        if (premiumThinking) {
          const modelName = AI_MODEL_LABELS[aiProvider].thinking;
          label.textContent = "ON â€” " + modelName;
          label.style.color = "#f59e0b";
        } else {
          label.textContent = "Off â€” faster responses";
          label.style.color = "var(--muted)";
        }
      }

      function updateAIStatus(cls, text) {
        const el = document.getElementById("ai-status");
        el.className = "connect-status " + cls;
        el.textContent = text;
      }

      function connectAI() {
        const keyInput = document.getElementById("ai-api-key");
        aiProvider = document.getElementById("ai-provider").value;

        if (aiProvider === "ollama") {
          // Ollama: no API key needed, check model selected
          aiApiKey = "ollama"; // placeholder
          if (!ollamaModel) {
            updateAIStatus("error", "â— Click 'Detect' to find models first");
            return;
          }
          // Resolve "auto" model references
          AI_CHAT_MODELS.ollama = ollamaModel;
          AI_EDIT_MODELS.ollama = ollamaModel;
          AI_THINKING_MODELS.ollama = ollamaModel;
          const shortName = ollamaModel.split(":")[0];
          AI_MODEL_LABELS.ollama = {
            chat: shortName,
            edit: shortName,
            thinking: shortName + " ğŸ§ ",
          };
        } else {
          aiApiKey = keyInput.value.trim();
          if (!aiApiKey) {
            updateAIStatus("error", "â— Enter an API key");
            return;
          }
        }

        aiConnected = true;
        var labels = AI_MODEL_LABELS[aiProvider];
        var statusText = "â— Connected";
        if (aiProvider === "ollama") {
          statusText += " â€” ğŸ  " + ollamaModel;
        } else if (labels.chat === labels.edit) {
          statusText += " â€” " + labels.edit;
        } else {
          statusText += " â€” Chat: " + labels.chat + " | Edit: " + labels.edit;
        }
        updateAIStatus("connected", statusText);
        document.getElementById("chat-send-btn").disabled = false;
        // Clear chat & send greeting
        chatHistory = [];
        const msgs = document.getElementById("chat-messages");
        msgs.innerHTML = "";
        appendChatMsg(
          "assistant",
          "Hi TomÃ¡s! ğŸ‘‹ I can see your active CV. What would you like to change? You can:\n\nâ€¢ Paste a job description to tailor your CV\nâ€¢ Ask me to improve specific bullets\nâ€¢ Attach context documents\nâ€¢ Request formatting changes\n\nWhat would you like to do?",
        );
      }

      function appendChatMsg(role, text, extraHTML) {
        const msgs = document.getElementById("chat-messages");
        const div = document.createElement("div");
        div.className = "chat-msg " + role;
        // Simple markdown-ish rendering
        let html = escapeHtml(text)
          .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
          .replace(/`(.+?)`/g, "<code>$1</code>")
          .replace(/\n/g, "<br>");
        div.innerHTML = html + (extraHTML || "");
        msgs.appendChild(div);
        msgs.scrollTop = msgs.scrollHeight;
        return div;
      }

      function escapeHtml(t) {
        return t
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      function autoGrow(el) {
        el.style.height = "36px";
        el.style.height = Math.min(el.scrollHeight, 120) + "px";
      }

      // â•â•â• ATTACHMENTS â•â•â•
      function handleAttachment(input) {
        Array.from(input.files).forEach(function (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const text = e.target.result;
            chatAttachments.push({
              name: file.name,
              text: text.substring(0, 15000),
            });
            renderAttachments();
          };
          reader.readAsText(file);
        });
        input.value = "";
      }

      function renderAttachments() {
        const el = document.getElementById("chat-attachments");
        el.innerHTML = chatAttachments
          .map(function (a, i) {
            return (
              '<span class="chat-attachment-tag">ğŸ“„ ' +
              escapeHtml(a.name) +
              ' <span class="remove-att" onclick="removeAttachment(' +
              i +
              ')">âœ•</span></span>'
            );
          })
          .join("");
      }

      function removeAttachment(i) {
        chatAttachments.splice(i, 1);
        renderAttachments();
      }

      // â•â•â• BUILD CV CONTEXT FOR AI â•â•â•
      function buildCVContext() {
        let ctx =
          "CURRENT CV DATA (JSON):\n```json\n" +
          JSON.stringify(cv, null, 2) +
          "\n```\n\n";
        ctx += "ACTIVE PROFILE: " + (activeProfile || "Unsaved Draft") + "\n";
        if (chatAttachments.length > 0) {
          ctx += "\nATTACHED DOCUMENTS:\n";
          chatAttachments.forEach(function (a) {
            ctx += "--- " + a.name + " ---\n" + a.text + "\n--- END ---\n\n";
          });
        }
        return ctx;
      }

      function buildSystemPrompt() {
        const isPremium =
          document.getElementById("ai-thinking-toggle")?.checked;
        return (
          `You are a world-class executive CV strategist â€” the absolute best in the industry. You are not a generic assistant. You are THE expert that Fortune 500 executives pay $5,000/hour to optimize their resumes. You have access to TomÃ¡s Batalha's full CV data below.

YOUR MISSION: Deliver suggestions so precise, so strategically brilliant, that every single change measurably increases interview callback rates. Do NOT give generic advice. Every suggestion must be surgical, evidence-based, and immediately actionable.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SUGGESTION FORMAT (MANDATORY)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
When suggesting changes, ALWAYS use this exact JSON format wrapped in a code block:
\`\`\`json:changes
[
  {
    "path": "sections[0].content",
    "label": "Professional Summary",
    "before": "exact current text",
    "after": "suggested new text"
  }
]
\`\`\`

Path format:
- "sections[0].content" â†’ professional summary text
- "sections[1].jobs[0].bullets[2]" â†’ specific bullet point
- "sections[1].jobs[0].role" â†’ job title
- "sections[1].jobs[0].company" â†’ company name
- "name" â†’ candidate name field
- "title" â†’ headline/title field

CRITICAL: The "before" field MUST be a character-perfect match of the current CV text. Copy it exactly â€” including punctuation, spacing, and symbols.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
QUALITY STANDARDS (NON-NEGOTIABLE)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. QUANTIFICATION IS SACRED
   - NEVER remove numbers, metrics, percentages, or dollar amounts
   - ALWAYS preserve or enhance quantified achievements
   - If a bullet lacks metrics, suggest adding them with a note asking the user to confirm the numbers
   - Good: "Drove $2.4M pipeline through strategic outbound campaigns across 3 verticals"
   - Bad: "Drove significant pipeline through outbound campaigns"

2. ACTION VERB MASTERY
   - First word of every bullet MUST be a powerful, varied action verb
   - NEVER repeat the same verb within a section. Track verb usage across all bullets.
   - Tier 1 (leadership): Spearheaded, Orchestrated, Championed, Pioneered, Architected
   - Tier 2 (execution): Engineered, Accelerated, Negotiated, Captured, Mobilized
   - Tier 3 (results): Delivered, Generated, Secured, Converted, Exceeded
   - FORBIDDEN generic verbs: Helped, Worked on, Was responsible for, Assisted, Participated

3. STAR METHOD ENFORCEMENT
   - Every bullet should follow: [Action Verb] + [What You Did] + [How/Method] + [Quantified Result]
   - Weak: "Managed sales team that hit targets"
   - Strong: "Scaled 8-person outbound sales team to 140% of quarterly quota ($1.2M) by implementing structured discovery frameworks and weekly pipeline reviews"

4. ATS OPTIMIZATION
   - When a job description is provided, extract the TOP 15 keywords and key phrases
   - Map each keyword to where it can be naturally woven into the CV
   - Prioritize: exact keyword matches > semantic matches > implied skills
   - Never keyword-stuff â€” every keyword must read naturally in context
   - Flag any critical JD requirements that the CV doesn't currently address

5. STRATEGIC POSITIONING
   - Tailor the professional summary to mirror the target role's language and priorities
   - Lead with the most relevant experience for the specific role
   - Frame startup experience as enterprise-relevant (scrappy â†’ resourceful, wore many hats â†’ cross-functional leadership)
   - Position Google/Amazon experience prominently for credibility halo effect

6. CONCISION & IMPACT
   - Maximum 2 lines per bullet point (aim for 1.5 lines when printed)
   - Cut filler words ruthlessly: "in order to" â†’ "to", "was able to" â†’ delete, "responsible for" â†’ [action verb]
   - Every word must earn its place. If removing a word doesn't change the meaning, remove it.

7. CONSISTENCY & POLISH
   - Maintain consistent tense: past tense for previous roles, present for current
   - Consistent formatting: all bullets start with verb, all end without period, or all with period
   - No orphan bullets â€” each job should have 3-5 impactful bullets
   - Check for repeated phrases across the entire CV, not just within sections

${
  isPremium
    ? `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ§  PREMIUM THINKING MODE ACTIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
You are operating in DEEP ANALYSIS mode with extended reasoning. Take your time.

BEFORE suggesting any changes:
1. ANALYZE the full CV holistically â€” identify the narrative arc and positioning strategy
2. COMPARE against best-in-class CVs for the target role level and industry
3. IDENTIFY the 3 biggest weaknesses and the 3 strongest assets
4. THINK about what a hiring manager at this specific company would scan for in the first 6 seconds
5. CONSIDER ATS parsing â€” will the format and keywords survive automated screening?
6. EVALUATE competitive positioning â€” how does this CV differentiate from 200+ other applicants?

Then deliver your suggestions ranked by IMPACT (highest impact first).
For each suggestion, briefly explain WHY this change matters and what signal it sends to the hiring manager.

Your suggestions should be so good that a professional CV writer would be impressed.
`
    : ""
}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
INTERACTION STYLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- Always show a brief strategic explanation BEFORE the changes block
- Group related changes together (e.g., "Summary Alignment" or "Bullet Impact Boost")
- If the user pastes a job description, lead with a KEYWORD ANALYSIS table before suggesting changes
- Be direct and confident. No hedging. No "you might consider..." â€” say "Change this to X because Y."
- If a suggestion requires user input (e.g., confirming a metric), flag it clearly with [CONFIRM: ...]

` + buildCVContext()
        );
      }

      // â•â•â• SEND MESSAGE â•â•â•
      async function sendMessage() {
        if (!aiConnected || aiStreaming) return;
        const input = document.getElementById("chat-input");
        const text = input.value.trim();
        if (!text) return;
        input.value = "";
        input.style.height = "36px";

        appendChatMsg("user", text);
        chatHistory.push({ role: "user", content: text });

        aiStreaming = true;
        document.getElementById("chat-send-btn").disabled = true;

        // Determine which model to use
        const useEditModel = needsEditModel(text);
        let modelType;
        if (premiumThinking) {
          modelType = "thinking";
        } else if (useEditModel) {
          modelType = "edit";
        } else {
          modelType = "chat";
        }
        const modelLabel = AI_MODEL_LABELS[aiProvider][modelType];
        const modeTag =
          modelType === "thinking"
            ? " ğŸ§  deep reasoning"
            : modelType === "edit"
              ? " (edit mode)"
              : "";
        const thinkingDiv = appendChatMsg(
          "assistant",
          "â³ Thinking with " + modelLabel + modeTag + "...",
        );

        try {
          const response = await callAI(chatHistory, modelType);
          thinkingDiv.remove();

          // Parse response for changes
          const changesMatch = response.match(/```json:changes\n([\s\S]*?)```/);
          let messageText = response;
          let changesHTML = "";

          if (changesMatch) {
            messageText = response
              .replace(/```json:changes\n[\s\S]*?```/, "")
              .trim();
            try {
              pendingChanges = JSON.parse(changesMatch[1]);
              changesHTML = renderDiffBlocks(pendingChanges);
            } catch (e) {
              changesHTML =
                '<div class="chat-msg system">âš ï¸ Could not parse changes</div>';
            }
          }

          appendChatMsg("assistant", messageText, changesHTML);
          chatHistory.push({ role: "assistant", content: response });
        } catch (err) {
          thinkingDiv.remove();
          appendChatMsg("system", "âŒ Error: " + err.message);
        }

        aiStreaming = false;
        document.getElementById("chat-send-btn").disabled = false;
      }

      // â•â•â• RENDER DIFF BLOCKS â•â•â•
      function renderDiffBlocks(changes) {
        if (!changes || !changes.length) return "";
        let html = '<div style="margin-top:8px">';
        changes.forEach(function (c, i) {
          html +=
            '<div class="diff-block">' +
            '<div class="diff-header"><input type="checkbox" checked id="diff-cb-' +
            i +
            '"/> <span>' +
            escapeHtml(c.label || c.path) +
            "</span></div>" +
            '<div class="diff-row before">âˆ’ ' +
            escapeHtml(c.before) +
            "</div>" +
            '<div class="diff-row after">+ ' +
            escapeHtml(c.after) +
            "</div>" +
            "</div>";
        });
        html +=
          '<div class="diff-actions">' +
          '<button class="btn btn-sm btn-primary" onclick="commitChanges()">âœ“ Commit Selected</button>' +
          '<button class="btn btn-sm btn-secondary" onclick="commitAllChanges()">Commit All</button>' +
          '<button class="btn btn-sm btn-secondary" onclick="dismissChanges()">Dismiss</button>' +
          "</div></div>";
        return html;
      }

      // â•â•â• COMMIT CHANGES â•â•â•
      function commitChanges() {
        let applied = 0;
        pendingChanges.forEach(function (c, i) {
          const cb = document.getElementById("diff-cb-" + i);
          if (cb && cb.checked) {
            if (applyChange(c)) applied++;
          }
        });
        pendingChanges = [];
        renderEditor();
        renderPreview();
        autoFit();
        if (activeProfile) saveCurrentProfile(true);
        appendChatMsg(
          "system",
          "âœ… Applied " + applied + " change(s) to your CV.",
        );
      }

      function commitAllChanges() {
        let applied = 0;
        pendingChanges.forEach(function (c) {
          if (applyChange(c)) applied++;
        });
        pendingChanges = [];
        renderEditor();
        renderPreview();
        autoFit();
        if (activeProfile) saveCurrentProfile(true);
        appendChatMsg(
          "system",
          "âœ… Applied " + applied + " change(s) to your CV.",
        );
      }

      function dismissChanges() {
        pendingChanges = [];
        appendChatMsg("system", "Changes dismissed.");
      }

      function applyChange(c) {
        try {
          // Parse path like "sections[1].jobs[0].bullets[2]"
          const parts = c.path.replace(/\[(\d+)\]/g, ".$1").split(".");
          let obj = cv;
          for (let i = 0; i < parts.length - 1; i++) {
            const key = isNaN(parts[i]) ? parts[i] : parseInt(parts[i]);
            obj = obj[key];
            if (obj === undefined) return false;
          }
          const lastKey = isNaN(parts[parts.length - 1])
            ? parts[parts.length - 1]
            : parseInt(parts[parts.length - 1]);
          obj[lastKey] = c.after;
          return true;
        } catch (e) {
          return false;
        }
      }

      // â•â•â• AI API CALLS â•â•â•
      async function callAI(history, modelType) {
        const systemPrompt = buildSystemPrompt();
        let models;
        if (modelType === "thinking") {
          models = AI_THINKING_MODELS;
        } else if (modelType === "edit") {
          models = AI_EDIT_MODELS;
        } else {
          models = AI_CHAT_MODELS;
        }
        const model = models[aiProvider];
        const isThinking = modelType === "thinking";

        if (
          aiProvider === "openai" ||
          aiProvider === "groq" ||
          aiProvider === "openrouter" ||
          aiProvider === "cerebras" ||
          aiProvider === "ollama"
        ) {
          return await callOpenAICompatible(
            systemPrompt,
            history,
            model,
            isThinking,
          );
        } else if (aiProvider === "claude") {
          return await callClaude(systemPrompt, history, model, isThinking);
        } else if (aiProvider === "gemini") {
          return await callGemini(systemPrompt, history, model, isThinking);
        }
        throw new Error("Unknown provider");
      }

      async function callOpenAICompatible(
        systemPrompt,
        history,
        model,
        isThinking,
      ) {
        const endpoint = AI_ENDPOINTS[aiProvider];
        const isO3 = model === "o3";
        const messages = [];
        if (isO3) {
          // o3 uses developer role instead of system
          messages.push({ role: "developer", content: systemPrompt });
        } else {
          messages.push({ role: "system", content: systemPrompt });
        }
        history.forEach(function (m) {
          messages.push({ role: m.role, content: m.content });
        });

        const body = {
          model: model,
          messages: messages,
          max_tokens: isO3 ? 16384 : 4096,
        };
        if (isO3) {
          body.reasoning_effort = "high";
          // o3 doesn't support temperature
        } else {
          body.temperature = 0.7;
        }

        const headers = { "Content-Type": "application/json" };
        if (aiProvider !== "ollama") {
          headers["Authorization"] = "Bearer " + aiApiKey;
        }

        const res = await fetch(endpoint, {
          method: "POST",
          headers: headers,
          body: JSON.stringify(body),
        });
        if (!res.ok) {
          const err = await res.text();
          throw new Error(res.status + ": " + err.substring(0, 200));
        }
        const data = await res.json();
        return data.choices[0].message.content;
      }

      async function callClaude(systemPrompt, history, model, isThinking) {
        const messages = history.map(function (m) {
          return { role: m.role, content: m.content };
        });
        const body = {
          model: model,
          system: systemPrompt,
          messages: messages,
          max_tokens: isThinking ? 16000 : 4096,
        };
        if (isThinking) {
          body.thinking = { type: "enabled", budget_tokens: 10000 };
        }
        const res = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-api-key": aiApiKey,
            "anthropic-version": "2023-06-01",
            "anthropic-dangerous-direct-browser-access": "true",
          },
          body: JSON.stringify(body),
        });
        if (!res.ok) {
          const err = await res.text();
          throw new Error(res.status + ": " + err.substring(0, 200));
        }
        const data = await res.json();
        // With extended thinking, find the text block (skip thinking blocks)
        if (data.content && Array.isArray(data.content)) {
          const textBlock = data.content.find(function (b) {
            return b.type === "text";
          });
          if (textBlock) return textBlock.text;
        }
        return data.content[0].text;
      }

      async function callGemini(systemPrompt, history, model, isThinking) {
        const contents = [];
        contents.push({
          role: "user",
          parts: [
            {
              text:
                systemPrompt +
                "\n\n(System prompt loaded. Respond to user messages below.)",
            },
          ],
        });
        contents.push({ role: "model", parts: [{ text: "Understood." }] });
        history.forEach(function (m) {
          contents.push({
            role: m.role === "user" ? "user" : "model",
            parts: [{ text: m.content }],
          });
        });
        const url =
          "https://generativelanguage.googleapis.com/v1beta/models/" +
          model +
          ":generateContent?key=" +
          aiApiKey;
        const genConfig = { maxOutputTokens: isThinking ? 16384 : 4096 };
        if (isThinking) {
          genConfig.thinkingConfig = { thinkingBudget: 8192 };
        } else {
          genConfig.temperature = 0.7;
        }
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: contents,
            generationConfig: genConfig,
          }),
        });
        if (!res.ok) {
          const err = await res.text();
          throw new Error(res.status + ": " + err.substring(0, 200));
        }
        const data = await res.json();
        // Gemini with thinking returns thought + response parts
        const parts = data.candidates[0].content.parts;
        const textPart =
          parts.find(function (p) {
            return !p.thought;
          }) || parts[parts.length - 1];
        return textPart.text;
      }
    </script>
  </body>
</html>
