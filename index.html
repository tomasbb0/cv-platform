<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TopResume.ai — CV Editor Platform</title>
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%230a0a0a'/%3E%3Crect x='0.5' y='0.5' width='31' height='31' rx='5.5' fill='none' stroke='%23222' stroke-width='1'/%3E%3Ctext x='8' y='22' font-family='system-ui,-apple-system,sans-serif' font-size='16' font-weight='800' fill='%233b82f6'%3Et%3C/text%3E%3Ctext x='18' y='22' font-family='system-ui,-apple-system,sans-serif' font-size='16' font-weight='800' fill='white'%3Er%3C/text%3E%3C/svg%3E"
    />
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <style>
      :root {
        --bg: #0f0f0f;
        --panel: #1a1a1a;
        --border: #2a2a2a;
        --text: #e0e0e0;
        --muted: #888;
        --accent: #3b82f6;
        --accent-hover: #2563eb;
        --danger: #ef4444;
        --success: #22c55e;
        --paper-w: 210mm;
        --paper-h: 297mm;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family:
          "SF Pro Display",
          -apple-system,
          BlinkMacSystemFont,
          "Inter",
          sans-serif;
        background: var(--bg);
        color: var(--text);
        height: 100vh;
        overflow: hidden;
      }

      /* ═══ TOP NAV BAR ═══ */
      .top-nav {
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 48px;
        padding: 0 20px;
        background: #0a0a0a;
        border-bottom: 1px solid var(--border);
        flex-shrink: 0;
        z-index: 100;
      }
      .top-nav .logo {
        display: flex;
        align-items: center;
        gap: 10px;
        text-decoration: none;
      }
      .top-nav .logo-mark {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        background: #0a0a0a;
        border: 1.5px solid #222;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 15px;
        font-weight: 800;
        letter-spacing: -0.5px;
        overflow: hidden;
      }
      .top-nav .logo-mark .t {
        color: var(--accent);
      }
      .top-nav .logo-mark .r {
        color: #fff;
      }
      .top-nav .logo-text {
        font-size: 14px;
        font-weight: 700;
        color: var(--text);
        letter-spacing: -0.3px;
      }
      .top-nav .logo-text span {
        color: var(--accent);
      }
      .top-nav .logo-text .domain {
        color: var(--muted);
        font-weight: 400;
      }
      .top-nav .auth-section {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .top-nav .auth-btn {
        padding: 6px 16px;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: transparent;
        color: var(--text);
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        font-family: inherit;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.15s;
      }
      .top-nav .auth-btn:hover {
        border-color: var(--accent);
        color: #fff;
      }
      .top-nav .auth-btn.primary {
        background: var(--accent);
        border-color: var(--accent);
        color: #fff;
      }
      .top-nav .auth-btn.primary:hover {
        background: var(--accent-hover);
      }
      .top-nav .user-info {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .top-nav .user-avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 1.5px solid var(--border);
      }
      .top-nav .user-name {
        font-size: 12px;
        color: var(--text);
        font-weight: 500;
        max-width: 120px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      /* ═══ LAYOUT ═══ */
      .app-wrapper {
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      .app {
        display: flex;
        flex: 1;
        overflow: hidden;
      }
      /* ═══ RESIZE HANDLES ═══ */
      .resize-handle {
        width: 5px;
        cursor: col-resize;
        background: transparent;
        position: relative;
        flex-shrink: 0;
        z-index: 10;
        transition: background 0.15s;
      }
      .resize-handle:hover,
      .resize-handle.active {
        background: var(--accent);
      }
      .resize-handle::after {
        content: "";
        position: absolute;
        top: 0;
        left: -3px;
        right: -3px;
        bottom: 0;
      }
      /* ═══ CHAT PANEL (far left) ═══ */
      .chat-panel {
        width: 320px;
        min-width: 280px;
        max-width: 400px;
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        background: var(--panel);
        overflow: hidden;
        transition: width 0.2s;
      }
      .chat-panel.collapsed {
        width: 0;
        min-width: 0;
        overflow: hidden;
        border: none;
      }
      .chat-panel.collapsed * {
        display: none;
      }
      .chat-header {
        padding: 10px 14px;
        background: #151515;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
      }
      .chat-header h2 {
        font-size: 13px;
        font-weight: 700;
        flex: 1;
        letter-spacing: 0.3px;
      }
      .chat-header h2 span {
        color: var(--accent);
      }
      .chat-config {
        border-bottom: 1px solid var(--border);
        background: #161616;
        flex-shrink: 0;
      }
      .chat-config summary {
        padding: 8px 14px;
        font-size: 11px;
        font-weight: 600;
        color: var(--muted);
        cursor: pointer;
        list-style: none;
        display: flex;
        align-items: center;
        gap: 6px;
        user-select: none;
      }
      .chat-config summary::-webkit-details-marker {
        display: none;
      }
      .chat-config summary::before {
        content: "▶";
        font-size: 8px;
        transition: transform 0.15s;
      }
      .chat-config[open] summary::before {
        transform: rotate(90deg);
      }
      .chat-config .config-body {
        padding: 0 14px 10px;
      }
      .chat-config label {
        font-size: 10px;
        font-weight: 600;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: block;
        margin-bottom: 4px;
      }
      .chat-config select,
      .chat-config input[type="password"],
      .chat-config input[type="text"] {
        width: 100%;
        padding: 6px 10px;
        background: #222;
        border: 1px solid var(--border);
        border-radius: 5px;
        color: var(--text);
        font-size: 11px;
        font-family: inherit;
        margin-bottom: 6px;
      }
      .chat-config .connect-row {
        display: flex;
        gap: 6px;
        align-items: center;
      }
      .chat-config .connect-status {
        font-size: 10px;
        flex: 1;
      }
      .chat-config .connect-status.connected {
        color: var(--success);
      }
      .chat-config .connect-status.disconnected {
        color: var(--muted);
      }
      .chat-config .connect-status.error {
        color: var(--danger);
      }
      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .chat-msg {
        max-width: 95%;
        padding: 8px 12px;
        border-radius: 10px;
        font-size: 12px;
        line-height: 1.5;
        word-wrap: break-word;
      }
      .chat-msg.assistant {
        background: #1e293b;
        color: #e0e0e0;
        align-self: flex-start;
        border-bottom-left-radius: 2px;
      }
      .chat-msg.user {
        background: var(--accent);
        color: #fff;
        align-self: flex-end;
        border-bottom-right-radius: 2px;
      }
      .chat-msg.system {
        background: transparent;
        color: var(--muted);
        font-size: 10px;
        text-align: center;
        align-self: center;
        font-style: italic;
      }
      .chat-msg code {
        background: rgba(0, 0, 0, 0.3);
        padding: 1px 4px;
        border-radius: 3px;
        font-size: 11px;
      }
      .chat-msg pre {
        background: rgba(0, 0, 0, 0.3);
        padding: 8px;
        border-radius: 6px;
        overflow-x: auto;
        margin: 6px 0;
        font-size: 11px;
      }
      .chat-input-area {
        padding: 10px;
        border-top: 1px solid var(--border);
        background: #151515;
        flex-shrink: 0;
      }
      .chat-input-row {
        display: flex;
        gap: 6px;
        align-items: flex-end;
      }
      .chat-input-row textarea {
        flex: 1;
        resize: none;
        padding: 8px 10px;
        background: #222;
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-size: 12px;
        font-family: inherit;
        min-height: 36px;
        max-height: 120px;
        line-height: 1.4;
      }
      .chat-input-row textarea:focus {
        outline: none;
        border-color: var(--accent);
      }
      .chat-input-row .send-btn {
        background: var(--accent);
        border: none;
        color: #fff;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: background 0.15s;
      }
      .chat-input-row .send-btn:hover {
        background: var(--accent-hover);
      }
      .chat-input-row .send-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      .chat-attach-btn {
        background: none;
        border: 1px solid var(--border);
        color: var(--muted);
        width: 36px;
        height: 36px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.15s;
      }
      .chat-attach-btn:hover {
        color: var(--text);
        border-color: var(--text);
      }
      .chat-attachments {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
        margin-bottom: 6px;
      }
      .chat-attachment-tag {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: #2a2a2a;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 10px;
        color: var(--muted);
      }
      .chat-attachment-tag .remove-att {
        cursor: pointer;
        color: var(--danger);
        font-weight: 700;
      }
      /* ═══ DIFF/COMMIT UI ═══ */
      .diff-block {
        background: #111;
        border: 1px solid var(--border);
        border-radius: 8px;
        margin: 8px 0;
        overflow: hidden;
        font-size: 11px;
      }
      .diff-header {
        padding: 6px 10px;
        background: #1a1a2e;
        color: var(--accent);
        font-weight: 600;
        font-size: 10px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .diff-header input[type="checkbox"] {
        accent-color: var(--accent);
      }
      .diff-row {
        padding: 4px 10px;
        font-family: "SF Mono", "Fira Code", monospace;
      }
      .diff-row.before {
        background: #2d1515;
        color: #f87171;
      }
      .diff-row.after {
        background: #152d15;
        color: #4ade80;
      }
      .diff-actions {
        padding: 8px 10px;
        display: flex;
        gap: 6px;
      }
      /* ═══ INSTRUCTIONS COLLAPSIBLE ═══ */
      .chat-instructions {
        border-top: 1px solid var(--border);
        flex-shrink: 0;
      }
      .chat-instructions summary {
        padding: 8px 14px;
        font-size: 10px;
        font-weight: 600;
        color: var(--muted);
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .chat-instructions .inst-body {
        padding: 8px 14px;
        font-size: 10px;
        color: var(--muted);
        line-height: 1.6;
        max-height: 200px;
        overflow-y: auto;
      }
      .chat-instructions .inst-body h4 {
        color: var(--text);
        margin: 6px 0 2px;
        font-size: 11px;
      }
      .chat-instructions .inst-body code {
        background: #222;
        padding: 1px 4px;
        border-radius: 3px;
      }
      .toggle-chat-btn {
        position: fixed;
        top: 50%;
        left: 0;
        transform: translateY(-50%);
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 0 6px 6px 0;
        padding: 8px 4px;
        font-size: 12px;
        cursor: pointer;
        z-index: 100;
        writing-mode: vertical-rl;
        font-weight: 600;
        font-size: 10px;
        letter-spacing: 0.5px;
      }
      .chat-panel:not(.collapsed) ~ .toggle-chat-btn {
        display: none;
      }
      .editor-panel {
        width: 40%;
        min-width: 350px;
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .preview-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        overflow-y: auto;
        background: #252525;
      }

      /* ═══ TOOLBAR ═══ */
      .toolbar {
        padding: 8px 16px;
        background: var(--panel);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
        flex-wrap: nowrap;
        white-space: nowrap;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      .toolbar h1 {
        font-size: 14px;
        font-weight: 700;
        letter-spacing: 0.5px;
      }
      .toolbar h1 span {
        color: var(--accent);
      }
      .btn {
        padding: 6px 14px;
        border: none;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s;
        font-family: inherit;
      }
      .btn-primary {
        background: var(--accent);
        color: #fff;
      }
      .btn-primary:hover {
        background: var(--accent-hover);
      }
      .btn-secondary {
        background: #333;
        color: var(--text);
      }
      .btn-secondary:hover {
        background: #444;
      }
      .btn-danger {
        background: var(--danger);
        color: #fff;
      }
      .btn-danger:hover {
        background: #dc2626;
      }
      .btn-sm {
        padding: 4px 10px;
        font-size: 10px;
        min-height: 28px;
        box-sizing: border-box;
        border: 1px solid transparent;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        line-height: 1;
      }

      /* ═══ AI INLINE SUGGESTIONS ═══ */
      .ai-suggestion {
        margin: 4px 0 8px 24px;
        padding: 8px 12px;
        background: #3b82f610;
        border: 1px solid #3b82f640;
        border-left: 3px solid #3b82f6;
        border-radius: 6px;
        font-size: 11px;
        line-height: 1.5;
        animation: suggestionSlideIn 0.3s ease;
        position: relative;
      }
      @keyframes suggestionSlideIn {
        from {
          opacity: 0;
          transform: translateY(-8px);
          max-height: 0;
        }
        to {
          opacity: 1;
          transform: translateY(0);
          max-height: 200px;
        }
      }
      .ai-suggestion-label {
        color: #3b82f6;
        font-weight: 700;
        font-size: 9px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .ai-suggestion-text {
        color: #93c5fd;
        font-size: 11px;
        white-space: pre-wrap;
        word-break: break-word;
      }
      .ai-suggestion-before {
        color: #6b7280;
        font-size: 10px;
        text-decoration: line-through;
        margin-bottom: 2px;
        white-space: pre-wrap;
        word-break: break-word;
        max-height: 40px;
        overflow: hidden;
      }
      .ai-suggestion-actions {
        display: flex;
        gap: 6px;
        margin-top: 6px;
      }
      .ai-suggestion-actions button {
        padding: 3px 10px;
        border: none;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
        cursor: pointer;
        font-family: inherit;
        transition: all 0.15s;
      }
      .ai-suggestion-accept {
        background: #22c55e;
        color: #fff;
      }
      .ai-suggestion-accept:hover {
        background: #16a34a;
      }
      .ai-suggestion-reject {
        background: #333;
        color: #999;
      }
      .ai-suggestion-reject:hover {
        background: #444;
        color: #fff;
      }

      /* ═══ STATUS BAR ═══ */
      .status-bar {
        padding: 6px 16px;
        background: #111;
        border-top: 1px solid var(--border);
        font-size: 10px;
        color: var(--muted);
        display: flex;
        justify-content: space-between;
        flex-shrink: 0;
      }
      .fit-indicator {
        font-weight: 700;
      }
      .fit-ok {
        color: var(--success);
      }
      .fit-warn {
        color: #f59e0b;
      }
      .fit-over {
        color: var(--danger);
      }

      /* ═══ EDITOR SECTIONS ═══ */
      .editor-content {
        flex: 1;
        overflow-y: auto;
        padding: 12px;
      }
      .section-block {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 8px;
        margin-bottom: 8px;
        overflow: hidden;
      }
      .section-header {
        padding: 8px 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        user-select: none;
        background: #222;
        border-bottom: 1px solid var(--border);
      }
      .section-header:hover {
        background: #282828;
      }
      .section-title {
        flex: 1;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .section-actions {
        display: flex;
        gap: 4px;
      }
      .section-body {
        padding: 8px 12px;
      }
      .section-body.collapsed {
        display: none;
      }
      .chevron {
        transition: transform 0.2s;
        font-size: 10px;
        color: var(--muted);
      }
      .chevron.open {
        transform: rotate(90deg);
      }

      /* ═══ JOB BLOCKS ═══ */
      .job-block {
        background: #1e1e1e;
        border: 1px solid var(--border);
        border-radius: 6px;
        margin-bottom: 6px;
        padding: 8px 10px;
      }
      .job-header {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 6px;
      }
      .job-header input {
        flex: 1;
        background: transparent;
        border: 1px solid transparent;
        color: var(--text);
        font-size: 11px;
        padding: 4px 6px;
        border-radius: 4px;
        font-family: inherit;
      }
      .job-header input:focus {
        border-color: var(--accent);
        outline: none;
        background: #111;
      }
      .job-header input.company {
        font-weight: 700;
      }
      .job-header input.role {
        font-style: italic;
        color: var(--muted);
      }

      /* ═══ BULLET ITEMS ═══ */
      .bullet-list {
        list-style: none;
      }
      .bullet-item {
        display: flex;
        align-items: flex-start;
        gap: 6px;
        padding: 3px 0;
        border-radius: 4px;
        position: relative;
      }
      .bullet-item:hover {
        background: rgba(255, 255, 255, 0.03);
      }
      .bullet-drag {
        cursor: grab;
        color: var(--muted);
        font-size: 10px;
        padding: 4px 2px;
        flex-shrink: 0;
        user-select: none;
      }
      .bullet-drag:active {
        cursor: grabbing;
      }
      .bullet-text {
        flex: 1;
        background: transparent;
        border: 1px solid transparent;
        color: var(--text);
        font-size: 11px;
        padding: 3px 5px;
        border-radius: 4px;
        font-family: inherit;
        resize: vertical;
        min-height: 22px;
        line-height: 1.4;
      }
      .bullet-text:focus {
        border-color: var(--accent);
        outline: none;
        background: #111;
      }
      .bullet-actions {
        display: flex;
        gap: 2px;
        opacity: 0;
        transition: opacity 0.15s;
        flex-shrink: 0;
      }
      .bullet-item:hover .bullet-actions {
        opacity: 1;
      }
      .icon-btn {
        background: none;
        border: none;
        color: var(--muted);
        cursor: pointer;
        font-size: 12px;
        padding: 2px 4px;
        border-radius: 3px;
        transition: all 0.1s;
      }
      .icon-btn:hover {
        color: var(--text);
        background: #333;
      }
      .icon-btn.delete:hover {
        color: var(--danger);
      }
      .icon-btn.eye {
        opacity: 0.7;
      }
      .icon-btn.eye.hidden-item {
        opacity: 0.3;
      }
      .item-hidden {
        opacity: 0.35;
        text-decoration: line-through;
      }
      .item-hidden input,
      .item-hidden textarea {
        text-decoration: line-through;
        color: var(--muted) !important;
      }
      .section-block.item-hidden > .section-header {
        opacity: 0.4;
      }
      .section-block.item-hidden > .section-header .section-title {
        text-decoration: line-through;
      }
      .job-block.item-hidden {
        opacity: 0.35;
        border-style: dashed;
      }

      /* ═══ SIMPLE FIELDS ═══ */
      .field-row {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 4px;
      }
      .field-label {
        font-size: 10px;
        color: var(--muted);
        font-weight: 600;
        min-width: 60px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
      }
      .field-input {
        flex: 1;
        background: transparent;
        border: 1px solid transparent;
        color: var(--text);
        font-size: 11px;
        padding: 4px 6px;
        border-radius: 4px;
        font-family: inherit;
      }
      .field-input:focus {
        border-color: var(--accent);
        outline: none;
        background: #111;
      }
      textarea.field-input {
        resize: vertical;
        min-height: 40px;
        line-height: 1.4;
        width: 100%;
        display: block;
      }

      /* ═══ LEADERSHIP ITEMS ═══ */
      .leadership-item {
        display: flex;
        align-items: flex-start;
        gap: 6px;
        margin-bottom: 4px;
      }
      .leadership-item input {
        background: transparent;
        border: 1px solid transparent;
        color: var(--text);
        font-size: 11px;
        padding: 3px 5px;
        border-radius: 4px;
        font-family: inherit;
      }
      .leadership-item input:focus {
        border-color: var(--accent);
        outline: none;
        background: #111;
      }
      .leadership-item .name {
        width: 160px;
        font-weight: 700;
      }
      .leadership-item .desc {
        flex: 1;
      }

      /* ═══ SKILLS ═══ */
      .skill-row {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 4px;
      }
      .skill-row input.skill-label {
        width: 120px;
        background: transparent;
        border: 1px solid transparent;
        color: var(--text);
        font-size: 11px;
        padding: 3px 5px;
        border-radius: 4px;
        font-family: inherit;
        font-weight: 700;
      }
      .skill-row input.skill-value {
        flex: 1;
        background: transparent;
        border: 1px solid transparent;
        color: var(--text);
        font-size: 11px;
        padding: 3px 5px;
        border-radius: 4px;
        font-family: inherit;
      }
      .skill-row input:focus {
        border-color: var(--accent);
        outline: none;
        background: #111;
      }

      /* ═══ PREVIEW / PAPER ═══ */
      .preview-toolbar {
        display: none; /* replaced by overlay zoom controls */
      }
      .zoom-controls {
        position: absolute;
        top: 10px;
        left: 10px;
        display: flex;
        gap: 4px;
        align-items: center;
        z-index: 20;
        opacity: 0.6;
        transition: opacity 0.2s;
      }
      .zoom-controls:hover {
        opacity: 1;
      }
      .zoom-btn {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        border: 1px solid var(--border);
        background: var(--panel);
        color: var(--text);
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.1s;
      }
      .zoom-btn:hover {
        background: #333;
      }
      .zoom-pct {
        font-size: 10px;
        color: var(--muted);
        min-width: 32px;
        text-align: center;
      }
      .preview-toolbar .zoom-label {
        font-size: 11px;
        color: var(--muted);
      }
      .zoom-slider {
        width: 100px;
        accent-color: var(--accent);
      }

      .paper-wrapper {
        position: relative;
        flex-shrink: 0;
      }
      .paper {
        width: 210mm;
        height: 297mm;
        background: #fff;
        color: #000;
        padding: 10mm 14mm;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        font-size: 9pt;
        line-height: 1.35;
        overflow: hidden;
        transform-origin: top center;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        position: relative;
      }
      /* ═══ Semantic HTML resets (ATS-friendly) ═══ */
      .paper h1,
      .paper h2,
      .paper h3,
      .paper p,
      .paper ul,
      .paper li {
        margin: 0;
        padding: 0;
        border: 0;
        font-size: inherit;
        font-weight: inherit;
        font-style: inherit;
        color: inherit;
        line-height: inherit;
        list-style: none;
      }
      .paper .cv-name {
        text-align: center;
        font-size: 15pt;
        font-weight: 700;
        margin-bottom: 2px;
      }
      .paper .cv-contact {
        text-align: center;
        font-size: 7.5pt;
        color: #555;
        margin-bottom: 6px;
      }
      .paper .cv-section-title {
        font-size: 9.5pt;
        font-weight: 700;
        border-bottom: 1px solid #000;
        padding-bottom: 1px;
        margin-top: 5px;
        margin-bottom: 3px;
        text-transform: uppercase;
      }
      .paper .cv-summary {
        font-size: 7.5pt;
        margin-bottom: 4px;
        line-height: 1.4;
      }
      .paper .cv-company {
        font-size: 8.5pt;
        font-weight: 700;
        margin-top: 3px;
        position: relative;
      }
      .paper .cv-location {
        position: absolute;
        right: 0;
        font-weight: 400;
        font-size: 7.5pt;
        color: #555;
      }
      .paper .cv-role {
        font-size: 8pt;
        font-style: italic;
        color: #333;
        margin-bottom: 1px;
        position: relative;
      }
      .paper .cv-dates {
        position: absolute;
        right: 0;
        font-style: normal;
        font-size: 7.5pt;
        color: #555;
      }
      .paper .cv-bullet {
        font-size: 7.5pt;
        padding-left: 10px;
        text-indent: -8px;
        margin-left: 8px;
        margin-bottom: 0.5px;
        line-height: 1.35;
      }
      .paper .cv-leadership {
        font-size: 7.5pt;
        margin-top: 3px;
        margin-bottom: 1px;
        line-height: 1.35;
      }
      .paper .cv-leadership strong {
        font-weight: 700;
      }
      .paper .cv-skill {
        font-size: 7.5pt;
        margin-bottom: 1px;
        line-height: 1.35;
      }
      .paper .cv-skill strong {
        font-weight: 700;
      }
      .paper .cv-edu-detail {
        font-size: 7.5pt;
        padding-left: 10px;
        text-indent: -8px;
        margin-left: 8px;
        margin-bottom: 0.5px;
        line-height: 1.35;
      }

      /* Page overflow indicator */
      .overflow-line {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--danger);
        z-index: 10;
        display: none;
      }

      /* ═══ ADD BUTTONS ═══ */
      .add-row {
        display: flex;
        justify-content: center;
        padding: 4px 0;
      }
      .add-btn {
        background: none;
        border: 1px dashed var(--border);
        color: var(--muted);
        font-size: 11px;
        padding: 4px 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s;
        font-family: inherit;
      }
      .add-btn:hover {
        border-color: var(--accent);
        color: var(--accent);
        background: rgba(59, 130, 246, 0.05);
      }

      /* ═══ DRAG AND DROP ═══ */
      .dragging {
        opacity: 0.4;
      }
      .drag-over {
        border-top: 2px solid var(--accent) !important;
      }

      /* ═══ STYLE PANEL ═══ */
      .style-panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 8px;
        margin: 10px 16px;
        max-width: 820px;
        width: calc(100% - 32px);
      }
      .style-panel.collapsed .style-body {
        display: none;
      }
      .style-toggle {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        cursor: pointer;
        font-size: 11px;
        color: var(--muted);
        user-select: none;
      }
      .style-toggle:hover {
        color: var(--text);
      }
      .style-toggle .chevron {
        font-size: 8px;
        transition: transform 0.2s;
      }
      .style-panel:not(.collapsed) .style-toggle .chevron {
        transform: rotate(90deg);
      }
      .style-body {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px 16px;
        padding: 6px 12px 10px;
      }
      @media (max-width: 600px) {
        .style-body {
          grid-template-columns: 1fr;
        }
      }
      .style-row {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .style-row label {
        font-size: 10px;
        color: var(--muted);
        min-width: 75px;
        white-space: nowrap;
      }
      .style-row select,
      .style-row input[type="range"] {
        flex: 1;
        min-width: 0;
      }
      .style-row select {
        background: #222;
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 2px 4px;
        font-size: 10px;
        font-family: inherit;
      }
      .style-row input[type="range"] {
        height: 14px;
        accent-color: var(--accent);
      }
      .style-row .style-val {
        font-size: 9px;
        color: var(--accent);
        min-width: 32px;
        text-align: right;
        font-weight: 600;
      }
      .style-row .auto-btn {
        background: none;
        border: 1px solid var(--border);
        color: var(--muted);
        font-size: 8px;
        padding: 1px 4px;
        border-radius: 3px;
        cursor: pointer;
        font-family: inherit;
        white-space: nowrap;
      }
      .style-row .auto-btn:hover {
        border-color: var(--accent);
        color: var(--accent);
      }
      .style-row .auto-btn.active {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
      }

      /* ═══ MARGIN GUIDES ═══ */
      .margin-guide {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 5;
        display: none;
        transform-origin: top left;
      }
      .margin-guide.visible {
        display: block;
      }
      .margin-guide-inner {
        position: absolute;
        border: 1px dashed rgba(59, 130, 246, 0.25);
        border-radius: 1px;
      }

      /* ═══ PRINT BORDER GUIDE ═══ */
      .print-border {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        z-index: 6;
        display: none;
        border: 2px solid rgba(239, 68, 68, 0.4);
        border-radius: 2px;
      }
      .print-border.visible {
        display: block;
      }

      /* ═══ MODAL / DIALOG ═══ */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
      }
      .modal-overlay.active {
        opacity: 1;
        pointer-events: all;
      }
      .modal {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 28px 32px;
        width: 440px;
        max-width: 90vw;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      }
      .modal h3 {
        font-size: 16px;
        font-weight: 700;
        margin-bottom: 16px;
        color: var(--text);
      }
      .modal-options {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 20px;
      }
      .modal-option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
        border: 1px solid var(--border);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.15s;
        background: transparent;
        color: var(--text);
        font-family: inherit;
        text-align: left;
      }
      .modal-option:hover {
        border-color: var(--accent);
        background: rgba(59, 130, 246, 0.05);
      }
      .modal-option .opt-icon {
        font-size: 22px;
        flex-shrink: 0;
      }
      .modal-option .opt-text {
        flex: 1;
      }
      .modal-option .opt-title {
        font-size: 13px;
        font-weight: 600;
        display: block;
      }
      .modal-option .opt-desc {
        font-size: 11px;
        color: var(--muted);
        display: block;
        margin-top: 2px;
      }
      .modal-close {
        padding: 6px 20px;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: transparent;
        color: var(--muted);
        font-size: 12px;
        cursor: pointer;
        font-family: inherit;
      }
      .modal-close:hover {
        color: var(--text);
        border-color: #555;
      }
      .modal-upload-area {
        border: 2px dashed var(--border);
        border-radius: 8px;
        padding: 24px;
        text-align: center;
        cursor: pointer;
        transition: all 0.15s;
        margin-bottom: 16px;
      }
      .modal-upload-area:hover {
        border-color: var(--accent);
      }
      .modal-upload-area p {
        font-size: 12px;
        color: var(--muted);
        margin-top: 6px;
      }
      .modal-upload-area .upload-icon {
        font-size: 28px;
      }
      .modal-progress {
        margin: 16px 0;
        text-align: center;
      }
      .modal-progress .spinner {
        display: inline-block;
        width: 24px;
        height: 24px;
        border: 2.5px solid var(--border);
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .modal-progress p {
        font-size: 12px;
        color: var(--muted);
        margin-top: 8px;
      }

      /* ═══ PRINT ═══ */
      @page {
        size: A4;
        margin: 0;
      }
      @media print {
        * {
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }
        html,
        body {
          margin: 0 !important;
          padding: 0 !important;
          background: #fff !important;
          width: 210mm !important;
          height: 297mm !important;
          overflow: hidden !important;
        }
        .app {
          display: block !important;
          background: #fff !important;
        }
        .top-nav,
        .chat-panel,
        .editor-panel,
        .preview-toolbar,
        .style-panel,
        .status-bar,
        .toolbar,
        .overflow-line,
        .margin-guide,
        .print-border {
          display: none !important;
        }
        .preview-panel {
          padding: 0 !important;
          background: #fff !important;
          overflow: visible !important;
          display: block !important;
          width: 210mm !important;
          height: 297mm !important;
        }
        .paper-wrapper {
          position: static !important;
          width: 210mm !important;
          height: 297mm !important;
        }
        .paper {
          box-shadow: none !important;
          transform: none !important;
          margin: 0 !important;
          width: 210mm !important;
          height: 297mm !important;
          overflow: hidden !important;
          position: static !important;
        }
      }

      /* ═══ SIGN IN DROPDOWN ═══ */
      .sign-in-wrapper {
        position: relative;
      }
      .sign-in-dropdown {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 6px;
        background: #1e1e1e;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 6px;
        min-width: 220px;
        z-index: 200;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      }
      .sign-in-dropdown.open {
        display: block;
      }
      .sign-in-option {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
        padding: 10px 12px;
        border: none;
        border-radius: 6px;
        background: transparent;
        color: var(--text);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        font-family: inherit;
        transition: background 0.15s;
      }
      .sign-in-option:hover {
        background: #2a2a2a;
      }

      /* ═══ DANGER BUTTON ═══ */
      .btn-danger.btn-sm {
        background: transparent;
        color: #ef4444;
        border: 1px solid #ef444430;
      }
      .btn-danger.btn-sm:hover {
        background: #ef444420;
        border-color: #ef4444;
      }

      /* ═══ ICON BUTTON ═══ */
      .btn-icon {
        padding: 4px;
        min-width: 28px;
        min-height: 28px;
        justify-content: center;
      }
      .btn-icon:disabled {
        opacity: 0.3;
        cursor: default;
      }

      /* ═══ PROFILE DROPDOWN ═══ */
      .profile-dropdown-wrapper {
        position: relative;
      }
      .profile-dropdown-trigger {
        display: flex;
        align-items: center;
        gap: 6px;
        background: #333;
        color: #e0e0e0;
        border: 1px solid #444;
        border-radius: 6px;
        padding: 4px 10px;
        font-size: 11px;
        font-weight: 600;
        font-family: inherit;
        max-width: 220px;
        min-width: 100px;
        min-height: 28px;
        box-sizing: border-box;
        cursor: pointer;
        transition: border-color 0.15s;
      }
      .profile-dropdown-trigger:hover {
        border-color: var(--accent);
      }
      .profile-dropdown-trigger span {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .profile-dropdown-menu {
        display: none;
        position: fixed;
        background: #1e1e1e;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 6px;
        min-width: 200px;
        max-width: 240px;
        z-index: 99999;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        white-space: normal;
      }
      .profile-dropdown-menu.open {
        display: block;
      }
      /* Flyout parent item — has arrow and triggers submenu on hover */
      .profile-flyout-item {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        padding: 7px 10px;
        border: none;
        border-radius: 5px;
        background: transparent;
        color: var(--text);
        font-size: 12px;
        font-weight: 500;
        cursor: default;
        font-family: inherit;
        transition: background 0.1s;
        text-align: left;
        gap: 6px;
      }
      .profile-flyout-item:hover {
        background: #2a2a2a;
      }
      .profile-flyout-item .flyout-arrow {
        font-size: 9px;
        color: var(--muted);
        flex-shrink: 0;
      }
      /* Submenu that appears on hover */
      .profile-flyout-sub {
        display: none;
        position: absolute;
        left: calc(100% - 4px);
        top: -6px;
        padding-left: 8px;
        background: transparent;
        z-index: 99999;
      }
      .profile-flyout-sub-inner {
        background: #1e1e1e;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 6px;
        min-width: 220px;
        max-width: 320px;
        max-height: 350px;
        overflow-y: auto;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      }
      .profile-flyout-item:hover > .profile-flyout-sub {
        display: block;
      }
      .profile-flyout-sub-title {
        font-size: 10px;
        font-weight: 600;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 4px 10px 4px;
      }
      .profile-dropdown-section-title {
        font-size: 10px;
        font-weight: 600;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 6px 10px 4px;
      }
      .profile-dropdown-list {
        max-height: 300px;
        overflow-y: auto;
      }
      .profile-dropdown-item {
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
        padding: 7px 10px;
        border: none;
        border-radius: 5px;
        background: transparent;
        color: var(--text);
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        font-family: inherit;
        transition: background 0.1s;
        text-align: left;
      }
      .profile-dropdown-item:hover {
        background: #2a2a2a;
      }
      .profile-dropdown-item.active {
        background: var(--accent);
        color: #fff;
      }
      .profile-dropdown-item.create-new {
        color: var(--accent);
        font-weight: 600;
      }
      .profile-dropdown-item.create-new:hover {
        background: rgba(59, 130, 246, 0.15);
      }
      .profile-dropdown-divider {
        height: 1px;
        background: var(--border);
        margin: 4px 6px;
      }
      .profile-dropdown-item .tags-hint {
        font-size: 9px;
        color: var(--muted);
        margin-left: auto;
      }

      /* ═══ DASHBOARD OVERLAY ═══ */
      .dashboard-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--bg);
        z-index: 500;
        overflow-y: auto;
        white-space: normal;
        color: var(--text);
      }
      .dashboard-overlay.open {
        display: block;
      }
      .dashboard-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        height: 48px;
        border-bottom: 1px solid var(--border);
        background: #0a0a0a;
        position: sticky;
        top: 0;
        z-index: 510;
        flex-shrink: 0;
        box-sizing: border-box;
      }
      .dashboard-header .logo {
        display: flex;
        align-items: center;
        gap: 10px;
        text-decoration: none;
      }
      .dashboard-header .logo-mark {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        background: #0a0a0a;
        border: 1.5px solid #222;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 15px;
        font-weight: 800;
        letter-spacing: -0.5px;
        overflow: hidden;
      }
      .dashboard-header .logo-mark .t {
        color: var(--accent);
      }
      .dashboard-header .logo-mark .r {
        color: #fff;
      }
      .dashboard-header .logo-text {
        font-size: 14px;
        font-weight: 700;
        color: var(--text);
        letter-spacing: -0.3px;
      }
      .dashboard-header .logo-text span {
        color: var(--accent);
      }
      .dashboard-header .logo-text .domain {
        color: var(--muted);
        font-weight: 400;
      }
      .dashboard-content {
        max-width: 900px;
        margin: 0 auto;
        padding: 32px;
      }
      .dashboard-search {
        display: flex;
        gap: 10px;
        margin-bottom: 24px;
      }
      .dashboard-search input {
        flex: 1;
        padding: 10px 14px;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-size: 14px;
        font-family: inherit;
        outline: none;
      }
      .dashboard-search input:focus {
        border-color: var(--accent);
      }
      .dashboard-tags {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        margin-bottom: 20px;
      }
      .tag-pill {
        padding: 4px 12px;
        border-radius: 20px;
        background: #222;
        border: 1px solid var(--border);
        color: var(--muted);
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s;
      }
      .tag-pill:hover,
      .tag-pill.active {
        background: var(--accent);
        border-color: var(--accent);
        color: #fff;
      }
      .cv-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 16px;
      }
      .cv-card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.15s;
      }
      .cv-card:hover {
        border-color: var(--accent);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      .cv-card-title {
        font-size: 14px;
        font-weight: 700;
        margin-bottom: 6px;
        color: var(--text);
      }
      .cv-card-subtitle {
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 10px;
      }
      .cv-card-tags {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
      }
      .cv-card-tags .tag-pill {
        font-size: 9px;
        padding: 2px 8px;
      }
      .cv-card.new-cv-card {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 8px;
        border-style: dashed;
        color: var(--muted);
        min-height: 100px;
      }
      .cv-card.new-cv-card:hover {
        color: var(--accent);
        border-color: var(--accent);
      }
      .cv-card-context-menu button:hover {
        background: #333 !important;
      }
      .cv-card-menu-btn:hover {
        background: #333 !important;
        color: #fff !important;
      }

      /* ═══ TAG EDITOR MODAL ══ */
      .tag-editor-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 600;
        display: none;
        align-items: center;
        justify-content: center;
      }
      .tag-editor-modal.open {
        display: flex;
      }
      .tag-editor-box {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 24px;
        min-width: 320px;
        max-width: 400px;
      }
      .tag-editor-box h3 {
        font-size: 14px;
        margin-bottom: 12px;
      }
      .tag-editor-box input {
        width: 100%;
        padding: 8px 12px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text);
        font-size: 12px;
        font-family: inherit;
        margin-bottom: 10px;
      }
      .tag-editor-box .existing-tags {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }
      .tag-editor-box .tag-removable {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 3px 8px;
        background: var(--accent);
        color: #fff;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 500;
      }
      .tag-editor-box .tag-removable .remove-tag {
        cursor: pointer;
        opacity: 0.7;
        font-size: 12px;
      }
      .tag-editor-box .tag-removable .remove-tag:hover {
        opacity: 1;
      }

      /* ═══ JOB CONTEXT MODAL ═══ */
      .job-context-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 600;
        display: none;
        align-items: center;
        justify-content: center;
      }
      .job-context-modal.open {
        display: flex;
      }
      .job-context-box {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 24px;
        min-width: 380px;
        max-width: 500px;
        width: 90%;
      }
      .job-context-box h3 {
        font-size: 14px;
        margin-bottom: 4px;
      }
      .job-context-box p {
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 16px;
      }
      .job-context-box label {
        display: block;
        font-size: 11px;
        font-weight: 600;
        color: var(--muted);
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
      }
      .job-context-box input,
      .job-context-box textarea {
        width: 100%;
        padding: 8px 12px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text);
        font-size: 12px;
        font-family: inherit;
        margin-bottom: 12px;
        box-sizing: border-box;
      }
      .job-context-box textarea {
        min-height: 100px;
        resize: vertical;
      }

      /* ═══ DELETE CONFIRM MODAL ═══ */
      .confirm-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 600;
        display: none;
        align-items: center;
        justify-content: center;
      }
      .confirm-modal.open {
        display: flex;
      }
      .confirm-box {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 24px;
        min-width: 320px;
        text-align: center;
      }
      .confirm-box h3 {
        font-size: 14px;
        margin-bottom: 8px;
      }
      .confirm-box p {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 16px;
      }
      .confirm-box .confirm-actions {
        display: flex;
        gap: 8px;
        justify-content: center;
      }

      /* ═══ OLLAMA SETUP STEPPER ═══ */
      .ollama-setup {
        margin-top: 8px;
      }
      .ollama-step {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        margin-bottom: 6px;
        font-size: 10px;
        color: var(--muted);
      }
      .ollama-step .step-icon {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #333;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 8px;
        flex-shrink: 0;
        margin-top: 1px;
      }
      .ollama-step.done .step-icon {
        background: #22c55e;
        color: #fff;
      }
      .ollama-step.active .step-icon {
        background: #f59e0b;
        color: #fff;
      }
      .ollama-step.error .step-icon {
        background: #ef4444;
        color: #fff;
      }
    </style>
  </head>
  <body>
    <!-- ═══ TOP NAV BAR ═══ -->
    <div class="app-wrapper">
      <nav class="top-nav">
        <a
          class="logo"
          href="#"
          onclick="
            showDashboard();
            return false;
          "
          title="Dashboard"
        >
          <div class="logo-mark">
            <span class="t">t</span><span class="r">r</span>
          </div>
          <div class="logo-text">
            top<span>resume</span><span class="domain">.ai</span>
          </div>
        </a>
        <div class="auth-section" id="auth-section">
          <div class="sign-in-wrapper" id="sign-in-wrapper">
            <button
              class="auth-btn primary"
              id="auth-login-btn"
              onclick="toggleSignInMenu()"
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4" />
                <polyline points="10 17 15 12 10 7" />
                <line x1="15" y1="12" x2="3" y2="12" />
              </svg>
              Sign in
            </button>
            <div class="sign-in-dropdown" id="sign-in-dropdown">
              <button class="sign-in-option" onclick="signInWithGoogle()">
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path
                    d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.27-4.74 3.27-8.1z"
                    fill="#4285F4"
                  />
                  <path
                    d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                    fill="#34A853"
                  />
                  <path
                    d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                    fill="#FBBC05"
                  />
                  <path
                    d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                    fill="#EA4335"
                  />
                </svg>
                Continue with Google
              </button>
            </div>
          </div>
          <div class="user-info" id="auth-user-info" style="display: none">
            <img class="user-avatar" id="auth-avatar" src="" alt="" />
            <span class="user-name" id="auth-name"></span>
            <button class="auth-btn" onclick="signOutUser()">Sign out</button>
          </div>
        </div>
      </nav>

      <div class="app">
        <!-- ═══ FAR LEFT: AI CHAT ═══ -->
        <div class="chat-panel" id="chat-panel">
          <div class="chat-header">
            <h2>
              <svg
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                style="vertical-align: -2px; margin-right: 4px"
              >
                <path
                  d="M12 2a4 4 0 0 0-4 4v2H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2h-2V6a4 4 0 0 0-4-4z"
                />
                <circle cx="9" cy="14" r="1" fill="currentColor" />
                <circle cx="15" cy="14" r="1" fill="currentColor" /></svg
              ><span>AI</span> Assistant
            </h2>
            <button
              class="btn btn-sm btn-secondary"
              onclick="toggleChatPanel()"
              title="Hide chat"
            >
              <svg
                width="12"
                height="12"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="18" y1="6" x2="6" y2="18" />
                <line x1="6" y1="6" x2="18" y2="18" />
              </svg>
            </button>
          </div>
          <details class="chat-config" id="chat-config">
            <summary>
              <span id="ai-status-compact"
                ><svg
                  width="12"
                  height="12"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  style="vertical-align: -1px; margin-right: 3px"
                >
                  <circle cx="12" cy="12" r="3" />
                  <path
                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"
                  />
                </svg>
                Setup</span
              >
            </summary>
            <div class="config-body">
              <label>AI Provider</label>
              <select id="ai-provider" onchange="onProviderChange()">
                <option value="ollama" selected>
                  🏠 Local / Ollama — Free, No API Key
                </option>
                <option value="groq">Groq — Free Cloud (Llama 3.3 70B)</option>
                <option value="cerebras">
                  Cerebras — Free Cloud (ultra-fast)
                </option>
                <option value="openrouter">
                  OpenRouter — Free Cloud (multi-model)
                </option>
                <option value="gemini">
                  Google Gemini — Free tier (2.5 Flash/Pro)
                </option>
                <option value="openai">OpenAI — Paid (GPT-4o)</option>
                <option value="claude">
                  Anthropic Claude — Paid (Sonnet/Opus)
                </option>
              </select>
              <a
                id="get-key-link"
                href="https://console.groq.com"
                target="_blank"
                style="
                  font-size: 10px;
                  color: var(--accent);
                  margin-top: 3px;
                  display: block;
                "
                >Get free API key →</a
              >
              <div id="ollama-model-row" style="margin-top: 6px">
                <div class="ollama-setup" id="ollama-setup">
                  <div class="ollama-step" id="ollama-step-1">
                    <div class="step-icon">1</div>
                    <div>Checking if Ollama is installed…</div>
                  </div>
                  <div class="ollama-step" id="ollama-step-2">
                    <div class="step-icon">2</div>
                    <div>Starting Ollama server…</div>
                  </div>
                  <div class="ollama-step" id="ollama-step-3">
                    <div class="step-icon">3</div>
                    <div>Detecting available models…</div>
                  </div>
                  <div class="ollama-step" id="ollama-step-4">
                    <div class="step-icon">4</div>
                    <div>Connecting…</div>
                  </div>
                </div>
                <label style="font-size: 11px; margin-top: 8px; display: block"
                  >Model</label
                >
                <div style="display: flex; gap: 4px; align-items: center">
                  <select
                    id="ollama-model-select"
                    style="
                      flex: 1;
                      font-size: 11px;
                      padding: 4px 6px;
                      background: var(--panel);
                      color: var(--text);
                      border: 1px solid var(--border);
                      border-radius: 4px;
                    "
                  >
                    <option value="">No models detected</option>
                  </select>
                </div>
                <div
                  id="ollama-status"
                  style="font-size: 9px; color: var(--muted); margin-top: 3px"
                ></div>
                <button
                  class="btn btn-sm btn-primary"
                  onclick="startOllamaAutoSetup()"
                  id="ollama-start-btn"
                  style="margin-top: 8px; width: 100%"
                >
                  <svg
                    width="12"
                    height="12"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    style="vertical-align: -1px"
                  >
                    <polygon points="5 3 19 12 5 21 5 3" />
                  </svg>
                  Start Local AI
                </button>
              </div>
              <div id="api-key-row">
                <label>API Key</label>
                <input
                  type="password"
                  id="ai-api-key"
                  placeholder="Paste your API key..."
                />
                <button
                  class="btn btn-sm btn-primary"
                  onclick="connectAI()"
                  style="margin-top: 6px; width: 100%"
                >
                  Connect
                </button>
              </div>
              <span
                class="connect-status disconnected"
                id="ai-status"
                style="display: block; margin-top: 6px; font-size: 10px"
                >● Not connected</span
              >
              <div
                style="
                  margin-top: 8px;
                  display: flex;
                  align-items: center;
                  gap: 8px;
                "
              >
                <label
                  style="
                    display: inline-flex;
                    align-items: center;
                    gap: 5px;
                    cursor: pointer;
                    font-size: 11px;
                    color: var(--text);
                    margin: 0;
                  "
                >
                  <input
                    type="checkbox"
                    id="ai-premium-thinking"
                    onchange="onThinkingToggle()"
                    style="accent-color: #f59e0b; cursor: pointer"
                  />
                  <svg
                    width="13"
                    height="13"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    style="vertical-align: -1px; flex-shrink: 0"
                  >
                    <path
                      d="M12 2a4 4 0 0 1 4 4v1h1a3 3 0 0 1 0 6h-1v1a4 4 0 0 1-8 0v-1H7a3 3 0 0 1 0-6h1V6a4 4 0 0 1 4-4z"
                    />
                  </svg>
                  Premium Thinking
                </label>
                <span
                  id="thinking-label"
                  style="font-size: 9px; color: var(--muted)"
                  >Off — faster responses</span
                >
              </div>
              <div
                style="
                  margin-top: 4px;
                  display: flex;
                  align-items: center;
                  gap: 8px;
                "
              >
                <label
                  style="
                    display: inline-flex;
                    align-items: center;
                    gap: 5px;
                    cursor: pointer;
                    font-size: 11px;
                    color: var(--text);
                    margin: 0;
                  "
                >
                  <input
                    type="checkbox"
                    id="ai-agent-mode"
                    onchange="
                      agentMode = this.checked;
                      document.getElementById('agent-label').textContent = this
                        .checked
                        ? 'ON — auto-applies edits'
                        : 'Off — review before applying';
                      document.getElementById('agent-label').style.color = this
                        .checked
                        ? '#22c55e'
                        : 'var(--muted)';
                    "
                    checked
                    style="accent-color: #22c55e; cursor: pointer"
                  />
                  <svg
                    width="13"
                    height="13"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    style="vertical-align: -1px; flex-shrink: 0"
                  >
                    <path d="M12 20h9" />
                    <path
                      d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"
                    />
                  </svg>
                  Agent Mode
                </label>
                <span id="agent-label" style="font-size: 9px; color: #22c55e"
                  >ON — auto-applies edits</span
                >
              </div>
              <!-- Advanced Model Settings -->
              <details style="margin-top: 8px">
                <summary
                  style="
                    font-size: 10px;
                    color: var(--muted);
                    cursor: pointer;
                    user-select: none;
                  "
                >
                  Advanced Model Settings
                </summary>
                <div
                  style="
                    margin-top: 6px;
                    display: flex;
                    flex-direction: column;
                    gap: 6px;
                  "
                >
                  <div style="display: flex; align-items: center; gap: 6px">
                    <label
                      style="
                        font-size: 10px;
                        color: var(--muted);
                        min-width: 55px;
                        margin: 0;
                      "
                      >Chat:</label
                    >
                    <select
                      id="model-chat"
                      style="
                        flex: 1;
                        font-size: 10px;
                        padding: 3px 6px;
                        background: var(--panel);
                        color: var(--text);
                        border: 1px solid var(--border);
                        border-radius: 4px;
                      "
                      onchange="onCustomModelChange('chat', this.value)"
                    ></select>
                  </div>
                  <div style="display: flex; align-items: center; gap: 6px">
                    <label
                      style="
                        font-size: 10px;
                        color: var(--muted);
                        min-width: 55px;
                        margin: 0;
                      "
                      >Edit:</label
                    >
                    <select
                      id="model-edit"
                      style="
                        flex: 1;
                        font-size: 10px;
                        padding: 3px 6px;
                        background: var(--panel);
                        color: var(--text);
                        border: 1px solid var(--border);
                        border-radius: 4px;
                      "
                      onchange="onCustomModelChange('edit', this.value)"
                    ></select>
                  </div>
                  <div style="display: flex; align-items: center; gap: 6px">
                    <label
                      style="
                        font-size: 10px;
                        color: var(--muted);
                        min-width: 55px;
                        margin: 0;
                      "
                      >Thinking:</label
                    >
                    <select
                      id="model-thinking"
                      style="
                        flex: 1;
                        font-size: 10px;
                        padding: 3px 6px;
                        background: var(--panel);
                        color: var(--text);
                        border: 1px solid var(--border);
                        border-radius: 4px;
                      "
                      onchange="onCustomModelChange('thinking', this.value)"
                    ></select>
                  </div>
                  <div
                    style="
                      font-size: 9px;
                      color: var(--muted);
                      font-style: italic;
                    "
                    id="model-note"
                  >
                    Connect to see available models
                  </div>
                </div>
              </details>
            </div>
          </details>
          <div class="chat-messages" id="chat-messages">
            <div class="chat-msg system">
              Connect an AI provider above to start
            </div>
          </div>
          <div class="chat-input-area">
            <div class="chat-attachments" id="chat-attachments"></div>
            <div class="chat-input-row">
              <button
                class="chat-attach-btn"
                onclick="document.getElementById('chat-file-input').click()"
                title="Attach document"
              >
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"
                  />
                </svg>
              </button>
              <input
                type="file"
                id="chat-file-input"
                accept=".txt,.md,.pdf,.doc,.docx,.json,.csv"
                style="display: none"
                onchange="handleAttachment(this)"
                multiple
              />
              <textarea
                id="chat-input"
                placeholder="Ask the AI to tailor your CV..."
                rows="1"
                onkeydown="
                  if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                  }
                "
                oninput="autoGrow(this)"
              ></textarea>
              <button
                class="send-btn"
                id="chat-send-btn"
                onclick="sendMessage()"
                disabled
              >
                <svg
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                  stroke="none"
                >
                  <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                </svg>
              </button>
            </div>
          </div>
          <details class="chat-instructions">
            <summary>How to get started</summary>
            <div class="inst-body">
              <h4>Local / Ollama (Free, No API Key!)</h4>
              Run AI models locally on your Mac. Zero cost, full privacy.<br />
              1. Install: <code>brew install ollama</code><br />
              2. Start: <code>ollama serve</code><br />
              3. Pull a model: <code>ollama pull qwen2.5:32b</code><br />
              4. Click Detect above, select model, then Connect<br />
              Best: <strong>qwen2.5:32b</strong> (32GB Mac) or
              <strong>deepseek-r1:32b</strong><br />
              <h4>Groq (Free Cloud)</h4>
              Free, no credit card. Go to <code>console.groq.com</code>, create
              API key, paste above.<br />
              <h4>OpenRouter (Free models)</h4>
              Go to <code>openrouter.ai/keys</code>, create key, paste above.<br />
              <h4>Cerebras (Free, ultra-fast)</h4>
              Go to <code>cloud.cerebras.ai</code>, create key, paste above.<br />
              <h4>Google Gemini (Free tier)</h4>
              Go to <code>aistudio.google.com/apikey</code>, create key, paste
              above.<br />
              <h4>OpenAI (Paid)</h4>
              Go to <code>platform.openai.com/api-keys</code>, create key.
              ~$0.005/msg.<br />
              <h4>Anthropic Claude (Paid)</h4>
              Go to <code>console.anthropic.com</code>, create key. ~$0.003/msg.
            </div>
          </details>
        </div>
        <div
          class="resize-handle"
          id="resize-chat"
          data-left="chat-panel"
          data-right="editor-panel"
        ></div>
        <button
          class="toggle-chat-btn"
          id="toggle-chat-btn"
          onclick="toggleChatPanel()"
        >
          <svg
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            style="vertical-align: -2px"
          >
            <path
              d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
            />
          </svg>
          AI Chat
        </button>

        <!-- ═══ CENTER: EDITOR ═══ -->
        <div class="editor-panel" id="editor-panel">
          <div class="toolbar">
            <button
              class="btn btn-sm btn-icon"
              onclick="showDashboard()"
              title="Dashboard"
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                <polyline points="9 22 9 12 15 12 15 22" />
              </svg>
            </button>
            <div class="profile-dropdown-wrapper" id="profile-dropdown-wrapper">
              <button
                class="profile-dropdown-trigger"
                id="profile-dropdown-trigger"
                onclick="toggleProfileDropdown()"
              >
                <span id="profile-dropdown-label">— Unsaved Draft —</span>
                <svg
                  width="10"
                  height="10"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <polyline points="6 9 12 15 18 9" />
                </svg>
              </button>
              <div class="profile-dropdown-menu" id="profile-dropdown-menu">
                <!-- Open Recent → flyout -->
                <div class="profile-flyout-item" id="flyout-open-recent">
                  <svg
                    width="12"
                    height="12"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <circle cx="12" cy="12" r="10" />
                    <polyline points="12 6 12 12 16 14" />
                  </svg>
                  <span style="flex: 1">Open Recent</span>
                  <span class="flyout-arrow">▶</span>
                  <div class="profile-flyout-sub" id="profile-flyout-recent">
                    <div class="profile-flyout-sub-inner">
                      <div class="profile-flyout-sub-title">Recent CVs</div>
                      <div
                        class="profile-dropdown-list"
                        id="profile-dropdown-list"
                      ></div>
                    </div>
                  </div>
                </div>
                <!-- Create New → flyout -->
                <div class="profile-flyout-item" id="flyout-create-new">
                  <svg
                    width="12"
                    height="12"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <line x1="12" y1="5" x2="12" y2="19" />
                    <line x1="5" y1="12" x2="19" y2="12" />
                  </svg>
                  <span style="flex: 1; color: var(--accent); font-weight: 600"
                    >Create New</span
                  >
                  <span class="flyout-arrow">▶</span>
                  <div class="profile-flyout-sub">
                    <div class="profile-flyout-sub-inner">
                      <div class="profile-flyout-sub-title">New CV</div>
                      <button
                        class="profile-dropdown-item create-new"
                        onclick="
                          hideProfileDropdown();
                          showNewCVModal();
                        "
                      >
                        <svg
                          width="12"
                          height="12"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        >
                          <rect
                            x="3"
                            y="3"
                            width="18"
                            height="18"
                            rx="2"
                            ry="2"
                          />
                          <line x1="12" y1="8" x2="12" y2="16" />
                          <line x1="8" y1="12" x2="16" y2="12" />
                        </svg>
                        Blank CV
                      </button>
                      <button
                        class="profile-dropdown-item"
                        onclick="
                          hideProfileDropdown();
                          newCVFromLinkedIn();
                          document
                            .getElementById('new-cv-modal')
                            .classList.add('active');
                        "
                      >
                        <svg
                          width="12"
                          height="12"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        >
                          <path
                            d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-4 0v7h-4v-7a6 6 0 0 1 6-6z"
                          />
                          <rect x="2" y="9" width="4" height="12" />
                          <circle cx="4" cy="4" r="2" />
                        </svg>
                        Convert from LinkedIn
                      </button>
                      <button
                        class="profile-dropdown-item"
                        onclick="
                          hideProfileDropdown();
                          newCVFromDoc();
                          document
                            .getElementById('new-cv-modal')
                            .classList.add('active');
                        "
                      >
                        <svg
                          width="12"
                          height="12"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        >
                          <path
                            d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                          />
                          <polyline points="14 2 14 8 20 8" />
                        </svg>
                        Convert from Documents
                      </button>
                      <button
                        class="profile-dropdown-item"
                        id="replicate-cv-btn"
                        onclick="
                          hideProfileDropdown();
                          replicateActiveCV();
                        "
                        style="display: none"
                      >
                        <svg
                          width="12"
                          height="12"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        >
                          <rect
                            x="9"
                            y="9"
                            width="13"
                            height="13"
                            rx="2"
                            ry="2"
                          />
                          <path
                            d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
                          />
                        </svg>
                        Duplicate Active CV
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- Hidden select for backward compat -->
            <select
              id="profile-select"
              style="display: none"
              onchange="onProfileSelectChange(this.value)"
            ></select>
            <button
              class="btn btn-primary btn-sm"
              onclick="saveCurrentProfile()"
              title="Save (⌘S)"
            >
              <svg
                width="13"
                height="13"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                style="vertical-align: -1px"
              >
                <path
                  d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"
                />
                <polyline points="17 21 17 13 7 13 7 21" />
                <polyline points="7 3 7 8 15 8" />
              </svg>
              Save
            </button>
            <button
              class="btn btn-secondary btn-sm"
              onclick="saveAsProfile()"
              title="Save as new version"
            >
              Save As…
            </button>
            <button
              class="btn btn-danger btn-sm"
              id="delete-profile-btn"
              onclick="confirmDeleteProfile()"
              title="Delete this CV"
            >
              Delete
            </button>
            <span id="profile-indicator" style="display: none"></span>
            <button
              class="btn btn-secondary btn-sm"
              onclick="openTagEditorForActive()"
              title="Edit tags for this CV"
              id="toolbar-tags-btn"
            >
              <svg
                width="12"
                height="12"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                style="vertical-align: -1px"
              >
                <path
                  d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"
                />
                <line x1="7" y1="7" x2="7.01" y2="7" />
              </svg>
              Tags
            </button>
            <button
              class="btn btn-secondary btn-sm"
              onclick="showJobContextModal()"
              title="Set target job for AI tailoring"
              id="toolbar-job-context-btn"
              style="max-width: 200px; overflow: hidden; white-space: nowrap"
            >
              <svg
                width="12"
                height="12"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                style="vertical-align: -1px; flex-shrink: 0"
              >
                <rect x="2" y="7" width="20" height="14" rx="2" ry="2" />
                <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" />
              </svg>
              <span
                id="job-context-label"
                style="
                  overflow: hidden;
                  text-overflow: ellipsis;
                  white-space: nowrap;
                "
                >Job Context</span
              >
            </button>
            <button
              class="btn btn-secondary btn-sm"
              onclick="toggleStylePanel()"
              title="Typography & Layout settings"
            >
              <svg
                width="12"
                height="12"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                style="vertical-align: -1px"
              >
                <line x1="4" y1="21" x2="4" y2="14" />
                <line x1="4" y1="10" x2="4" y2="3" />
                <line x1="12" y1="21" x2="12" y2="12" />
                <line x1="12" y1="8" x2="12" y2="3" />
                <line x1="20" y1="21" x2="20" y2="16" />
                <line x1="20" y1="12" x2="20" y2="3" />
                <line x1="1" y1="14" x2="7" y2="14" />
                <line x1="9" y1="8" x2="15" y2="8" />
                <line x1="17" y1="16" x2="23" y2="16" />
              </svg>
              Layout
            </button>
            <div style="flex: 1"></div>
            <button
              class="btn btn-secondary btn-sm btn-icon"
              onclick="undoCV()"
              title="Undo (⌘Z)"
              id="undo-btn"
              disabled
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polyline points="1 4 1 10 7 10" />
                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" />
              </svg>
            </button>
            <button
              class="btn btn-secondary btn-sm btn-icon"
              onclick="redoCV()"
              title="Redo (⌘⇧Z)"
              id="redo-btn"
              disabled
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polyline points="23 4 23 10 17 10" />
                <path d="M20.49 15a9 9 0 1 1-2.13-9.36L23 10" />
              </svg>
            </button>
            <button class="btn btn-primary btn-sm" onclick="exportPDF()">
              <svg
                width="13"
                height="13"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                style="vertical-align: -1px"
              >
                <path
                  d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                />
                <polyline points="14 2 14 8 20 8" />
                <line x1="16" y1="13" x2="8" y2="13" />
                <line x1="16" y1="17" x2="8" y2="17" />
              </svg>
              PDF
            </button>
            <button class="btn btn-secondary btn-sm" onclick="addSection()">
              + Section
            </button>
          </div>
          <div class="editor-content" id="editor"></div>
          <div class="status-bar">
            <span id="fit-status" class="fit-indicator fit-ok"
              >✓ Fits on 1 page</span
            >
            <span id="scale-info">Scale: 100%</span>
          </div>
        </div>

        <div
          class="resize-handle"
          id="resize-preview"
          data-left="editor-panel"
          data-right="preview-panel"
        ></div>

        <!-- ═══ RIGHT: PREVIEW ═══ -->
        <div class="preview-panel" id="preview-panel">
          <div class="preview-toolbar" style="display: none">
            <span class="zoom-label">Zoom:</span>
            <input
              type="range"
              class="zoom-slider"
              min="20"
              max="200"
              value="100"
              oninput="setZoom(this.value)"
            />
            <span class="zoom-label" id="zoom-val">65%</span>
          </div>

          <!-- Zoom overlay controls -->
          <div class="zoom-controls" id="zoom-controls">
            <button
              class="zoom-btn"
              onclick="setZoom(Math.max(20, zoomLevel - 10))"
              title="Zoom out"
            >
              −
            </button>
            <span class="zoom-pct" id="zoom-pct-label">65%</span>
            <button
              class="zoom-btn"
              onclick="setZoom(Math.min(200, zoomLevel + 10))"
              title="Zoom in"
            >
              +
            </button>
            <button
              class="zoom-btn"
              onclick="autoZoom()"
              title="Fit to view"
              style="font-size: 11px; width: auto; padding: 0 6px"
            >
              Fit
            </button>
          </div>

          <!-- ═══ STYLE CONTROLS ═══ -->
          <div class="style-panel collapsed" id="style-panel">
            <div class="style-toggle" onclick="toggleStylePanel()">
              <span class="chevron">▶</span>
              <span>Typography &amp; Layout</span>
            </div>
            <div class="style-body">
              <!-- Row 1: Body Font -->
              <div class="style-row">
                <label>Body Font</label>
                <select
                  id="style-body-font"
                  onchange="setStyleFont('bodyFont', this.value)"
                >
                  <option
                    value="'Helvetica Neue', Helvetica, Arial, sans-serif"
                  >
                    Helvetica Neue
                  </option>
                  <option value="'Times New Roman', Times, serif">
                    Times New Roman
                  </option>
                  <option value="Garamond, 'EB Garamond', serif">
                    Garamond
                  </option>
                  <option value="Calibri, 'Gill Sans', sans-serif">
                    Calibri
                  </option>
                  <option value="Georgia, serif">Georgia</option>
                  <option value="Cambria, serif">Cambria</option>
                  <option value="Arial, sans-serif">Arial</option>
                  <option value="'Palatino Linotype', Palatino, serif">
                    Palatino
                  </option>
                </select>
              </div>
              <!-- Row 2: Title Font -->
              <div class="style-row">
                <label>Title Font</label>
                <select
                  id="style-title-font"
                  onchange="setStyleFont('titleFont', this.value)"
                >
                  <option
                    value="'Helvetica Neue', Helvetica, Arial, sans-serif"
                  >
                    Helvetica Neue
                  </option>
                  <option value="'Times New Roman', Times, serif">
                    Times New Roman
                  </option>
                  <option value="Garamond, 'EB Garamond', serif">
                    Garamond
                  </option>
                  <option value="Calibri, 'Gill Sans', sans-serif">
                    Calibri
                  </option>
                  <option value="Georgia, serif">Georgia</option>
                  <option value="Cambria, serif">Cambria</option>
                  <option value="Arial, sans-serif">Arial</option>
                  <option value="'Palatino Linotype', Palatino, serif">
                    Palatino
                  </option>
                </select>
              </div>
              <!-- Row 3: Letter Spacing -->
              <div class="style-row">
                <label>Letter Sp.</label>
                <input
                  type="range"
                  min="-50"
                  max="100"
                  value="0"
                  step="5"
                  id="style-letter-spacing"
                  oninput="setStyleVal('letterSpacing', this.value / 100)"
                />
                <span class="style-val" id="style-letter-spacing-val">0px</span>
              </div>
              <!-- Row 3b: Body Font Size -->
              <div class="style-row">
                <label>Body Size</label>
                <input
                  type="range"
                  min="60"
                  max="100"
                  value="75"
                  step="1"
                  id="style-font-size"
                  oninput="setStyleVal('bodySize', this.value / 10)"
                />
                <span class="style-val" id="style-font-size-val">auto</span>
                <button
                  class="auto-btn active"
                  id="btn-auto-fontsize"
                  onclick="toggleAuto('bodySize')"
                >
                  A
                </button>
              </div>
              <!-- Row 3c: Title Font Size -->
              <div class="style-row">
                <label>Title Size</label>
                <input
                  type="range"
                  min="70"
                  max="130"
                  value="95"
                  step="1"
                  id="style-title-size"
                  oninput="setStyleVal('titleSize', this.value / 10)"
                />
                <span class="style-val" id="style-title-size-val">auto</span>
                <button
                  class="auto-btn active"
                  id="btn-auto-titlesize"
                  onclick="toggleAuto('titleSize')"
                >
                  A
                </button>
              </div>
              <!-- Row 4: Paragraph Spacing -->
              <div class="style-row">
                <label>Para. Gap</label>
                <input
                  type="range"
                  min="0"
                  max="30"
                  value="5"
                  step="1"
                  id="style-para-gap"
                  oninput="setStyleVal('bulletGap', this.value / 10)"
                />
                <span class="style-val" id="style-para-gap-val">auto</span>
                <button
                  class="auto-btn active"
                  id="btn-auto-para"
                  onclick="toggleAuto('bulletGap')"
                >
                  A
                </button>
              </div>
              <!-- Row 5: Section Spacing -->
              <div class="style-row">
                <label>Section Gap</label>
                <input
                  type="range"
                  min="20"
                  max="160"
                  value="50"
                  step="5"
                  id="style-section-gap"
                  oninput="setStyleVal('sectionGap', this.value / 10)"
                />
                <span class="style-val" id="style-section-gap-val">auto</span>
                <button
                  class="auto-btn active"
                  id="btn-auto-section"
                  onclick="toggleAuto('sectionGap')"
                >
                  A
                </button>
              </div>
              <!-- Row 6: Margins -->
              <div class="style-row">
                <label>Margins</label>
                <input
                  type="range"
                  min="50"
                  max="200"
                  value="100"
                  step="5"
                  id="style-margins"
                  oninput="setStyleVal('margins', this.value / 10)"
                />
                <span class="style-val" id="style-margins-val">auto</span>
                <button
                  class="auto-btn active"
                  id="btn-auto-margins"
                  onclick="toggleAuto('margins')"
                >
                  A
                </button>
              </div>
              <!-- Row 7: Line Height -->
              <div class="style-row">
                <label>Line Height</label>
                <input
                  type="range"
                  min="110"
                  max="180"
                  value="135"
                  step="5"
                  id="style-line-height"
                  oninput="setStyleVal('lineHeight', this.value / 100)"
                />
                <span class="style-val" id="style-line-height-val">auto</span>
                <button
                  class="auto-btn active"
                  id="btn-auto-lineheight"
                  onclick="toggleAuto('lineHeight')"
                >
                  A
                </button>
              </div>
              <!-- Row 8: Visual guides -->
              <div class="style-row" style="gap: 10px">
                <label style="min-width: auto">Guides</label>
                <label
                  style="
                    font-size: 9px;
                    display: flex;
                    align-items: center;
                    gap: 3px;
                    cursor: pointer;
                    min-width: auto;
                  "
                >
                  <input
                    type="checkbox"
                    id="chk-margins"
                    onchange="toggleGuides('margins')"
                    style="margin: 0"
                  />
                  Margins
                </label>
                <label
                  style="
                    font-size: 9px;
                    display: flex;
                    align-items: center;
                    gap: 3px;
                    cursor: pointer;
                    min-width: auto;
                  "
                >
                  <input
                    type="checkbox"
                    id="chk-printborder"
                    onchange="toggleGuides('printborder')"
                    style="margin: 0"
                  />
                  Print Border
                </label>
              </div>
            </div>
          </div>

          <div class="paper-wrapper">
            <div class="paper" id="paper">
              <!-- Rendered CV goes here -->
              <div class="print-border" id="print-border"></div>
            </div>
            <div class="overflow-line" id="overflow-line"></div>
            <div class="margin-guide" id="margin-guide">
              <div class="margin-guide-inner" id="margin-guide-inner"></div>
            </div>
          </div>
        </div>
      </div>

      <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.3/jspdf.umd.min.js"></script>
      <script>
        // ═══════════════════════════════════════════════════════
        // CV DATA MODEL
        // ═══════════════════════════════════════════════════════
        const DEFAULT_CV = {
          name: "Tomás Maria Burnay Batalha",
          contact:
            "Lisbon, Portugal (Open to Relocation to Dublin) | (+351) 936 124 118 | tomas.b.batalha@gmail.com | linkedin.com/in/tomasmbatalha",
          sections: [
            {
              id: "summary",
              type: "summary",
              title: "PROFESSIONAL SUMMARY",
              content:
                "Former Google intern and startup Co-Founder with full-cycle new business sales experience. Built a €147K B2B pipeline from zero via multi-channel outreach, consultative selling, and enterprise deal closing. Managed a 2,311-account territory at Amazon, outperforming full-time colleagues. Seeking to bring builder mentality and commercial execution to Google's New Business Sales team.",
            },
            {
              id: "experience",
              type: "jobs",
              title: "WORK EXPERIENCE",
              jobs: [
                {
                  company: "Pairwire | New York, USA (Remote)",
                  role: "Co-Founder and Head of Sales | February 2024 – December 2025",
                  bullets: [
                    "Built €147K pipeline of contracted enterprise pilots from zero in 11 months pre-funding through outbound prospecting, cold calling, consulting, and relationship management",
                    "Closed 23 enterprise engagements including Fortune 500 and Big 4 firms across 6-9 month full-cycle sales processes",
                    "Engineered an AI-powered outbound engine processing 7,000+ leads, automating 80% of prospecting via custom tech stack (Python, Expand.io, AI-enhanced workflows)",
                    "Led end-to-end deal management from first touch to contract close, managing entire funnel with no sales team or brand recognition",
                    "Created partnership and investor pitch materials; led negotiations with Google, Web Summit, and enterprise decision-makers",
                  ],
                },
                {
                  company: "Google, Large Customer Sales | Lisbon, Portugal",
                  role: "Business Analyst Intern | May 2024 – August 2024",
                  bullets: [
                    'Led the "Future Trends" segment at Google\'s flagship partner event, presenting personally researched insights on Peak Season activation and media readiness to 237+ senior advertising clients',
                    "Designed and automated three globally scalable dashboards using Apps Script and GMP tools to analyze ROAS vs. profit and CPA vs. conversions, projecting $1.41M in annual savings for media spend decisions",
                    "Built a reporting platform for Partner Managers using Looker Studio, Analytics 360, and Apps Script, delivering an estimated €315K in annual efficiency gains",
                  ],
                },
                {
                  company: "Amazon, Amazon Business | Madrid, Spain",
                  role: "Business Development Intern | May 2022 – November 2022",
                  bullets: [
                    "Led the B2B retail expansion into Portugal, managing a portfolio of 2,311 companies through prospecting, outreach, and account activation",
                    "Outperformed KPI benchmarks by 21x in company account configurations during the Portugal B2B rollout",
                    "Raised territory share from 56% below to 25% above team average, outperforming full-time colleagues in the region",
                    "Compiled a 19-page strategic report on B2B eCommerce based on 8 company territories and 54 targeted client interviews",
                  ],
                },
                {
                  company:
                    "Ernst & Young, Financial Services | Lisbon, Portugal",
                  role: "Assurance Associate | February 2022 – April 2022",
                  bullets: [
                    "Audited asset portfolios worth €41.3 billion across 3 insurance firms, developing rigorous data verification and attention to detail",
                  ],
                },
              ],
            },
            {
              id: "education",
              type: "education",
              title: "EDUCATION",
              schools: [
                {
                  institution:
                    "Rotterdam School of Management | Rotterdam, Netherlands",
                  degree: "MSc in Strategic Management | GPA: 8/10",
                  details: [
                    "Relevant Courses: Applied Machine Learning to Strategy (9.3/10), Python Fundamentals (8.3/10)",
                  ],
                },
                {
                  institution: "National University of Singapore | Singapore",
                  degree:
                    "Exchange Semester | MBA-aligned coursework in Strategy and Innovation",
                  details: [
                    "Built a commercial and financial plan for a NUS PhD venture: 70% energy savings, 45% unit margins, 278% ROI in a $1.5B market",
                  ],
                },
                {
                  institution:
                    "Nova School of Business and Economics | Lisbon, Portugal",
                  degree: "BSc in Management | GPA: 16/20",
                  details: [
                    "Statistics (20/20), Procurement Management (19/20), Economics of the European Union (19/20)",
                  ],
                },
              ],
            },
            {
              id: "leadership",
              type: "leadership",
              title: "LEADERSHIP & ACTIVITIES",
              items: [
                {
                  name: "Nova Thirst Project",
                  desc: "Founder & President: Led 23 volunteers, raised €2,539 for water access, organized 4 events including one with 35 NGOs (2020-2021)",
                },
                {
                  name: "Nova Tech Club",
                  desc: "Digital Transformation Consultant: Developed a job platform prototype and organized corporate events and workshops (2020-2021)",
                },
                {
                  name: "Nova Social Consulting (WWF)",
                  desc: "Pro Bono Consultant: Assessed organizational structure, identified 155 improvement areas, delivered 6 presentations to senior management (2020-2021)",
                },
              ],
            },
            {
              id: "skills",
              type: "skills",
              title: "SKILLS",
              skills: [
                {
                  label: "Sales & Marketing:",
                  value:
                    "Google Ads, YouTube Ads, Google Display Network, CRM (Salesforce), LinkedIn Sales Navigator, Apollo, Full-Cycle Sales, Pipeline Management, Cold Outreach, Consultative Selling",
                },
                {
                  label: "Technical:",
                  value:
                    "Python, Apps Script, Visual Basic for Applications (VBA), SQL, Looker Studio, Power BI, DAX",
                },
                {
                  label: "Certifications:",
                  value:
                    "Google Ads Certified, Bloomberg Market Concepts, Microsoft Excel Specialist, TOEFL iBT",
                },
                {
                  label: "Languages:",
                  value:
                    "Portuguese (Native), English (Fluent), Spanish (Fluent), French (Beginner)",
                },
              ],
            },
          ],
        };
        let cv = JSON.parse(JSON.stringify(DEFAULT_CV));
        let zoomLevel = 65;
        let debounceTimer = null;
        let resizeTimer = null;
        let lastAutoFitState = null;

        // ═══ BUILT-IN CV PROFILES (seeded on first visit) ═══
        const GOOGLE_AE_CV = {
          name: "Tomás Maria Burnay Batalha",
          contact:
            "Lisbon, Portugal (Open to Relocation to Dublin) | (+351) 936 124 118 | tomas.b.batalha@gmail.com | linkedin.com/in/tomasmbatalha",
          sections: [
            {
              id: "summary",
              type: "summary",
              title: "PROFESSIONAL SUMMARY",
              content:
                "Former Google intern and startup Co-Founder with full-cycle new business sales experience. Built a €147K B2B pipeline from zero via multi-channel outreach, consultative selling, and enterprise deal closing. Managed a 2,311-account territory at Amazon, outperforming full-time colleagues. Seeking to bring builder mentality and commercial execution to Google's New Business Sales team.",
            },
            {
              id: "experience",
              type: "jobs",
              title: "WORK EXPERIENCE",
              jobs: [
                {
                  company: "Pairwire | New York, USA (Remote)",
                  role: "Co-Founder and Head of Sales | February 2024 – December 2025",
                  bullets: [
                    "Built €147K pipeline of contracted enterprise pilots from zero in 11 months pre-funding through outbound prospecting, cold calling, consulting, and relationship management",
                    "Closed 23 enterprise engagements including Fortune 500 and Big 4 firms across 6-9 month full-cycle sales processes",
                    "Engineered an AI-powered outbound engine processing 7,000+ leads, automating 80% of prospecting via custom tech stack (Python, Expand.io, AI-enhanced workflows)",
                    "Led end-to-end deal management from first touch to contract close, managing entire funnel with no sales team or brand recognition",
                    "Created partnership and investor pitch materials; led negotiations with Google, Web Summit, and enterprise decision-makers",
                  ],
                },
                {
                  company: "Google, Large Customer Sales | Lisbon, Portugal",
                  role: "Business Analyst Intern | May 2024 – August 2024",
                  bullets: [
                    'Led the "Future Trends" segment at Google\'s flagship partner event, presenting personally researched insights on Peak Season activation and media readiness to 237+ senior advertising clients',
                    "Designed and automated three globally scalable dashboards using Apps Script and GMP tools to analyze ROAS vs. profit and CPA vs. conversions, projecting $1.41M in annual savings for media spend decisions",
                    "Built a reporting platform for Partner Managers using Looker Studio, Analytics 360, and Apps Script, delivering an estimated €315K in annual efficiency gains",
                  ],
                },
                {
                  company: "Amazon, Amazon Business | Madrid, Spain",
                  role: "Business Development Intern | May 2022 – November 2022",
                  bullets: [
                    "Led the B2B retail expansion into Portugal, managing a portfolio of 2,311 companies through prospecting, outreach, and account activation",
                    "Outperformed KPI benchmarks by 21x in company account configurations during the Portugal B2B rollout",
                    "Raised territory share from 56% below to 25% above team average, outperforming full-time colleagues in the region",
                    "Compiled a 19-page strategic report on B2B eCommerce based on 8 company territories and 54 targeted client interviews",
                  ],
                },
                {
                  company:
                    "Ernst & Young, Financial Services | Lisbon, Portugal",
                  role: "Assurance Associate | February 2022 – April 2022",
                  bullets: [
                    "Audited asset portfolios worth €41.3 billion across 3 insurance firms, developing rigorous data verification and attention to detail",
                  ],
                },
              ],
            },
            {
              id: "education",
              type: "education",
              title: "EDUCATION",
              schools: [
                {
                  institution:
                    "Rotterdam School of Management | Rotterdam, Netherlands",
                  degree: "MSc in Strategic Management | GPA: 8/10",
                  details: [
                    "Relevant Courses: Applied Machine Learning to Strategy (9.3/10), Python Fundamentals (8.3/10)",
                  ],
                },
                {
                  institution: "National University of Singapore | Singapore",
                  degree:
                    "Exchange Semester | MBA-aligned coursework in Strategy and Innovation",
                  details: [
                    "Built a commercial and financial plan for a NUS PhD venture: 70% energy savings, 45% unit margins, 278% ROI in a $1.5B market",
                  ],
                },
                {
                  institution:
                    "Nova School of Business and Economics | Lisbon, Portugal",
                  degree: "BSc in Management | GPA: 16/20",
                  details: [
                    "Statistics (20/20), Procurement Management (19/20), Economics of the European Union (19/20)",
                  ],
                },
              ],
            },
            {
              id: "leadership",
              type: "leadership",
              title: "LEADERSHIP & ACTIVITIES",
              items: [
                {
                  name: "Nova Thirst Project",
                  desc: "Founder & President: Led 23 volunteers, raised €2,539 for water access, organized 4 events including one with 35 NGOs (2020-2021)",
                },
                {
                  name: "Nova Tech Club",
                  desc: "Digital Transformation Consultant: Developed a job platform prototype and organized corporate events and workshops (2020-2021)",
                },
                {
                  name: "Nova Social Consulting (WWF)",
                  desc: "Pro Bono Consultant: Assessed organizational structure, identified 155 improvement areas, delivered 6 presentations to senior management (2020-2021)",
                },
              ],
            },
            {
              id: "skills",
              type: "skills",
              title: "SKILLS",
              skills: [
                {
                  label: "Sales & Marketing:",
                  value:
                    "Google Ads, YouTube Ads, Google Display Network, CRM (Salesforce), LinkedIn Sales Navigator, Apollo, Full-Cycle Sales, Pipeline Management, Cold Outreach, Consultative Selling",
                },
                {
                  label: "Technical:",
                  value:
                    "Python, Apps Script, Visual Basic for Applications (VBA), SQL, Looker Studio, Power BI, DAX",
                },
                {
                  label: "Certifications:",
                  value:
                    "Google Ads Certified, Bloomberg Market Concepts, Microsoft Excel Specialist, TOEFL iBT",
                },
                {
                  label: "Languages:",
                  value:
                    "Portuguese (Native), English (Fluent), Spanish (Fluent), French (Beginner)",
                },
              ],
            },
          ],
        };

        const BUILT_IN_PROFILES = {
          "Google AE Final": GOOGLE_AE_CV,
        };

        // ═══ PROFILE / TAG SYSTEM ═══
        const PROFILES_KEY = "cv-profiles";
        const ACTIVE_KEY = "cv-active-profile";
        let activeProfile = null;

        // ═══ STYLE / TYPOGRAPHY SYSTEM ═══
        const STYLE_DEFAULTS = {
          bodyFont: "'Helvetica Neue', Helvetica, Arial, sans-serif",
          titleFont: "'Helvetica Neue', Helvetica, Arial, sans-serif",
          letterSpacing: 0,
          bodySize: null, // null = auto (autoFit controls it)
          titleSize: null, // null = auto (autoFit controls it)
          sectionGap: null, // null = auto (autoFit controls it)
          bulletGap: null,
          margins: null, // null = auto
          lineHeight: null,
          showGuides: false,
          showPrintBorder: false,
        };
        // userStyle: values the user has explicitly set; null = auto
        let userStyle = JSON.parse(JSON.stringify(STYLE_DEFAULTS));

        // ═══════════════════════════════════════════════════════
        // INIT
        // ═══════════════════════════════════════════════════════
        function init() {
          // Seed built-in profiles if they don't exist yet
          const profiles = getProfiles();
          let seeded = false;
          Object.keys(BUILT_IN_PROFILES).forEach(function (name) {
            if (!profiles[name]) {
              profiles[name] = JSON.parse(
                JSON.stringify(BUILT_IN_PROFILES[name]),
              );
              seeded = true;
            }
          });
          if (seeded) setProfiles(profiles);

          loadProfileList();
          const activeName = localStorage.getItem(ACTIVE_KEY);
          if (activeName) {
            loadProfile(activeName, true);
          } else {
            const saved = localStorage.getItem("cv-editor-data");
            if (saved) {
              try {
                cv = JSON.parse(saved);
              } catch (e) {
                cv = JSON.parse(JSON.stringify(DEFAULT_CV));
              }
            }
            // Restore style from CV data
            if (cv.style) {
              userStyle = Object.assign(
                JSON.parse(JSON.stringify(STYLE_DEFAULTS)),
                cv.style,
              );
            }
            syncStyleUI();
          }
          renderEditor();
          renderPreview();
          autoZoom();
          window.addEventListener("resize", () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(autoZoom, 200);
          });
          // Initialize AI provider UI state (show/hide Ollama row etc.)
          // Restore saved provider from localStorage
          try {
            var savedProvider = localStorage.getItem("cv-ai-provider");
            if (savedProvider) {
              var provSel = document.getElementById("ai-provider");
              if (provSel) {
                // Check if this provider exists in the select
                var opts = Array.from(provSel.options).map(function (o) {
                  return o.value;
                });
                if (opts.includes(savedProvider)) {
                  provSel.value = savedProvider;
                }
              }
            }
          } catch (e) {}
          onProviderChange();
          // Auto-connect if a saved API key exists for the current provider
          (async function () {
            try {
              var prov = document.getElementById("ai-provider").value;
              if (prov === "ollama") {
                // Ollama auto-connects via startOllamaAutoSetup if needed
              } else {
                var savedKeys = JSON.parse(
                  localStorage.getItem("cv-ai-keys") || "{}",
                );
                if (savedKeys[prov]) {
                  document.getElementById("ai-api-key").value = savedKeys[prov];
                  await connectAI();
                }
              }
            } catch (e) {
              console.warn("Auto-connect failed:", e);
            }
          })();
          // Restore job context label
          updateJobContextLabel();
          // Initialize undo system with loaded CV state
          lastSnapshotJSON = JSON.stringify(cv);
        }

        // ═══════════════════════════════════════════════════════
        // EDITOR RENDERING
        // ═══════════════════════════════════════════════════════
        function renderEditor() {
          const editor = document.getElementById("editor");
          let html = "";

          // Name & Contact
          html += `
              <div class="section-block">
                <div class="section-header" onclick="toggleSection(this)">
                  <span class="chevron open">▶</span>
                  <span class="section-title">Header</span>
                </div>
                <div class="section-body">
                  <div class="field-row">
                    <span class="field-label">Name</span>
                    <input class="field-input" data-cv-path="name" value="${esc(cv.name)}" oninput="cv.name=this.value;schedulePreview()">
                  </div>
                  <div class="field-row">
                    <span class="field-label">Contact</span>
                    <input class="field-input" data-cv-path="contact" value="${esc(cv.contact)}" oninput="cv.contact=this.value;schedulePreview()">
                  </div>
                </div>
              </div>
            `;

          // Sections
          cv.sections.forEach((sec, si) => {
            const secHidden = sec.hidden ? "item-hidden" : "";
            html += `<div class="section-block ${secHidden}" draggable="true" ondragstart="dragSection(event,${si})" ondragover="dragOverSection(event,${si})" ondrop="dropSection(event,${si})" ondragend="dragEnd(event)">`;
            html += `
                <div class="section-header" onclick="toggleSection(this)">
                  <span class="chevron open">▶</span>
                  <span class="section-title">${esc(sec.title)}</span>
                  <div class="section-actions" onclick="event.stopPropagation()">
                    <button class="icon-btn eye ${sec.hidden ? "hidden-item" : ""}" onclick="toggleHide('section',${si})" title="${sec.hidden ? "Show" : "Hide"} section">${sec.hidden ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>' : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>'}</button>
                    <button class="icon-btn" onclick="moveSectionUp(${si})" title="Move up">↑</button>
                    <button class="icon-btn" onclick="moveSectionDown(${si})" title="Move down">↓</button>
                    <button class="icon-btn delete" onclick="removeSection(${si})" title="Remove section">✕</button>
                  </div>
                </div>
                <div class="section-body">
                  <div class="field-row" style="margin-bottom:6px">
                    <span class="field-label">Title</span>
                    <input class="field-input" value="${esc(sec.title)}" oninput="cv.sections[${si}].title=this.value;schedulePreview();updateSectionTitle(this,${si})">
                  </div>
              `;

            if (sec.type === "summary") {
              html += `<textarea class="field-input" rows="3" data-cv-path="sections[${si}].content" oninput="cv.sections[${si}].content=this.value;schedulePreview()">${esc(sec.content)}</textarea>`;
            } else if (sec.type === "jobs") {
              sec.jobs.forEach((job, ji) => {
                const jobHidden = job.hidden ? "item-hidden" : "";
                html += `<div class="job-block ${jobHidden}" draggable="true" ondragstart="dragJob(event,${si},${ji})" ondragover="dragOverJob(event,${si},${ji})" ondrop="dropJob(event,${si},${ji})" ondragend="dragEnd(event)">`;
                html += `
                    <div class="job-header">
                      <input class="company" data-cv-path="sections[${si}].jobs[${ji}].company" value="${esc(job.company)}" oninput="cv.sections[${si}].jobs[${ji}].company=this.value;schedulePreview()" placeholder="Company | Location">
                      <button class="icon-btn eye ${job.hidden ? "hidden-item" : ""}" onclick="toggleHide('job',${si},${ji})" title="${job.hidden ? "Show" : "Hide"} job">${job.hidden ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>' : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>'}</button>
                      <button class="icon-btn" onclick="moveJobUp(${si},${ji})">↑</button>
                      <button class="icon-btn" onclick="moveJobDown(${si},${ji})">↓</button>
                      <button class="icon-btn delete" onclick="removeJob(${si},${ji})">✕</button>
                    </div>
                    <div class="job-header">
                      <input class="role" data-cv-path="sections[${si}].jobs[${ji}].role" value="${esc(job.role)}" oninput="cv.sections[${si}].jobs[${ji}].role=this.value;schedulePreview()" placeholder="Role | Dates">
                    </div>
                    <ul class="bullet-list">
                  `;
                job.bullets.forEach((b, bi) => {
                  const bHidden = (job.hiddenBullets || []).includes(bi);
                  html += `
                      <li class="bullet-item ${bHidden ? "item-hidden" : ""}" draggable="true" ondragstart="dragBullet(event,${si},${ji},${bi})" ondragover="dragOverBullet(event,${si},${ji},${bi})" ondrop="dropBullet(event,${si},${ji},${bi})" ondragend="dragEnd(event)">
                        <span class="bullet-drag" title="Drag to reorder">⠿</span>
                        <textarea class="bullet-text" rows="1" data-cv-path="sections[${si}].jobs[${ji}].bullets[${bi}]" oninput="autoGrow(this);cv.sections[${si}].jobs[${ji}].bullets[${bi}]=this.value;schedulePreview()">${esc(b)}</textarea>
                        <div class="bullet-actions">
                          <button class="icon-btn eye ${bHidden ? "hidden-item" : ""}" onclick="toggleHide('bullet',${si},${ji},${bi})" title="${bHidden ? "Show" : "Hide"}">${bHidden ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>' : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>'}</button>
                          <button class="icon-btn" onclick="moveBulletUp(${si},${ji},${bi})">↑</button>
                          <button class="icon-btn" onclick="moveBulletDown(${si},${ji},${bi})">↓</button>
                          <button class="icon-btn delete" onclick="removeBullet(${si},${ji},${bi})">✕</button>
                        </div>
                      </li>
                    `;
                });
                html += `</ul>`;
                html += `<div class="add-row"><button class="add-btn" onclick="addBullet(${si},${ji})">+ Add bullet</button></div>`;
                html += `</div>`;
              });
              html += `<div class="add-row"><button class="add-btn" onclick="addJob(${si})">+ Add job</button></div>`;
            } else if (sec.type === "education") {
              sec.schools.forEach((sch, ei) => {
                const schHidden = sch.hidden ? "item-hidden" : "";
                html += `<div class="job-block ${schHidden}">`;
                html += `
                    <div class="job-header">
                      <input class="company" data-cv-path="sections[${si}].schools[${ei}].institution" value="${esc(sch.institution)}" oninput="cv.sections[${si}].schools[${ei}].institution=this.value;schedulePreview()">
                      <button class="icon-btn eye ${sch.hidden ? "hidden-item" : ""}" onclick="toggleHide('school',${si},${ei})" title="${sch.hidden ? "Show" : "Hide"}">${sch.hidden ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>' : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>'}</button>
                      <button class="icon-btn" onclick="moveSchoolUp(${si},${ei})">↑</button>
                      <button class="icon-btn" onclick="moveSchoolDown(${si},${ei})">↓</button>
                      <button class="icon-btn delete" onclick="removeSchool(${si},${ei})">✕</button>
                    </div>
                    <div class="job-header">
                      <input class="role" value="${esc(sch.degree)}" oninput="cv.sections[${si}].schools[${ei}].degree=this.value;schedulePreview()">
                    </div>
                    <ul class="bullet-list">
                  `;
                (sch.details || []).forEach((d, di) => {
                  const dHidden = (sch.hiddenDetails || []).includes(di);
                  html += `
                      <li class="bullet-item ${dHidden ? "item-hidden" : ""}">
                        <span class="bullet-drag">⠿</span>
                        <textarea class="bullet-text" rows="1" data-cv-path="sections[${si}].schools[${ei}].details[${di}]" oninput="autoGrow(this);cv.sections[${si}].schools[${ei}].details[${di}]=this.value;schedulePreview()">${esc(d)}</textarea>
                        <div class="bullet-actions">
                          <button class="icon-btn eye ${dHidden ? "hidden-item" : ""}" onclick="toggleHide('eduDetail',${si},${ei},${di})" title="${dHidden ? "Show" : "Hide"}">${dHidden ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>' : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>'}</button>
                          <button class="icon-btn delete" onclick="removeEduDetail(${si},${ei},${di})">✕</button>
                        </div>
                      </li>
                    `;
                });
                html += `</ul>`;
                html += `<div class="add-row"><button class="add-btn" onclick="addEduDetail(${si},${ei})">+ Add detail</button></div>`;
                html += `</div>`;
              });
              html += `<div class="add-row"><button class="add-btn" onclick="addSchool(${si})">+ Add school</button></div>`;
            } else if (sec.type === "leadership") {
              sec.items.forEach((item, li) => {
                const liHidden = item.hidden ? "item-hidden" : "";
                html += `
                    <div class="leadership-item ${liHidden}">
                      <input class="name" value="${esc(item.name)}" oninput="cv.sections[${si}].items[${li}].name=this.value;schedulePreview()">
                      <input class="desc" value="${esc(item.desc)}" oninput="cv.sections[${si}].items[${li}].desc=this.value;schedulePreview()">
                      <button class="icon-btn eye ${item.hidden ? "hidden-item" : ""}" onclick="toggleHide('leadership',${si},${li})" title="${item.hidden ? "Show" : "Hide"}">${item.hidden ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>' : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>'}</button>
                      <button class="icon-btn" onclick="moveLeadershipUp(${si},${li})">↑</button>
                      <button class="icon-btn" onclick="moveLeadershipDown(${si},${li})">↓</button>
                      <button class="icon-btn delete" onclick="removeLeadership(${si},${li})">✕</button>
                    </div>
                  `;
              });
              html += `<div class="add-row"><button class="add-btn" onclick="addLeadership(${si})">+ Add activity</button></div>`;
            } else if (sec.type === "skills") {
              sec.skills.forEach((sk, ki) => {
                const skHidden = sk.hidden ? "item-hidden" : "";
                html += `
                    <div class="skill-row ${skHidden}">
                      <input class="skill-label" data-cv-path="sections[${si}].skills[${ki}].label" value="${esc(sk.label)}" oninput="cv.sections[${si}].skills[${ki}].label=this.value;schedulePreview()">
                      <input class="skill-value" data-cv-path="sections[${si}].skills[${ki}].value" value="${esc(sk.value)}" oninput="cv.sections[${si}].skills[${ki}].value=this.value;schedulePreview()">
                      <button class="icon-btn eye ${sk.hidden ? "hidden-item" : ""}" onclick="toggleHide('skill',${si},${ki})" title="${sk.hidden ? "Show" : "Hide"}">${sk.hidden ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>' : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>'}</button>
                      <button class="icon-btn delete" onclick="removeSkill(${si},${ki})">✕</button>
                    </div>
                  `;
              });
              html += `<div class="add-row"><button class="add-btn" onclick="addSkill(${si})">+ Add skill</button></div>`;
            }

            html += `</div></div>`;
          });

          editor.innerHTML = html;

          // Auto-grow textareas
          document
            .querySelectorAll(".bullet-text")
            .forEach((ta) => autoGrow(ta));
        }

        // ═══════════════════════════════════════════════════════
        // PREVIEW RENDERING + AUTO-FIT
        // ═══════════════════════════════════════════════════════
        function renderPreview() {
          const paper = document.getElementById("paper");
          // ATS-friendly: use semantic HTML (h1/h2/h3/p/ul/li)
          let html = `<h1 class="cv-name">${esc(cv.name)}</h1>`;
          html += `<p class="cv-contact">${esc(cv.contact)}</p>`;

          // Helper: split "Name | Location" or "Title | Dates" on pipe
          function splitPipe(text) {
            const idx = text.indexOf(" | ");
            if (idx > -1)
              return [text.substring(0, idx), text.substring(idx + 3)];
            return [text, ""];
          }

          cv.sections.forEach((sec) => {
            if (sec.hidden) return;
            html += `<h2 class="cv-section-title">${esc(sec.title)}</h2>`;

            if (sec.type === "summary") {
              html += `<p class="cv-summary">${esc(sec.content)}</p>`;
            } else if (sec.type === "jobs") {
              sec.jobs.forEach((job) => {
                if (job.hidden) return;
                const [companyName, companyLoc] = splitPipe(job.company);
                const [roleTitle, roleDates] = splitPipe(job.role);
                html += `<h3 class="cv-company">${esc(companyName)}${companyLoc ? `<span class="cv-location">${esc(companyLoc)}</span>` : ""}</h3>`;
                html += `<p class="cv-role">${esc(roleTitle)}${roleDates ? `<span class="cv-dates">${esc(roleDates)}</span>` : ""}</p>`;
                html += `<ul>`;
                job.bullets.forEach((b, bi) => {
                  if ((job.hiddenBullets || []).includes(bi)) return;
                  html += `<li class="cv-bullet">- ${esc(b)}</li>`;
                });
                html += `</ul>`;
              });
            } else if (sec.type === "education") {
              sec.schools.forEach((sch) => {
                if (sch.hidden) return;
                const [instName, instLoc] = splitPipe(sch.institution);
                const [degName, degExtra] = splitPipe(sch.degree);
                html += `<h3 class="cv-company">${esc(instName)}${instLoc ? `<span class="cv-location">${esc(instLoc)}</span>` : ""}</h3>`;
                html += `<p class="cv-role">${esc(degName)}${degExtra ? `<span class="cv-dates">${esc(degExtra)}</span>` : ""}</p>`;
                html += `<ul>`;
                (sch.details || []).forEach((d, di) => {
                  if ((sch.hiddenDetails || []).includes(di)) return;
                  html += `<li class="cv-edu-detail">- ${esc(d)}</li>`;
                });
                html += `</ul>`;
              });
            } else if (sec.type === "leadership") {
              sec.items.forEach((item) => {
                if (item.hidden) return;
                html += `<h3 class="cv-company">${esc(item.name)}</h3>`;
                const colonIdx = item.desc.indexOf(": ");
                if (colonIdx > -1) {
                  const role = item.desc.substring(0, colonIdx);
                  const detail = item.desc.substring(colonIdx + 2);
                  html += `<p class="cv-role">${esc(role)}</p>`;
                  html += `<ul><li class="cv-bullet">- ${esc(detail)}</li></ul>`;
                } else {
                  html += `<ul><li class="cv-bullet">- ${esc(item.desc)}</li></ul>`;
                }
              });
            } else if (sec.type === "skills") {
              sec.skills.forEach((sk) => {
                if (sk.hidden) return;
                html += `<p class="cv-skill"><strong>${esc(sk.label)}</strong> ${esc(sk.value)}</p>`;
              });
            }
          });

          paper.innerHTML = html;
          autoFit();
        }

        function autoFit() {
          const paper = document.getElementById("paper");
          const checkOverflow = () => paper.scrollHeight > paper.clientHeight;
          const getFillRatio = () => paper.scrollHeight / paper.clientHeight;

          // Count total content entries to determine if page should be filled
          const countEntries = () => {
            let count = 0;
            cv.sections.forEach((sec) => {
              count++; // section header
              if (sec.type === "summary") count += 1;
              else if (sec.type === "jobs")
                sec.jobs.forEach((j) => {
                  count += 2;
                  count += j.bullets.length;
                });
              else if (sec.type === "education")
                sec.schools.forEach((s) => {
                  count += 2;
                  count += (s.details || []).length;
                });
              else if (sec.type === "leadership") count += sec.items.length;
              else if (sec.type === "skills") count += sec.skills.length;
            });
            return count;
          };

          // ── BASE VALUES (benchmark defaults) ──
          const BASE = {
            sectionGap: 5,
            companyGap: 3,
            bulletGap: 0.5,
            lineHeight: 1.35,
            nameSize: 15,
            contactSize: 7.5,
            contactMargin: 6,
            sectionTitleSize: 9.5,
            companySize: 8.5,
            roleSize: 8,
            bodySize: 7.5,
            padV: 10,
            padH: 14,
          };

          // Apply user-locked values as overrides to BASE
          const locked = {};
          if (userStyle.titleSize !== null) {
            BASE.sectionTitleSize = userStyle.titleSize;
            BASE.companySize = userStyle.titleSize - 1;
            BASE.roleSize = userStyle.titleSize - 1.5;
            locked.sectionTitleSize = true;
            locked.companySize = true;
            locked.roleSize = true;
          }
          if (userStyle.bodySize !== null) {
            BASE.bodySize = userStyle.bodySize;
            locked.bodySize = true;
          }
          if (userStyle.sectionGap !== null) {
            BASE.sectionGap = userStyle.sectionGap;
            locked.sectionGap = true;
          }
          if (userStyle.bulletGap !== null) {
            BASE.bulletGap = userStyle.bulletGap;
            locked.bulletGap = true;
          }
          if (userStyle.lineHeight !== null) {
            BASE.lineHeight = userStyle.lineHeight;
            locked.lineHeight = true;
          }
          if (userStyle.margins !== null) {
            BASE.padV = userStyle.margins;
            BASE.padH = userStyle.margins + 4;
            locked.padV = true;
            locked.padH = true;
          }

          // Apply fonts and letter-spacing (always user-controlled, not auto-adjustable)
          const applyFonts = () => {
            paper.style.fontFamily = userStyle.bodyFont;
            paper.style.letterSpacing = userStyle.letterSpacing + "px";
            paper
              .querySelectorAll(".cv-name, .cv-section-title")
              .forEach((el) => {
                el.style.fontFamily = userStyle.titleFont;
              });
          };

          const applyState = (state) => {
            paper.style.padding = `${state.padV}mm ${state.padH}mm`;
            paper
              .querySelectorAll(".cv-name")
              .forEach((el) => (el.style.fontSize = state.nameSize + "pt"));
            paper.querySelectorAll(".cv-contact").forEach((el) => {
              el.style.fontSize = state.contactSize + "pt";
              el.style.marginBottom = state.contactMargin + "px";
            });
            paper.querySelectorAll(".cv-section-title").forEach((el) => {
              el.style.fontSize = state.sectionTitleSize + "pt";
              el.style.marginTop = state.sectionGap + "px";
            });
            paper.querySelectorAll(".cv-company").forEach((el) => {
              el.style.fontSize = state.companySize + "pt";
              el.style.marginTop = state.companyGap + "px";
            });
            paper.querySelectorAll(".cv-role").forEach((el) => {
              el.style.fontSize = state.roleSize + "pt";
            });
            paper
              .querySelectorAll(
                ".cv-bullet, .cv-edu-detail, .cv-leadership, .cv-skill, .cv-summary",
              )
              .forEach((el) => {
                el.style.fontSize = state.bodySize + "pt";
                el.style.lineHeight = String(state.lineHeight);
                el.style.marginBottom = state.bulletGap + "px";
              });
            paper.querySelectorAll(".cv-location, .cv-dates").forEach((el) => {
              el.style.fontSize = state.bodySize + "pt";
            });
          };

          // Filter expansion/compression steps to exclude locked properties
          const filterSteps = (steps) =>
            steps.filter((step) => {
              for (const key of Object.keys(step)) {
                if (locked[key]) return false;
              }
              return true;
            });

          // ── STEP 1: Start from base + apply fonts ──
          let state = { ...BASE };
          applyFonts();
          applyState(state);

          const entries = countEntries();
          const TOO_SPARSE = entries < 10;

          // ── STEP 2: EXPAND if content doesn't fill the page ──
          if (!checkOverflow() && !TOO_SPARSE) {
            const expansionSteps = filterSteps([
              { sectionGap: 6 },
              { sectionGap: 7 },
              { sectionGap: 8 },
              { sectionGap: 9 },
              { sectionGap: 10 },
              { sectionGap: 12 },
              { sectionGap: 14 },
              { companyGap: 4 },
              { companyGap: 5 },
              { companyGap: 6 },
              { bulletGap: 1 },
              { bulletGap: 1.5 },
              { bulletGap: 2 },
              { contactMargin: 8 },
              { contactMargin: 10 },
              { contactMargin: 12 },
              { lineHeight: 1.4 },
              { lineHeight: 1.45 },
              { padV: 11, padH: 15 },
              { padV: 12, padH: 16 },
            ]);

            let expLevel = 0;
            while (!checkOverflow() && expLevel < expansionSteps.length) {
              const prev = { ...state };
              Object.assign(state, expansionSteps[expLevel]);
              applyState(state);
              if (checkOverflow()) {
                state = prev;
                applyState(state);
                break;
              }
              expLevel++;
            }
          }

          // ── STEP 3: COMPRESS if content overflows ──
          if (checkOverflow()) {
            state = { ...BASE };
            applyState(state);

            const compressionSteps = filterSteps([
              { sectionGap: 4.5 },
              { sectionGap: 4 },
              { sectionGap: 3.5 },
              { sectionGap: 3 },
              { companyGap: 2.5 },
              { companyGap: 2 },
              { companyGap: 1.5 },
              { bulletGap: 0.3 },
              { bulletGap: 0.1 },
              { bulletGap: 0 },
              { lineHeight: 1.3 },
              { lineHeight: 1.25 },
              { lineHeight: 1.2 },
              { contactMargin: 4 },
              { contactMargin: 3 },
              { bodySize: 7.2 },
              { bodySize: 7.0 },
              { bodySize: 6.8 },
              { sectionTitleSize: 9.0, companySize: 8.0, roleSize: 7.5 },
              { sectionTitleSize: 8.5, companySize: 7.5, roleSize: 7.0 },
              { nameSize: 14, contactSize: 7 },
              { nameSize: 13, contactSize: 6.5 },
              { padV: 9, padH: 13 },
              { padV: 8, padH: 12 },
              { padV: 7, padH: 10 },
              { padV: 6, padH: 9 },
            ]);

            let compLevel = 0;
            while (checkOverflow() && compLevel < compressionSteps.length) {
              Object.assign(state, compressionSteps[compLevel]);
              applyState(state);
              compLevel++;
            }
          }

          // ── UPDATE MARGIN GUIDES ──
          lastAutoFitState = { ...state };
          updateMarginGuides(state);

          // ── STATUS BAR ──
          const fitStatus = document.getElementById("fit-status");
          const scaleInfo = document.getElementById("scale-info");
          const overflowLine = document.getElementById("overflow-line");
          const ratio = getFillRatio();
          const fillPct = Math.round(ratio * 100);

          if (checkOverflow()) {
            fitStatus.textContent = "✕ Overflows — reduce content";
            fitStatus.className = "fit-indicator fit-over";
            overflowLine.style.display = "block";
          } else if (TOO_SPARSE) {
            fitStatus.textContent = "○ Sparse content — add more to fill page";
            fitStatus.className = "fit-indicator fit-warn";
            overflowLine.style.display = "none";
          } else if (fillPct >= 92) {
            fitStatus.textContent = "✓ Perfectly filled";
            fitStatus.className = "fit-indicator fit-ok";
            overflowLine.style.display = "none";
          } else if (fillPct >= 80) {
            fitStatus.textContent = "✓ Well balanced";
            fitStatus.className = "fit-indicator fit-ok";
            overflowLine.style.display = "none";
          } else {
            fitStatus.textContent = "✓ Fits comfortably";
            fitStatus.className = "fit-indicator fit-ok";
            overflowLine.style.display = "none";
          }

          const bodyFont = state.bodySize;
          const lh = state.lineHeight;
          scaleInfo.textContent = `Fill: ${fillPct}% | Body: ${bodyFont}pt | LH: ${lh} | Gaps: ${state.sectionGap}px`;
        }

        // ═══════════════════════════════════════════════════════
        // SECTION OPERATIONS
        // ═══════════════════════════════════════════════════════
        function moveSectionUp(i) {
          if (i <= 0) return;
          [cv.sections[i - 1], cv.sections[i]] = [
            cv.sections[i],
            cv.sections[i - 1],
          ];
          renderEditor();
          renderPreview();
        }
        function moveSectionDown(i) {
          if (i >= cv.sections.length - 1) return;
          [cv.sections[i], cv.sections[i + 1]] = [
            cv.sections[i + 1],
            cv.sections[i],
          ];
          renderEditor();
          renderPreview();
        }
        function removeSection(i) {
          if (!confirm(`Remove section "${cv.sections[i].title}"?`)) return;
          cv.sections.splice(i, 1);
          renderEditor();
          renderPreview();
        }
        function addSection() {
          const type = prompt(
            "Section type: summary, jobs, education, leadership, or skills",
            "jobs",
          );
          if (!type) return;
          const title = prompt("Section title:", "NEW SECTION");
          if (!title) return;
          const sec = { id: "sec_" + Date.now(), type, title };
          if (type === "summary") sec.content = "";
          else if (type === "jobs") sec.jobs = [];
          else if (type === "education") sec.schools = [];
          else if (type === "leadership") sec.items = [];
          else if (type === "skills") sec.skills = [];
          cv.sections.push(sec);
          renderEditor();
          renderPreview();
        }
        function updateSectionTitle(input, si) {
          // Update the header display
          const block = input.closest(".section-block");
          const titleSpan = block.querySelector(".section-title");
          titleSpan.textContent = input.value;
        }

        // ═══════════════════════════════════════════════════════
        // JOB OPERATIONS
        // ═══════════════════════════════════════════════════════
        function addJob(si) {
          cv.sections[si].jobs.push({ company: "", role: "", bullets: [""] });
          renderEditor();
          renderPreview();
        }
        function removeJob(si, ji) {
          if (!confirm("Remove this job?")) return;
          cv.sections[si].jobs.splice(ji, 1);
          renderEditor();
          renderPreview();
        }
        function moveJobUp(si, ji) {
          if (ji <= 0) return;
          const jobs = cv.sections[si].jobs;
          [jobs[ji - 1], jobs[ji]] = [jobs[ji], jobs[ji - 1]];
          renderEditor();
          renderPreview();
        }
        function moveJobDown(si, ji) {
          const jobs = cv.sections[si].jobs;
          if (ji >= jobs.length - 1) return;
          [jobs[ji], jobs[ji + 1]] = [jobs[ji + 1], jobs[ji]];
          renderEditor();
          renderPreview();
        }

        // ═══════════════════════════════════════════════════════
        // BULLET OPERATIONS
        // ═══════════════════════════════════════════════════════
        function addBullet(si, ji) {
          cv.sections[si].jobs[ji].bullets.push("");
          renderEditor();
          renderPreview();
        }
        function removeBullet(si, ji, bi) {
          cv.sections[si].jobs[ji].bullets.splice(bi, 1);
          renderEditor();
          renderPreview();
        }
        function moveBulletUp(si, ji, bi) {
          if (bi <= 0) return;
          const bullets = cv.sections[si].jobs[ji].bullets;
          [bullets[bi - 1], bullets[bi]] = [bullets[bi], bullets[bi - 1]];
          renderEditor();
          renderPreview();
        }
        function moveBulletDown(si, ji, bi) {
          const bullets = cv.sections[si].jobs[ji].bullets;
          if (bi >= bullets.length - 1) return;
          [bullets[bi], bullets[bi + 1]] = [bullets[bi + 1], bullets[bi]];
          renderEditor();
          renderPreview();
        }

        // ═══════════════════════════════════════════════════════
        // EDUCATION OPERATIONS
        // ═══════════════════════════════════════════════════════
        function addSchool(si) {
          cv.sections[si].schools.push({
            institution: "",
            degree: "",
            details: [],
          });
          renderEditor();
          renderPreview();
        }
        function removeSchool(si, ei) {
          if (!confirm("Remove this school?")) return;
          cv.sections[si].schools.splice(ei, 1);
          renderEditor();
          renderPreview();
        }
        function moveSchoolUp(si, ei) {
          if (ei <= 0) return;
          const schools = cv.sections[si].schools;
          [schools[ei - 1], schools[ei]] = [schools[ei], schools[ei - 1]];
          renderEditor();
          renderPreview();
        }
        function moveSchoolDown(si, ei) {
          const schools = cv.sections[si].schools;
          if (ei >= schools.length - 1) return;
          [schools[ei], schools[ei + 1]] = [schools[ei + 1], schools[ei]];
          renderEditor();
          renderPreview();
        }
        function addEduDetail(si, ei) {
          cv.sections[si].schools[ei].details.push("");
          renderEditor();
          renderPreview();
        }
        function removeEduDetail(si, ei, di) {
          cv.sections[si].schools[ei].details.splice(di, 1);
          renderEditor();
          renderPreview();
        }

        // ═══════════════════════════════════════════════════════
        // LEADERSHIP OPERATIONS
        // ═══════════════════════════════════════════════════════
        function addLeadership(si) {
          cv.sections[si].items.push({ name: "", desc: "" });
          renderEditor();
          renderPreview();
        }
        function removeLeadership(si, li) {
          cv.sections[si].items.splice(li, 1);
          renderEditor();
          renderPreview();
        }
        function moveLeadershipUp(si, li) {
          if (li <= 0) return;
          const items = cv.sections[si].items;
          [items[li - 1], items[li]] = [items[li], items[li - 1]];
          renderEditor();
          renderPreview();
        }
        function moveLeadershipDown(si, li) {
          const items = cv.sections[si].items;
          if (li >= items.length - 1) return;
          [items[li], items[li + 1]] = [items[li + 1], items[li]];
          renderEditor();
          renderPreview();
        }

        // ═══════════════════════════════════════════════════════
        // HIDE/SHOW TOGGLE
        // ═══════════════════════════════════════════════════════
        function toggleHide(type, si, ji, bi) {
          switch (type) {
            case "section":
              cv.sections[si].hidden = !cv.sections[si].hidden;
              break;
            case "job":
              cv.sections[si].jobs[ji].hidden =
                !cv.sections[si].jobs[ji].hidden;
              break;
            case "bullet": {
              const job = cv.sections[si].jobs[ji];
              if (!job.hiddenBullets) job.hiddenBullets = [];
              const idx = job.hiddenBullets.indexOf(bi);
              if (idx === -1) job.hiddenBullets.push(bi);
              else job.hiddenBullets.splice(idx, 1);
              break;
            }
            case "school":
              cv.sections[si].schools[ji].hidden =
                !cv.sections[si].schools[ji].hidden;
              break;
            case "eduDetail": {
              const sch = cv.sections[si].schools[ji];
              if (!sch.hiddenDetails) sch.hiddenDetails = [];
              const idx = sch.hiddenDetails.indexOf(bi);
              if (idx === -1) sch.hiddenDetails.push(bi);
              else sch.hiddenDetails.splice(idx, 1);
              break;
            }
            case "leadership":
              cv.sections[si].items[ji].hidden =
                !cv.sections[si].items[ji].hidden;
              break;
            case "skill":
              cv.sections[si].skills[ji].hidden =
                !cv.sections[si].skills[ji].hidden;
              break;
          }
          renderEditor();
          renderPreview();
        }
        // ═══════════════════════════════════════════════════════
        // SKILLS OPERATIONS
        // ═══════════════════════════════════════════════════════
        function addSkill(si) {
          cv.sections[si].skills.push({ label: "", value: "" });
          renderEditor();
          renderPreview();
        }
        function removeSkill(si, ki) {
          cv.sections[si].skills.splice(ki, 1);
          renderEditor();
          renderPreview();
        }

        // ═══════════════════════════════════════════════════════
        // DRAG AND DROP — SECTIONS
        // ═══════════════════════════════════════════════════════
        let dragType = null,
          dragFrom = null;

        function dragSection(e, i) {
          dragType = "section";
          dragFrom = { si: i };
          e.dataTransfer.effectAllowed = "move";
          e.target.classList.add("dragging");
        }
        function dragOverSection(e, i) {
          if (dragType !== "section") return;
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
        }
        function dropSection(e, i) {
          if (dragType !== "section") return;
          e.preventDefault();
          const from = dragFrom.si;
          if (from === i) return;
          const item = cv.sections.splice(from, 1)[0];
          cv.sections.splice(i, 0, item);
          renderEditor();
          renderPreview();
        }

        // DRAG — JOBS
        function dragJob(e, si, ji) {
          dragType = "job";
          dragFrom = { si, ji };
          e.dataTransfer.effectAllowed = "move";
          e.stopPropagation();
          e.target.classList.add("dragging");
        }
        function dragOverJob(e, si, ji) {
          if (dragType !== "job" || dragFrom.si !== si) return;
          e.preventDefault();
          e.stopPropagation();
        }
        function dropJob(e, si, ji) {
          if (dragType !== "job" || dragFrom.si !== si) return;
          e.preventDefault();
          e.stopPropagation();
          const from = dragFrom.ji;
          if (from === ji) return;
          const jobs = cv.sections[si].jobs;
          const item = jobs.splice(from, 1)[0];
          jobs.splice(ji, 0, item);
          renderEditor();
          renderPreview();
        }

        // DRAG — BULLETS
        function dragBullet(e, si, ji, bi) {
          dragType = "bullet";
          dragFrom = { si, ji, bi };
          e.dataTransfer.effectAllowed = "move";
          e.stopPropagation();
          e.target.classList.add("dragging");
        }
        function dragOverBullet(e, si, ji, bi) {
          if (dragType !== "bullet" || dragFrom.si !== si || dragFrom.ji !== ji)
            return;
          e.preventDefault();
          e.stopPropagation();
        }
        function dropBullet(e, si, ji, bi) {
          if (dragType !== "bullet" || dragFrom.si !== si || dragFrom.ji !== ji)
            return;
          e.preventDefault();
          e.stopPropagation();
          const from = dragFrom.bi;
          if (from === bi) return;
          const bullets = cv.sections[si].jobs[ji].bullets;
          const item = bullets.splice(from, 1)[0];
          bullets.splice(bi, 0, item);
          renderEditor();
          renderPreview();
        }

        function dragEnd(e) {
          dragType = null;
          dragFrom = null;
          document
            .querySelectorAll(".dragging")
            .forEach((el) => el.classList.remove("dragging"));
        }

        // ═══════════════════════════════════════════════════════
        // UTILITIES
        // ═══════════════════════════════════════════════════════
        function esc(s) {
          if (!s) return "";
          return s
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;");
        }

        function autoGrow(el) {
          el.style.height = "auto";
          el.style.height = el.scrollHeight + "px";
        }

        function toggleSection(header) {
          const body = header.nextElementSibling;
          const chevron = header.querySelector(".chevron");
          body.classList.toggle("collapsed");
          chevron.classList.toggle("open");
        }

        function setZoom(val) {
          zoomLevel = parseInt(val);
          var zoomValEl = document.getElementById("zoom-val");
          if (zoomValEl) zoomValEl.textContent = zoomLevel + "%";
          var zoomPctEl = document.getElementById("zoom-pct-label");
          if (zoomPctEl) zoomPctEl.textContent = zoomLevel + "%";
          var sliderEl = document.querySelector(".zoom-slider");
          if (sliderEl) sliderEl.value = zoomLevel;
          document.getElementById("paper").style.transform =
            `scale(${zoomLevel / 100})`;
          // Sync margin guide to same zoom transform
          var mg = document.getElementById("margin-guide");
          if (mg) mg.style.transform = `scale(${zoomLevel / 100})`;
        }

        function autoZoom() {
          const panel = document.querySelector(".paper-wrapper");
          const toolbar = document.querySelector(".toolbar");
          const stylePanel = document.getElementById("style-panel");
          const paperW = 793.7; // 210mm in px
          const paperH = 1122.5; // 297mm in px
          const availW = panel.clientWidth - 40;
          const spUsed =
            (toolbar ? toolbar.offsetHeight : 0) +
            (stylePanel && !stylePanel.classList.contains("collapsed")
              ? stylePanel.offsetHeight
              : 0);
          const availH = panel.clientHeight - spUsed - 40;
          const scaleW = availW / paperW;
          const scaleH = availH / paperH;
          const scale = Math.min(scaleW, scaleH);
          const zoom = Math.max(20, Math.min(200, Math.round(scale * 100)));
          setZoom(zoom);
        }

        // ===================================================
        // STYLE / TYPOGRAPHY CONTROLS
        // ===================================================
        function toggleStylePanel() {
          const panel = document.getElementById("style-panel");
          panel.classList.toggle("collapsed");
          setTimeout(autoZoom, 50);
        }

        function setStyleFont(prop, val) {
          userStyle[prop] = val;
          cv.style = JSON.parse(JSON.stringify(userStyle));
          renderPreview();
          schedulePreview();
        }

        function setStyleVal(prop, val) {
          userStyle[prop] = val;
          updateStyleValDisplay(prop, val);
          const btnMap = {
            bodySize: "btn-auto-fontsize",
            titleSize: "btn-auto-titlesize",
            bulletGap: "btn-auto-para",
            sectionGap: "btn-auto-section",
            margins: "btn-auto-margins",
            lineHeight: "btn-auto-lineheight",
          };
          const btnId = btnMap[prop];
          if (btnId) document.getElementById(btnId).classList.remove("active");
          cv.style = JSON.parse(JSON.stringify(userStyle));
          renderPreview();
          schedulePreview();
        }

        function toggleAuto(prop) {
          const btnMap = {
            bodySize: "btn-auto-fontsize",
            titleSize: "btn-auto-titlesize",
            bulletGap: "btn-auto-para",
            sectionGap: "btn-auto-section",
            margins: "btn-auto-margins",
            lineHeight: "btn-auto-lineheight",
          };
          if (userStyle[prop] === null) {
            const defaults = {
              bodySize: 7.5,
              titleSize: 9.5,
              bulletGap: 0.5,
              sectionGap: 5,
              margins: 10,
              lineHeight: 1.35,
            };
            userStyle[prop] = defaults[prop];
            document.getElementById(btnMap[prop]).classList.remove("active");
          } else {
            userStyle[prop] = null;
            document.getElementById(btnMap[prop]).classList.add("active");
          }
          updateStyleValDisplay(prop, userStyle[prop]);
          cv.style = JSON.parse(JSON.stringify(userStyle));
          renderPreview();
          schedulePreview();
        }

        function updateStyleValDisplay(prop, val) {
          const map = {
            bodySize: "style-font-size-val",
            titleSize: "style-title-size-val",
            bulletGap: "style-para-gap-val",
            sectionGap: "style-section-gap-val",
            margins: "style-margins-val",
            lineHeight: "style-line-height-val",
            letterSpacing: "style-letter-spacing-val",
          };
          const el = document.getElementById(map[prop]);
          if (!el) return;
          if (val === null) {
            el.textContent = "auto";
          } else if (prop === "letterSpacing") {
            el.textContent = val.toFixed(2) + "px";
          } else if (prop === "bodySize" || prop === "titleSize") {
            el.textContent = val.toFixed(1) + "pt";
          } else if (prop === "lineHeight") {
            el.textContent = val.toFixed(2);
          } else if (prop === "margins") {
            el.textContent = val.toFixed(1) + "mm";
          } else {
            el.textContent = val.toFixed(1) + "px";
          }
        }

        function syncStyleUI() {
          const bf = document.getElementById("style-body-font");
          const tf = document.getElementById("style-title-font");
          if (bf) {
            for (const opt of bf.options) {
              if (opt.value === userStyle.bodyFont) opt.selected = true;
            }
          }
          if (tf) {
            for (const opt of tf.options) {
              if (opt.value === userStyle.titleFont) opt.selected = true;
            }
          }
          document.getElementById("style-letter-spacing").value =
            userStyle.letterSpacing * 100;
          updateStyleValDisplay("letterSpacing", userStyle.letterSpacing);
          const syncSlider = (prop, sliderId, btnId, defVal) => {
            const slider = document.getElementById(sliderId);
            const btn = document.getElementById(btnId);
            if (userStyle[prop] !== null) {
              slider.value = userStyle[prop] * 10;
              btn.classList.remove("active");
              updateStyleValDisplay(prop, userStyle[prop]);
            } else {
              slider.value = defVal * 10;
              btn.classList.add("active");
              updateStyleValDisplay(prop, null);
            }
          };
          syncSlider("bodySize", "style-font-size", "btn-auto-fontsize", 7.5);
          syncSlider(
            "titleSize",
            "style-title-size",
            "btn-auto-titlesize",
            9.5,
          );
          syncSlider("bulletGap", "style-para-gap", "btn-auto-para", 0.5);
          syncSlider("sectionGap", "style-section-gap", "btn-auto-section", 5);
          syncSlider("margins", "style-margins", "btn-auto-margins", 10);
          syncSlider(
            "lineHeight",
            "style-line-height",
            "btn-auto-lineheight",
            1.35,
          );
          document.getElementById("chk-margins").checked =
            !!userStyle.showGuides;
          document
            .getElementById("margin-guide")
            .classList.toggle("visible", !!userStyle.showGuides);
          document.getElementById("chk-printborder").checked =
            !!userStyle.showPrintBorder;
          document
            .getElementById("print-border")
            .classList.toggle("visible", !!userStyle.showPrintBorder);
        }

        function toggleGuides(type) {
          if (type === "margins") {
            userStyle.showGuides =
              document.getElementById("chk-margins").checked;
            document
              .getElementById("margin-guide")
              .classList.toggle("visible", userStyle.showGuides);
          } else if (type === "printborder") {
            userStyle.showPrintBorder =
              document.getElementById("chk-printborder").checked;
            document
              .getElementById("print-border")
              .classList.toggle("visible", userStyle.showPrintBorder);
          }
          cv.style = JSON.parse(JSON.stringify(userStyle));
        }

        function updateMarginGuides(state) {
          const inner = document.getElementById("margin-guide-inner");
          if (!inner) return;
          const pctTop = (state.padV / 297) * 100;
          const pctBot = pctTop;
          const pctLeft = (state.padH / 210) * 100;
          const pctRight = pctLeft;
          inner.style.top = pctTop + "%";
          inner.style.left = pctLeft + "%";
          inner.style.right = pctRight + "%";
          inner.style.bottom = pctBot + "%";
        }

        function schedulePreview() {
          // Push undo snapshot before saving changes
          if (typeof pushUndoSnapshot === "function") pushUndoSnapshot();
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => {
            renderPreview();
            // Auto-save to current profile quietly
            if (activeProfile) {
              const profiles = getProfiles();
              profiles[activeProfile] = JSON.parse(JSON.stringify(cv));
              setProfiles(profiles);
            }
            localStorage.setItem("cv-editor-data", JSON.stringify(cv));
          }, 150);
        }

        function saveToStorage() {
          // Legacy: also saves to old key for backward compat
          localStorage.setItem("cv-editor-data", JSON.stringify(cv));
          if (activeProfile) {
            saveCurrentProfile(true);
          } else {
            alert("Saved! Use 'Save As' to save with a tag.");
          }
          syncToCloud();
        }

        // ═══════════════════════════════════════════════════════
        // PROFILE / TAG MANAGEMENT
        // ═══════════════════════════════════════════════════════
        function getProfiles() {
          try {
            return JSON.parse(localStorage.getItem(PROFILES_KEY) || "{}");
          } catch (e) {
            return {};
          }
        }

        function setProfiles(profiles, skipCloudSync) {
          localStorage.setItem(PROFILES_KEY, JSON.stringify(profiles));
          if (!skipCloudSync) syncToCloud();
        }

        function loadProfileList() {
          const sel = document.getElementById("profile-select");
          const profiles = getProfiles();
          const names = Object.keys(profiles).sort();
          sel.innerHTML = '<option value="">— Unsaved Draft —</option>';
          names.forEach((name) => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            if (name === activeProfile) opt.selected = true;
            sel.appendChild(opt);
          });
          updateProfileIndicator();
          // Update custom dropdown
          updateProfileDropdown();
        }

        function updateProfileDropdown() {
          var label = document.getElementById("profile-dropdown-label");
          var list = document.getElementById("profile-dropdown-list");
          if (!label || !list) return;
          label.textContent = activeProfile || "— Unsaved Draft —";
          var profiles = getProfiles();
          var names = Object.keys(profiles).sort();
          list.innerHTML = "";
          if (names.length === 0) {
            var emptyMsg = document.createElement("div");
            emptyMsg.style.cssText =
              "padding:8px 10px;color:var(--muted);font-size:11px;font-style:italic";
            emptyMsg.textContent = "No saved CVs yet";
            list.appendChild(emptyMsg);
          } else {
            // Add "Unsaved Draft" option
            var draftItem = document.createElement("button");
            draftItem.className =
              "profile-dropdown-item" + (!activeProfile ? " active" : "");
            draftItem.textContent = "— Unsaved Draft —";
            draftItem.onclick = function () {
              hideProfileDropdown();
              onProfileSelectChange("");
            };
            list.appendChild(draftItem);
            // Add all profiles
            names.forEach(function (name) {
              var item = document.createElement("button");
              item.className =
                "profile-dropdown-item" +
                (name === activeProfile ? " active" : "");
              var tags = getProfileTags(name);
              item.innerHTML =
                '<span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' +
                name +
                "</span>" +
                (tags.length
                  ? '<span class="tags-hint">' + tags.join(", ") + "</span>"
                  : "");
              item.onclick = function () {
                hideProfileDropdown();
                onProfileSelectChange(name);
              };
              list.appendChild(item);
            });
          }
          // Show "Replicate Active CV" only when a CV is loaded
          var replicateBtn = document.getElementById("replicate-cv-btn");
          if (replicateBtn) {
            replicateBtn.style.display = activeProfile ? "" : "none";
          }
        }

        function toggleProfileDropdown() {
          var menu = document.getElementById("profile-dropdown-menu");
          var isOpen = menu.classList.contains("open");
          if (isOpen) {
            menu.classList.remove("open");
            return;
          }
          // Position using fixed coords to escape stacking contexts
          var trigger = document.getElementById("profile-dropdown-trigger");
          var rect = trigger.getBoundingClientRect();
          menu.style.top = rect.bottom + 4 + "px";
          menu.style.left = rect.left + "px";
          menu.classList.add("open");
        }
        function hideProfileDropdown() {
          var menu = document.getElementById("profile-dropdown-menu");
          if (menu) menu.classList.remove("open");
        }
        // Close on outside click
        document.addEventListener("click", function (e) {
          var wrapper = document.getElementById("profile-dropdown-wrapper");
          if (wrapper && !wrapper.contains(e.target)) {
            hideProfileDropdown();
          }
        });

        function updateProfileIndicator() {
          const ind = document.getElementById("profile-indicator");
          if (ind) ind.textContent = activeProfile ? "🏷 " + activeProfile : "";
        }

        function loadProfile(name, silent) {
          if (!name) {
            // Switching to "unsaved draft" — load from legacy storage or default
            activeProfile = null;
            localStorage.removeItem(ACTIVE_KEY);
            const saved = localStorage.getItem("cv-editor-data");
            if (saved) {
              try {
                cv = JSON.parse(saved);
              } catch (e) {
                cv = JSON.parse(JSON.stringify(DEFAULT_CV));
              }
            } else {
              cv = JSON.parse(JSON.stringify(DEFAULT_CV));
            }
            // Restore style
            if (cv.style) {
              userStyle = Object.assign(
                JSON.parse(JSON.stringify(STYLE_DEFAULTS)),
                cv.style,
              );
            } else {
              userStyle = JSON.parse(JSON.stringify(STYLE_DEFAULTS));
            }
            syncStyleUI();
            renderEditor();
            renderPreview();
            updateProfileIndicator();
            return;
          }
          const profiles = getProfiles();
          if (profiles[name]) {
            cv = JSON.parse(JSON.stringify(profiles[name]));
            activeProfile = name;
            localStorage.setItem(ACTIVE_KEY, name);
            // Restore style
            if (cv.style) {
              userStyle = Object.assign(
                JSON.parse(JSON.stringify(STYLE_DEFAULTS)),
                cv.style,
              );
            } else {
              userStyle = JSON.parse(JSON.stringify(STYLE_DEFAULTS));
            }
            syncStyleUI();
            renderEditor();
            renderPreview();
            loadProfileList();
            if (!silent) {
              showToast("Loaded: " + name);
            }
          }
        }

        function saveAsProfile() {
          const suggested = activeProfile || "";
          const name = prompt(
            'Save CV with tag name (e.g. "Google AE", "Sales CV", "Consulting"):',
            suggested,
          );
          if (!name || !name.trim()) return;
          const tag = name.trim();
          const profiles = getProfiles();
          if (
            profiles[tag] &&
            !confirm('Overwrite existing profile "' + tag + '"?')
          )
            return;
          profiles[tag] = JSON.parse(JSON.stringify(cv));
          setProfiles(profiles);
          activeProfile = tag;
          localStorage.setItem(ACTIVE_KEY, tag);
          localStorage.setItem("cv-editor-data", JSON.stringify(cv));
          loadProfileList();
          showToast("Saved: " + tag);
        }

        function replicateActiveCV() {
          var baseName = activeProfile || "CV";
          var name = prompt(
            "Name for the replicated CV:",
            baseName + " (Copy)",
          );
          if (!name || !name.trim()) return;
          var tag = name.trim();
          var profiles = getProfiles();
          if (
            profiles[tag] &&
            !confirm('A CV named "' + tag + '" already exists. Overwrite?')
          )
            return;
          profiles[tag] = JSON.parse(JSON.stringify(cv));
          setProfiles(profiles);
          activeProfile = tag;
          localStorage.setItem(ACTIVE_KEY, tag);
          localStorage.setItem("cv-editor-data", JSON.stringify(cv));
          loadProfileList();
          showToast("Replicated as: " + tag);
        }

        function saveCurrentProfile(quiet) {
          if (!activeProfile) {
            saveAsProfile();
            return;
          }
          const profiles = getProfiles();
          profiles[activeProfile] = JSON.parse(JSON.stringify(cv));
          setProfiles(profiles);
          localStorage.setItem("cv-editor-data", JSON.stringify(cv));
          if (!quiet) showToast("Saved: " + activeProfile);
        }

        function deleteProfile() {
          const sel = document.getElementById("profile-select");
          const name = sel.value;
          if (!name) {
            alert("Select a profile to delete.");
            return;
          }
          if (!confirm('Delete profile "' + name + '"? This cannot be undone.'))
            return;
          const profiles = getProfiles();
          delete profiles[name];
          setProfiles(profiles);
          if (activeProfile === name) {
            activeProfile = null;
            localStorage.removeItem(ACTIVE_KEY);
          }
          loadProfileList();
          showToast("Deleted: " + name);
        }

        function showToast(msg) {
          let toast = document.getElementById("cv-toast");
          if (!toast) {
            toast = document.createElement("div");
            toast.id = "cv-toast";
            toast.style.cssText =
              "position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#22c55e;color:#fff;padding:8px 20px;border-radius:8px;font-size:12px;font-weight:600;z-index:9999;opacity:0;transition:opacity 0.3s;pointer-events:none;font-family:inherit;";
            document.body.appendChild(toast);
          }
          toast.textContent = msg;
          toast.style.opacity = "1";
          setTimeout(() => {
            toast.style.opacity = "0";
          }, 2000);
        }

        function resetToDefault() {
          if (!confirm("Reset to default CV data? All changes will be lost."))
            return;
          cv = JSON.parse(JSON.stringify(DEFAULT_CV));
          localStorage.removeItem("cv-editor-data");
          renderEditor();
          renderPreview();
        }

        function exportPDF() {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF({ unit: "mm", format: "a4" });
          const W = 210,
            H = 297;
          const s = lastAutoFitState || {
            padV: 10,
            padH: 14,
            nameSize: 15,
            contactSize: 7.5,
            contactMargin: 6,
            sectionTitleSize: 9.5,
            companySize: 8.5,
            roleSize: 8,
            bodySize: 7.5,
            sectionGap: 5,
            companyGap: 3,
            bulletGap: 0.5,
            lineHeight: 1.35,
          };
          const left = s.padH;
          const cW = W - 2 * s.padH;
          let y = s.padV;
          const ptToMm = 0.353;
          const lh = (sz) => sz * ptToMm * s.lineHeight;

          // NAME
          doc.setFont("helvetica", "bold");
          doc.setFontSize(s.nameSize);
          y += s.nameSize * ptToMm;
          doc.text(cv.name, W / 2, y, { align: "center" });
          y += 2;

          // CONTACT
          doc.setFont("helvetica", "normal");
          doc.setFontSize(s.contactSize);
          doc.setTextColor(85, 85, 85);
          y += s.contactSize * ptToMm;
          doc.text(cv.contact, W / 2, y, { align: "center" });
          y += s.contactMargin * ptToMm + 2;
          doc.setTextColor(0, 0, 0);

          // SECTIONS
          cv.sections.forEach((sec) => {
            if (sec.hidden) return;

            // Section title
            y += s.sectionGap * ptToMm;
            doc.setFont("helvetica", "bold");
            doc.setFontSize(s.sectionTitleSize);
            y += s.sectionTitleSize * ptToMm;
            doc.text(sec.title.toUpperCase(), left, y);
            y += 0.5;
            doc.setLineWidth(0.2);
            doc.line(left, y, W - s.padH, y);
            y += 2;

            if (sec.type === "summary") {
              doc.setFont("helvetica", "normal");
              doc.setFontSize(s.bodySize);
              const lines = doc.splitTextToSize(sec.content, cW);
              const lineH = lh(s.bodySize);
              lines.forEach((line) => {
                y += lineH;
                doc.text(line, left, y);
              });
              y += 1;
            } else if (sec.type === "jobs") {
              sec.jobs.forEach((job) => {
                if (job.hidden) return;
                // Company
                y += s.companyGap * ptToMm;
                doc.setFont("helvetica", "bold");
                doc.setFontSize(s.companySize);
                y += s.companySize * ptToMm;
                doc.text(job.company, left, y);
                // Role
                doc.setFont("helvetica", "bolditalic");
                doc.setFontSize(s.roleSize);
                doc.setTextColor(51, 51, 51);
                y += s.roleSize * ptToMm;
                doc.text(job.role, left, y);
                doc.setTextColor(0, 0, 0);
                y += 0.5;
                // Bullets
                doc.setFont("helvetica", "normal");
                doc.setFontSize(s.bodySize);
                const lineH = lh(s.bodySize);
                job.bullets.forEach((b, bi) => {
                  if ((job.hiddenBullets || []).includes(bi)) return;
                  const wrapped = doc.splitTextToSize("- " + b, cW - 5);
                  wrapped.forEach((line, li) => {
                    y += lineH;
                    doc.text(line, left + (li === 0 ? 0 : 3), y);
                  });
                  y += s.bulletGap * ptToMm;
                });
              });
            } else if (sec.type === "education") {
              sec.schools.forEach((sch) => {
                if (sch.hidden) return;
                y += s.companyGap * ptToMm;
                doc.setFont("helvetica", "bold");
                doc.setFontSize(s.companySize);
                y += s.companySize * ptToMm;
                doc.text(sch.institution, left, y);
                doc.setFont("helvetica", "bolditalic");
                doc.setFontSize(s.roleSize);
                doc.setTextColor(51, 51, 51);
                y += s.roleSize * ptToMm;
                doc.text(sch.degree, left, y);
                doc.setTextColor(0, 0, 0);
                y += 0.5;
                doc.setFont("helvetica", "normal");
                doc.setFontSize(s.bodySize);
                const lineH = lh(s.bodySize);
                (sch.details || []).forEach((d, di) => {
                  if ((sch.hiddenDetails || []).includes(di)) return;
                  const wrapped = doc.splitTextToSize("- " + d, cW - 5);
                  wrapped.forEach((line, li) => {
                    y += lineH;
                    doc.text(line, left + (li === 0 ? 0 : 3), y);
                  });
                  y += s.bulletGap * ptToMm;
                });
              });
            } else if (sec.type === "leadership") {
              doc.setFont("helvetica", "normal");
              doc.setFontSize(s.bodySize);
              const lineH = lh(s.bodySize);
              sec.items.forEach((item) => {
                if (item.hidden) return;
                const text = item.name + " \u2014 " + item.desc;
                const wrapped = doc.splitTextToSize(text, cW);
                wrapped.forEach((line) => {
                  y += lineH;
                  doc.text(line, left, y);
                });
                y += s.bulletGap * ptToMm;
              });
            } else if (sec.type === "skills") {
              doc.setFontSize(s.bodySize);
              const lineH = lh(s.bodySize);
              sec.skills.forEach((sk) => {
                if (sk.hidden) return;
                doc.setFont("helvetica", "bold");
                const labelW = doc.getTextWidth(sk.label + " ");
                doc.text(sk.label, left, y + lineH);
                doc.setFont("helvetica", "normal");
                const valLines = doc.splitTextToSize(
                  " " + sk.value,
                  cW - labelW,
                );
                doc.text(valLines[0], left + labelW, y + lineH);
                y += lineH;
                for (let i = 1; i < valLines.length; i++) {
                  y += lineH;
                  doc.text(valLines[i], left, y);
                }
                y += s.bulletGap * ptToMm;
              });
            }
          });

          const filename = (activeProfile || "cv-draft") + ".pdf";
          doc.save(filename);
          showToast("PDF exported: " + filename);
        }

        /* ═══ PROFILE EXPORT / IMPORT ═══ */
        function exportProfiles() {
          const profiles = getProfiles();
          const keys = Object.keys(profiles);
          if (keys.length === 0) {
            alert("No saved profiles to export.");
            return;
          }
          const blob = new Blob([JSON.stringify(profiles, null, 2)], {
            type: "application/json",
          });
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = "cv-profiles-backup.json";
          a.click();
          URL.revokeObjectURL(a.href);
          showToast("Exported " + keys.length + " profile(s)");
        }

        function importProfiles() {
          const input = document.createElement("input");
          input.type = "file";
          input.accept = ".json";
          input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
              try {
                const imported = JSON.parse(ev.target.result);
                if (typeof imported !== "object" || Array.isArray(imported))
                  throw new Error("Bad format");
                const existing = getProfiles();
                let count = 0;
                for (const [name, data] of Object.entries(imported)) {
                  if (existing[name]) {
                    if (
                      !confirm(
                        'Profile "' + name + '" already exists. Overwrite?',
                      )
                    )
                      continue;
                  }
                  existing[name] = data;
                  count++;
                }
                setProfiles(existing);
                loadProfileList();
                showToast("Imported " + count + " profile(s)");
              } catch (err) {
                alert("Invalid file: " + err.message);
              }
            };
            reader.readAsText(file);
          };
          input.click();
        }

        // Keyboard shortcut: Cmd+S to save current profile
        document.addEventListener("keydown", (e) => {
          if ((e.metaKey || e.ctrlKey) && e.key === "s") {
            e.preventDefault();
            saveCurrentProfile();
          }
          if ((e.metaKey || e.ctrlKey) && e.key === "z" && !e.shiftKey) {
            e.preventDefault();
            undoCV();
          }
          if ((e.metaKey || e.ctrlKey) && e.key === "z" && e.shiftKey) {
            e.preventDefault();
            redoCV();
          }
        });

        // ═══════════════════════════════════════════════════════
        // UNDO / REDO SYSTEM
        // ═══════════════════════════════════════════════════════
        var undoStack = [];
        var redoStack = [];
        var lastSnapshotJSON = "";

        function pushUndoSnapshot() {
          var snap = JSON.stringify(cv);
          if (snap === lastSnapshotJSON) return; // no change
          undoStack.push(lastSnapshotJSON);
          if (undoStack.length > 50) undoStack.shift();
          redoStack = [];
          lastSnapshotJSON = snap;
          updateUndoRedoButtons();
        }

        function undoCV() {
          if (undoStack.length === 0) return;
          redoStack.push(JSON.stringify(cv));
          var prev = undoStack.pop();
          cv = JSON.parse(prev);
          lastSnapshotJSON = prev;
          renderEditor();
          renderPreview();
          updateUndoRedoButtons();
        }

        function redoCV() {
          if (redoStack.length === 0) return;
          undoStack.push(JSON.stringify(cv));
          var next = redoStack.pop();
          cv = JSON.parse(next);
          lastSnapshotJSON = next;
          renderEditor();
          renderPreview();
          updateUndoRedoButtons();
        }

        function updateUndoRedoButtons() {
          var ub = document.getElementById("undo-btn");
          var rb = document.getElementById("redo-btn");
          if (ub) ub.disabled = undoStack.length === 0;
          if (rb) rb.disabled = redoStack.length === 0;
        }

        // Hook into editor changes to push snapshots
        var _origAutoSave = typeof autoSave === "function" ? autoSave : null;
        // We'll monkey-patch later after init

        // ═══════════════════════════════════════════════════════
        // SIGN IN DROPDOWN
        // ═══════════════════════════════════════════════════════
        function toggleSignInMenu() {
          var dd = document.getElementById("sign-in-dropdown");
          dd.classList.toggle("open");
        }
        // Close dropdown on outside click
        document.addEventListener("click", function (e) {
          var wrapper = document.getElementById("sign-in-wrapper");
          var dd = document.getElementById("sign-in-dropdown");
          if (wrapper && dd && !wrapper.contains(e.target)) {
            dd.classList.remove("open");
          }
        });

        // ═══════════════════════════════════════════════════════
        // PROFILE SELECT WITH "+ New CV" OPTION
        // ═══════════════════════════════════════════════════════
        function onProfileSelectChange(val) {
          if (val === "__new__") {
            document.getElementById("profile-select").value =
              activeProfile || "";
            showNewCVModal();
            return;
          }
          loadProfile(val);
        }

        // Override loadProfileList to add "+ New CV" as first option
        var _origLoadProfileList = loadProfileList;
        function loadProfileListWithNew() {
          var sel = document.getElementById("profile-select");
          var profiles = getProfiles();
          var names = Object.keys(profiles).sort();
          sel.innerHTML = "";
          // Add "+ New CV" as first option
          var newOpt = document.createElement("option");
          newOpt.value = "__new__";
          newOpt.textContent = "+ Create New CV";
          newOpt.style.color = "#22c55e";
          newOpt.style.fontWeight = "600";
          sel.appendChild(newOpt);
          // separator
          var sep = document.createElement("option");
          sep.disabled = true;
          sep.textContent = "───────────";
          sel.appendChild(sep);
          // profiles
          names.forEach(function (name) {
            var opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            var tags = getProfileTags(name);
            if (tags.length > 0)
              opt.textContent += "  [" + tags.join(", ") + "]";
            if (name === activeProfile) opt.selected = true;
            sel.appendChild(opt);
          });
          // If no active profile, leave on first real profile
          if (activeProfile && names.includes(activeProfile)) {
            sel.value = activeProfile;
          } else if (names.length > 0) {
            // don't auto-select __new__
          }
          updateProfileIndicator();
        }
        // Replace the original
        loadProfileList = loadProfileListWithNew;

        // ═══════════════════════════════════════════════════════
        // DELETE CONFIRMATION (POPUP)
        // ═══════════════════════════════════════════════════════
        var pendingDeleteName = null;

        function confirmDeleteProfile() {
          var sel = document.getElementById("profile-select");
          var name = sel.value;
          if (!name || name === "__new__") {
            showToast("Select a CV to delete.");
            return;
          }
          pendingDeleteName = name;
          document.getElementById("delete-confirm-msg").textContent =
            'Are you sure you want to delete "' +
            name +
            '"? This cannot be undone.';
          document.getElementById("delete-confirm-modal").classList.add("open");
        }

        function hideDeleteConfirm() {
          document
            .getElementById("delete-confirm-modal")
            .classList.remove("open");
          pendingDeleteName = null;
        }

        function executeDeleteProfile() {
          if (!pendingDeleteName) return;
          var profiles = getProfiles();
          delete profiles[pendingDeleteName];
          // Also delete tags
          var allTags = getProfileTagsMap();
          delete allTags[pendingDeleteName];
          localStorage.setItem("cv-profile-tags", JSON.stringify(allTags));
          setProfiles(profiles);
          if (activeProfile === pendingDeleteName) {
            activeProfile = null;
            localStorage.removeItem(ACTIVE_KEY);
          }
          loadProfileList();
          showToast("Deleted: " + pendingDeleteName);
          hideDeleteConfirm();
        }

        // ═══════════════════════════════════════════════════════
        // TAG SYSTEM
        // ═══════════════════════════════════════════════════════
        function getProfileTagsMap() {
          try {
            return JSON.parse(localStorage.getItem("cv-profile-tags") || "{}");
          } catch (e) {
            return {};
          }
        }

        function getProfileTags(profileName) {
          var map = getProfileTagsMap();
          return map[profileName] || [];
        }

        function setProfileTags(profileName, tags) {
          var map = getProfileTagsMap();
          map[profileName] = tags;
          localStorage.setItem("cv-profile-tags", JSON.stringify(map));
          syncToCloud();
        }

        function getAllUniqueTags() {
          var map = getProfileTagsMap();
          var s = new Set();
          Object.values(map).forEach(function (tags) {
            tags.forEach(function (t) {
              s.add(t);
            });
          });
          return Array.from(s).sort();
        }

        // Tag editor modal
        var tagEditorProfile = null;

        function openTagEditor(profileName) {
          tagEditorProfile = profileName;
          document.getElementById("tag-editor-profile-name").textContent =
            profileName;
          renderTagEditor();
          document.getElementById("tag-editor-modal").classList.add("open");
          document.getElementById("tag-editor-input").focus();
        }

        function closeTagEditor() {
          document.getElementById("tag-editor-modal").classList.remove("open");
          tagEditorProfile = null;
          // Refresh dashboard if open
          if (
            document
              .getElementById("dashboard-overlay")
              .classList.contains("open")
          ) {
            renderDashboard();
          }
          loadProfileList();
        }

        function renderTagEditor() {
          var container = document.getElementById("tag-editor-tags");
          var tags = getProfileTags(tagEditorProfile);
          container.innerHTML = "";
          tags.forEach(function (t) {
            var span = document.createElement("span");
            span.className = "tag-removable";
            span.innerHTML =
              t +
              ' <span class="remove-tag" onclick="removeTagFromProfile(\'' +
              t.replace(/'/g, "\\'") +
              "')\">&times;</span>";
            container.appendChild(span);
          });
          if (tags.length === 0) {
            container.innerHTML =
              '<span style="font-size:10px;color:var(--muted)">No tags yet</span>';
          }
        }

        function addTagToProfile() {
          var input = document.getElementById("tag-editor-input");
          var tag = input.value.trim().toLowerCase();
          if (!tag || !tagEditorProfile) return;
          var tags = getProfileTags(tagEditorProfile);
          if (!tags.includes(tag)) {
            tags.push(tag);
            setProfileTags(tagEditorProfile, tags);
          }
          input.value = "";
          renderTagEditor();
        }

        function removeTagFromProfile(tag) {
          if (!tagEditorProfile) return;
          var tags = getProfileTags(tagEditorProfile).filter(function (t) {
            return t !== tag;
          });
          setProfileTags(tagEditorProfile, tags);
          renderTagEditor();
        }

        // ═══ TOOLBAR TAG BUTTON HELPER ═══
        function openTagEditorForActive() {
          if (!activeProfile) {
            alert("Save your CV first before adding tags.");
            return;
          }
          openTagEditor(activeProfile);
        }

        // ═══════════════════════════════════════════════════════
        // JOB CONTEXT
        // ═══════════════════════════════════════════════════════
        var jobContext = JSON.parse(
          localStorage.getItem("cv-job-context") || "null",
        ) || { title: "", company: "", description: "" };

        function showJobContextModal() {
          document.getElementById("job-ctx-title").value =
            jobContext.title || "";
          document.getElementById("job-ctx-company").value =
            jobContext.company || "";
          document.getElementById("job-ctx-desc").value =
            jobContext.description || "";
          document.getElementById("job-context-modal").classList.add("open");
          document.getElementById("job-ctx-title").focus();
          updateJobContextLabel();
        }

        function hideJobContextModal() {
          document.getElementById("job-context-modal").classList.remove("open");
        }

        function saveJobContext() {
          jobContext.title = document
            .getElementById("job-ctx-title")
            .value.trim();
          jobContext.company = document
            .getElementById("job-ctx-company")
            .value.trim();
          jobContext.description = document
            .getElementById("job-ctx-desc")
            .value.trim();
          localStorage.setItem("cv-job-context", JSON.stringify(jobContext));
          hideJobContextModal();
          updateJobContextLabel();
        }

        function clearJobContext() {
          jobContext = { title: "", company: "", description: "" };
          localStorage.removeItem("cv-job-context");
          document.getElementById("job-ctx-title").value = "";
          document.getElementById("job-ctx-company").value = "";
          document.getElementById("job-ctx-desc").value = "";
          hideJobContextModal();
          updateJobContextLabel();
        }

        function updateJobContextLabel() {
          var label = document.getElementById("job-context-label");
          var btn = document.getElementById("toolbar-job-context-btn");
          if (!label) return;
          if (jobContext.title || jobContext.company) {
            var txt = jobContext.title || "";
            if (jobContext.company)
              txt += (txt ? " @ " : "") + jobContext.company;
            // Truncate to keep the button compact
            if (txt.length > 24) txt = txt.substring(0, 22) + "…";
            label.textContent = txt;
            label.style.color = "#22c55e";
            // Show full text on hover
            if (btn)
              btn.title =
                (jobContext.title || "") +
                (jobContext.company ? " @ " + jobContext.company : "");
          } else {
            label.textContent = "Job Context";
            label.style.color = "";
            if (btn) btn.title = "Set target job for AI tailoring";
          }
        }

        function hasJobContext() {
          return !!(
            jobContext.title ||
            jobContext.company ||
            jobContext.description
          );
        }

        // ═══════════════════════════════════════════════════════
        // DASHBOARD
        // ═══════════════════════════════════════════════════════
        var dashboardFilterTag = null;

        function showDashboard() {
          renderDashboard();
          document.getElementById("dashboard-overlay").classList.add("open");
        }

        function hideDashboard() {
          document.getElementById("dashboard-overlay").classList.remove("open");
        }

        function renderDashboard() {
          var profiles = getProfiles();
          var names = Object.keys(profiles).sort();
          var query = (
            document.getElementById("dashboard-search").value || ""
          ).toLowerCase();
          var allTags = getAllUniqueTags();

          // Render tag filter pills
          var tagsContainer = document.getElementById("dashboard-tags");
          tagsContainer.innerHTML = "";
          if (allTags.length > 0) {
            var allPill = document.createElement("span");
            allPill.className =
              "tag-pill" + (dashboardFilterTag === null ? " active" : "");
            allPill.textContent = "All";
            allPill.onclick = function () {
              dashboardFilterTag = null;
              renderDashboard();
            };
            tagsContainer.appendChild(allPill);
            allTags.forEach(function (t) {
              var pill = document.createElement("span");
              pill.className =
                "tag-pill" + (dashboardFilterTag === t ? " active" : "");
              pill.textContent = t;
              pill.onclick = function () {
                dashboardFilterTag = dashboardFilterTag === t ? null : t;
                renderDashboard();
              };
              tagsContainer.appendChild(pill);
            });
          }

          // Filter names
          var filtered = names.filter(function (name) {
            if (query && !name.toLowerCase().includes(query)) return false;
            if (dashboardFilterTag) {
              var tags = getProfileTags(name);
              if (!tags.includes(dashboardFilterTag)) return false;
            }
            return true;
          });

          // Render grid
          var grid = document.getElementById("cv-grid");
          grid.innerHTML = "";

          // "+ New CV" card always first
          var newCard = document.createElement("div");
          newCard.className = "cv-card new-cv-card";
          newCard.style.cssText =
            "display:flex;flex-direction:column;align-items:center;gap:8px;cursor:default";
          var newBtnHTML =
            '<div onclick="hideDashboard();showNewCVModal()" style="cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px;width:100%">' +
            '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>' +
            '<span style="font-size:12px;font-weight:600">Create New CV</span></div>';
          if (activeProfile) {
            newBtnHTML +=
              '<div style="border-top:1px solid var(--border);width:100%;padding-top:8px;margin-top:2px">' +
              '<button onclick="event.stopPropagation();hideDashboard();replicateActiveCV()" style="background:transparent;border:1px solid var(--border);border-radius:6px;color:var(--muted);font-size:10px;padding:4px 10px;cursor:pointer;font-family:inherit;width:100%;display:flex;align-items:center;justify-content:center;gap:4px">' +
              '<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>' +
              "Duplicate Active</button></div>";
          }
          newCard.innerHTML = newBtnHTML;
          grid.appendChild(newCard);

          filtered.forEach(function (name) {
            var card = document.createElement("div");
            card.className = "cv-card";
            var data = profiles[name];
            var subtitle = "";
            if (data && data.contact) {
              subtitle = data.contact.name || "";
            }
            var tags = getProfileTags(name);
            var tagsHTML = tags
              .map(function (t) {
                return '<span class="tag-pill">' + t + "</span>";
              })
              .join("");
            var escapedName = name.replace(/'/g, "\\'").replace(/"/g, "&quot;");

            card.innerHTML =
              '<div style="display:flex;justify-content:space-between;align-items:start">' +
              '<div class="cv-card-title">' +
              escapeHtml(name) +
              "</div>" +
              '<div class="cv-card-menu-wrapper" style="position:relative">' +
              '<button class="cv-card-menu-btn" onclick="event.stopPropagation();toggleCardMenu(this)" title="Options" style="padding:2px 6px;background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:14px;line-height:1;border-radius:4px">⋯</button>' +
              '<div class="cv-card-context-menu" style="display:none;position:absolute;right:0;top:100%;background:#1e1e1e;border:1px solid #333;border-radius:6px;min-width:130px;z-index:100;box-shadow:0 4px 12px rgba(0,0,0,0.4);overflow:hidden">' +
              "<button onclick=\"event.stopPropagation();hideAllCardMenus();hideDashboard();loadProfile('" +
              escapedName +
              '\')" style="display:block;width:100%;padding:8px 12px;border:none;background:transparent;color:#e0e0e0;font-size:11px;text-align:left;cursor:pointer;font-family:inherit">Open</button>' +
              "<button onclick=\"event.stopPropagation();hideAllCardMenus();openTagEditor('" +
              escapedName +
              '\')" style="display:block;width:100%;padding:8px 12px;border:none;background:transparent;color:#e0e0e0;font-size:11px;text-align:left;cursor:pointer;font-family:inherit">Edit Tags</button>' +
              "<button onclick=\"event.stopPropagation();hideAllCardMenus();duplicateCV('" +
              escapedName +
              '\')" style="display:block;width:100%;padding:8px 12px;border:none;background:transparent;color:#e0e0e0;font-size:11px;text-align:left;cursor:pointer;font-family:inherit">Duplicate</button>' +
              '<div style="border-top:1px solid #333"></div>' +
              "<button onclick=\"event.stopPropagation();hideAllCardMenus();deleteCVFromDashboard('" +
              escapedName +
              '\')" style="display:block;width:100%;padding:8px 12px;border:none;background:transparent;color:#ef4444;font-size:11px;text-align:left;cursor:pointer;font-family:inherit">Delete</button>' +
              "</div>" +
              "</div></div>" +
              (subtitle
                ? '<div class="cv-card-subtitle">' +
                  escapeHtml(subtitle) +
                  "</div>"
                : "") +
              (tagsHTML
                ? '<div class="cv-card-tags">' + tagsHTML + "</div>"
                : "");
            card.onclick = function () {
              hideDashboard();
              loadProfile(name);
            };
            grid.appendChild(card);
          });
        }

        function filterDashboard() {
          renderDashboard();
        }

        function toggleCardMenu(btn) {
          var menu = btn.nextElementSibling;
          var isOpen = menu.style.display !== "none";
          hideAllCardMenus();
          if (!isOpen) menu.style.display = "block";
        }

        function hideAllCardMenus() {
          document
            .querySelectorAll(".cv-card-context-menu")
            .forEach(function (m) {
              m.style.display = "none";
            });
        }

        function deleteCVFromDashboard(name) {
          if (!confirm('Delete "' + name + '"? This cannot be undone.')) return;
          var profiles = getProfiles();
          delete profiles[name];
          setProfiles(profiles);
          // Remove tags
          var tagsMap = getProfileTagsMap();
          delete tagsMap[name];
          localStorage.setItem("cv-tags", JSON.stringify(tagsMap));
          // If this was the active profile, clear it
          if (activeProfile === name) {
            activeProfile = null;
            localStorage.removeItem(ACTIVE_KEY);
            cv = JSON.parse(JSON.stringify(DEFAULT_CV));
            renderEditor();
            renderPreview();
          }
          loadProfileList();
          renderDashboard();
        }

        function duplicateCV(name) {
          var profiles = getProfiles();
          if (!profiles[name]) return;
          var copyName = name + " (copy)";
          var i = 2;
          while (profiles[copyName]) {
            copyName = name + " (copy " + i + ")";
            i++;
          }
          profiles[copyName] = JSON.parse(JSON.stringify(profiles[name]));
          setProfiles(profiles);
          // Copy tags too
          var tags = getProfileTags(name);
          if (tags.length > 0) {
            setProfileTags(copyName, tags.slice());
          }
          loadProfileList();
          renderDashboard();
        }

        // Close card menus on outside click
        document.addEventListener("click", function () {
          hideAllCardMenus();
        });

        // ═══════════════════════════════════════════════════════
        // OLLAMA AUTO-SETUP
        // ═══════════════════════════════════════════════════════
        var ollamaAutoRetryTimer = null;

        async function startOllamaAutoSetup() {
          // CORS: Ollama only works locally
          if (
            window.location.protocol === "https:" &&
            !window.location.hostname.match(/^(localhost|127\.0\.0\.1)$/)
          ) {
            var statusEl = document.getElementById("ollama-status");
            statusEl.innerHTML =
              '<span style="color:#f59e0b">Ollama requires running locally.</span><br>To use Ollama, open this page at <code>http://localhost</code> or use <code>python -m http.server</code>.<br>For cloud AI, switch to <b>Groq</b> or <b>Cerebras</b> above — both are free.';
            return;
          }
          var btn = document.getElementById("ollama-start-btn");
          btn.disabled = true;
          btn.textContent = "Setting up...";
          clearInterval(ollamaAutoRetryTimer);

          // Step 1: Check if Ollama is reachable
          markOllamaStep(1, "active");
          var ollamaRunning = false;
          try {
            var resp = await fetch("http://localhost:11434/api/tags", {
              signal: AbortSignal.timeout(3000),
            });
            if (resp.ok) ollamaRunning = true;
          } catch (e) {}

          if (!ollamaRunning) {
            markOllamaStep(1, "error");
            var statusEl = document.getElementById("ollama-status");
            statusEl.innerHTML =
              '<span style="color:#ef4444;font-weight:600">Ollama is not running.</span><br>' +
              '<span style="color:var(--muted)">Open Terminal and run:</span><br>' +
              '<div style="display:flex;gap:4px;margin-top:4px"><code id="ollama-cmd" style="font-size:10px;flex:1;background:#111;padding:4px 8px;border-radius:4px;color:#e0e0e0;word-break:break-all">brew install ollama && ollama serve</code>' +
              '<button class="btn btn-sm btn-secondary" onclick="copyOllamaCmd()" style="font-size:9px;padding:2px 8px;white-space:nowrap" id="copy-cmd-btn">Copy</button></div>' +
              '<div style="margin-top:6px;color:var(--accent);font-size:9px">Waiting for Ollama to start — will auto-connect...</div>';
            btn.disabled = false;
            btn.innerHTML =
              '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-1px"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.13-9.36L23 10"/></svg> Retry Now';
            // Auto-poll every 3 seconds
            ollamaAutoRetryTimer = setInterval(async function () {
              try {
                var r = await fetch("http://localhost:11434/api/tags", {
                  signal: AbortSignal.timeout(2000),
                });
                if (r.ok) {
                  clearInterval(ollamaAutoRetryTimer);
                  startOllamaAutoSetup(); // re-run full setup
                }
              } catch (e) {}
            }, 3000);
            return;
          }
          markOllamaStep(1, "done");

          // Step 2: Server is already running
          markOllamaStep(2, "done");

          // Step 3: Detect models
          markOllamaStep(3, "active");
          await detectOllamaModels();
          if (!ollamaModel) {
            markOllamaStep(3, "error");
            var statusEl = document.getElementById("ollama-status");
            statusEl.innerHTML =
              '<span style="color:#f59e0b;font-weight:600">No models found.</span><br>' +
              '<span style="color:var(--muted)">Run in Terminal:</span><br>' +
              '<div style="display:flex;gap:4px;margin-top:4px"><code id="ollama-cmd" style="font-size:10px;flex:1;background:#111;padding:4px 8px;border-radius:4px;color:#e0e0e0">ollama pull llama3.1:8b</code>' +
              '<button class="btn btn-sm btn-secondary" onclick="copyOllamaCmd()" style="font-size:9px;padding:2px 8px;white-space:nowrap" id="copy-cmd-btn">Copy</button></div>' +
              '<div style="margin-top:6px;color:var(--accent);font-size:9px">Waiting for model download — will auto-connect...</div>';
            btn.disabled = false;
            btn.innerHTML =
              '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-1px"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.13-9.36L23 10"/></svg> Retry Now';
            // Auto-poll every 5 seconds for models
            ollamaAutoRetryTimer = setInterval(async function () {
              try {
                var r = await fetch("http://localhost:11434/api/tags", {
                  signal: AbortSignal.timeout(2000),
                });
                if (r.ok) {
                  var data = await r.json();
                  if (data.models && data.models.length > 0) {
                    clearInterval(ollamaAutoRetryTimer);
                    startOllamaAutoSetup(); // re-run full setup
                  }
                }
              } catch (e) {}
            }, 5000);
            return;
          }
          markOllamaStep(3, "done");

          // Step 4: Connect
          markOllamaStep(4, "active");
          await connectAI();
          markOllamaStep(4, "done");

          btn.disabled = false;
          btn.innerHTML =
            '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-1px"><polyline points="20 6 9 17 4 12"/></svg> Connected!';
          btn.style.background = "#22c55e";
          document.getElementById("ollama-status").innerHTML =
            '<span style="color:#22c55e">Connected to ' +
            (ollamaModel || "Ollama") +
            "</span>";
        }

        function copyOllamaCmd() {
          var cmd = document.getElementById("ollama-cmd");
          if (cmd) {
            navigator.clipboard.writeText(cmd.textContent).then(function () {
              var btn = document.getElementById("copy-cmd-btn");
              if (btn) {
                btn.textContent = "Copied!";
                setTimeout(function () {
                  btn.textContent = "Copy";
                }, 2000);
              }
            });
          }
        }

        function markOllamaStep(num, state) {
          var step = document.getElementById("ollama-step-" + num);
          if (!step) return;
          step.className = "ollama-step " + state;
          var icon = step.querySelector(".step-icon");
          if (state === "done") icon.textContent = "✓";
          else if (state === "error") icon.textContent = "✕";
          else if (state === "active") icon.textContent = "…";
        }

        // NOTE: init() moved to end of script (after AI config vars)

        // ═══════════════════════════════════════════════════════
        // AI CHAT ASSISTANT
        // ═══════════════════════════════════════════════════════
        var aiConnected = false;
        var aiProvider = "ollama";
        var agentMode = true; // show inline suggestions on editor
        var aiApiKey = "";
        var chatHistory = []; // {role, content}
        var chatAttachments = []; // {name, text}
        var aiStreaming = false;
        var pendingChanges = []; // diff suggestions
        var premiumThinking = false; // reasoning mode toggle
        var ollamaModel = ""; // selected Ollama model

        // Dual-model system: CHAT model (fast) for conversation, EDIT model (best) for CV changes
        var AI_CHAT_MODELS = {
          openai: "gpt-4o-mini",
          gemini: "gemini-2.5-flash",
          claude: "claude-sonnet-4-20250514",
          groq: "llama-3.3-70b-versatile",
          openrouter: "meta-llama/llama-3.3-70b-instruct:free",
          cerebras: "llama-3.3-70b",
          ollama: "auto", // resolved at runtime from ollamaModel
        };

        var AI_EDIT_MODELS = {
          openai: "gpt-4o",
          gemini: "gemini-2.5-pro",
          claude: "claude-opus-4-20250514",
          groq: "llama-3.3-70b-versatile",
          openrouter: "meta-llama/llama-3.3-70b-instruct:free",
          cerebras: "llama-3.3-70b",
          ollama: "auto",
        };

        // 🧠 Premium Thinking: reasoning/extended thinking models
        var AI_THINKING_MODELS = {
          openai: "o3",
          gemini: "gemini-2.5-pro", // same model, but with thinkingConfig
          claude: "claude-opus-4-20250514", // same model, but with extended thinking
          groq: "qwen/qwen3-32b",
          openrouter: "deepseek/deepseek-r1:free",
          cerebras: "llama-3.3-70b", // no reasoning model on cerebras
          ollama: "auto",
        };

        var AI_MODEL_LABELS = {
          openai: {
            chat: "GPT-4o Mini",
            edit: "GPT-4o",
            thinking: "o3 (reasoning)",
          },
          gemini: {
            chat: "Gemini 2.5 Flash",
            edit: "Gemini 2.5 Pro",
            thinking: "Gemini 2.5 Pro (deep think)",
          },
          claude: {
            chat: "Sonnet 4",
            edit: "Opus 4",
            thinking: "Opus 4 (extended thinking)",
          },
          groq: {
            chat: "Llama 3.3 70B",
            edit: "Llama 3.3 70B",
            thinking: "Qwen3 32B",
          },
          openrouter: {
            chat: "Llama 3.3 70B",
            edit: "Llama 3.3 70B",
            thinking: "DeepSeek R1 (free)",
          },
          cerebras: {
            chat: "Llama 3.3 70B",
            edit: "Llama 3.3 70B",
            thinking: "Llama 3.3 70B",
          },
          ollama: {
            chat: "Local Model",
            edit: "Local Model",
            thinking: "Local Model",
          },
        };

        var AI_ENDPOINTS = {
          openai: "https://api.openai.com/v1/chat/completions",
          gemini: null, // special handling
          claude: "https://api.anthropic.com/v1/messages",
          groq: "https://api.groq.com/openai/v1/chat/completions",
          openrouter: "https://openrouter.ai/api/v1/chat/completions",
          cerebras: "https://api.cerebras.ai/v1/chat/completions",
          ollama: "http://localhost:11434/v1/chat/completions",
        };

        // ═══ OLLAMA MODEL DETECTION ═══
        // Ranked preference for Ollama models (best first)
        var OLLAMA_MODEL_RANK = [
          "qwen2.5:72b",
          "llama3.3:70b",
          "deepseek-r1:70b",
          "qwen3:72b",
          "deepseek-r1:32b",
          "qwen2.5:32b",
          "qwen3:32b",
          "llama3.1:70b",
          "deepseek-r1:14b",
          "qwen2.5:14b",
          "phi4:14b",
          "gemma2:27b",
          "mistral-small:22b",
          "qwen2.5:7b",
          "llama3.1:8b",
          "gemma2:9b",
          "phi3:14b",
          "llama3.2:3b",
          "qwen2.5:3b",
          "phi3:3.8b",
        ];

        async function detectOllamaModels() {
          // CORS: Ollama only works on localhost — skip on HTTPS remote origins
          if (
            window.location.protocol === "https:" &&
            !window.location.hostname.match(/^(localhost|127\.0\.0\.1)$/)
          ) {
            const status = document.getElementById("ollama-status");
            status.innerHTML =
              "⚠️ Ollama requires running the site locally. Use a cloud provider instead.";
            status.style.color = "#f59e0b";
            return;
          }
          const sel = document.getElementById("ollama-model-select");
          const status = document.getElementById("ollama-status");
          status.textContent = "🔄 Detecting...";
          status.style.color = "#f59e0b";
          try {
            const resp = await fetch("http://localhost:11434/api/tags", {
              signal: AbortSignal.timeout(3000),
            });
            if (!resp.ok) throw new Error("Ollama not responding");
            const data = await resp.json();
            const models = (data.models || []).map((m) => m.name);
            if (models.length === 0) {
              status.textContent =
                "⚠️ No models installed. Run: ollama pull qwen2.5:32b";
              status.style.color = "#ef4444";
              return;
            }
            // Sort by preference rank
            models.sort((a, b) => {
              const aR = OLLAMA_MODEL_RANK.findIndex((r) => a.startsWith(r));
              const bR = OLLAMA_MODEL_RANK.findIndex((r) => b.startsWith(r));
              return (aR === -1 ? 999 : aR) - (bR === -1 ? 999 : bR);
            });
            sel.innerHTML = "";
            models.forEach((m) => {
              const opt = document.createElement("option");
              opt.value = m;
              const sizeTag = m.includes(":")
                ? m.split(":")[1].toUpperCase()
                : "";
              const isReasoning =
                m.includes("deepseek-r1") || m.includes("qwen3");
              opt.textContent = m + (isReasoning ? " 🧠" : "");
              sel.appendChild(opt);
            });
            ollamaModel = models[0];
            sel.value = ollamaModel;
            sel.onchange = () => {
              ollamaModel = sel.value;
            };
            // Update labels
            const shortName = ollamaModel.split(":")[0];
            AI_MODEL_LABELS.ollama = {
              chat: shortName,
              edit: shortName,
              thinking: shortName + " 🧠",
            };
            status.textContent =
              "✅ Found " + models.length + " model(s) — best: " + ollamaModel;
            status.style.color = "#22c55e";
          } catch (e) {
            status.innerHTML =
              "❌ Ollama not running. Start it: <code>ollama serve</code>";
            status.style.color = "#ef4444";
          }
        }

        // Detect if message needs CV editing (uses EDIT model) vs general chat
        function needsEditModel(userMsg) {
          const editKeywords =
            /tailor|change|edit|improve|modify|update|rewrite|rephrase|optimize|fix|replace|adjust|bullet|summary|job description|JD|role|position|application|hired|ATS/i;
          return editKeywords.test(userMsg);
        }

        function toggleChatPanel() {
          const p = document.getElementById("chat-panel");
          const b = document.getElementById("toggle-chat-btn");
          p.classList.toggle("collapsed");
          b.style.display = p.classList.contains("collapsed") ? "" : "none";
        }

        var AI_KEY_URLS = {
          groq: "https://console.groq.com/keys",
          cerebras: "https://cloud.cerebras.ai",
          openrouter: "https://openrouter.ai/keys",
          gemini: "https://aistudio.google.com/apikey",
          openai: "https://platform.openai.com/api-keys",
          claude: "https://console.anthropic.com",
          ollama: null,
        };

        function onProviderChange() {
          aiProvider = document.getElementById("ai-provider").value;
          aiConnected = false;
          updateAIStatus("disconnected", "● Not connected");
          onThinkingToggle(); // update label
          // Show/hide Ollama model selector and API key
          const isOllama = aiProvider === "ollama";
          document.getElementById("ollama-model-row").style.display = isOllama
            ? ""
            : "none";
          document.getElementById("api-key-row").style.display = isOllama
            ? "none"
            : "";
          // Update "Get free key" link
          const keyLink = document.getElementById("get-key-link");
          if (AI_KEY_URLS && AI_KEY_URLS[aiProvider]) {
            keyLink.href = AI_KEY_URLS[aiProvider];
            keyLink.style.display = "";
            const isFree = [
              "groq",
              "cerebras",
              "openrouter",
              "gemini",
            ].includes(aiProvider);
            keyLink.textContent = isFree
              ? "Get free API key →"
              : "Get API key →";
          } else {
            keyLink.style.display = "none";
          }
          // Restore saved API key for this provider
          if (!isOllama) {
            try {
              var savedKeys = JSON.parse(
                localStorage.getItem("cv-ai-keys") || "{}",
              );
              var keyInput = document.getElementById("ai-api-key");
              if (keyInput && savedKeys[aiProvider]) {
                keyInput.value = savedKeys[aiProvider];
              } else if (keyInput) {
                keyInput.value = "";
              }
            } catch (e) {}
          }
          // Update advanced model selectors
          updateModelSelectors();
        }

        // Available models per provider (populated after connect or from defaults)
        var availableModels = {};

        function updateModelSelectors() {
          var chatSel = document.getElementById("model-chat");
          var editSel = document.getElementById("model-edit");
          var thinkingSel = document.getElementById("model-thinking");
          var note = document.getElementById("model-note");
          if (!chatSel || !editSel || !thinkingSel) return;

          // Build model options from available models or defaults
          var models =
            availableModels[aiProvider] || getDefaultModels(aiProvider);
          var currentChat =
            (AI_CHAT_MODELS && AI_CHAT_MODELS[aiProvider]) || "";
          var currentEdit =
            (AI_EDIT_MODELS && AI_EDIT_MODELS[aiProvider]) || "";
          var currentThinking =
            (AI_THINKING_MODELS && AI_THINKING_MODELS[aiProvider]) || "";

          function fillSelect(sel, current) {
            sel.innerHTML = "";
            models.forEach(function (m) {
              var opt = document.createElement("option");
              opt.value = m;
              opt.textContent = m;
              if (m === current) opt.selected = true;
              sel.appendChild(opt);
            });
            // If current model not in list, add it
            if (current && !models.includes(current)) {
              var opt = document.createElement("option");
              opt.value = current;
              opt.textContent = current + " (current)";
              opt.selected = true;
              sel.insertBefore(opt, sel.firstChild);
            }
          }

          fillSelect(chatSel, currentChat);
          fillSelect(editSel, currentEdit);
          fillSelect(thinkingSel, currentThinking);

          if (availableModels[aiProvider]) {
            note.textContent = models.length + " models available";
          } else {
            note.textContent =
              "Showing defaults — connect to fetch available models";
          }
        }

        function getDefaultModels(provider) {
          // Return the hardcoded models as options
          var list = [];
          if (AI_CHAT_MODELS && AI_CHAT_MODELS[provider])
            list.push(AI_CHAT_MODELS[provider]);
          if (
            AI_EDIT_MODELS &&
            AI_EDIT_MODELS[provider] &&
            !list.includes(AI_EDIT_MODELS[provider])
          )
            list.push(AI_EDIT_MODELS[provider]);
          if (
            AI_THINKING_MODELS &&
            AI_THINKING_MODELS[provider] &&
            !list.includes(AI_THINKING_MODELS[provider])
          )
            list.push(AI_THINKING_MODELS[provider]);
          return list;
        }

        function onCustomModelChange(role, model) {
          if (!model) return;
          if (role === "chat" && AI_CHAT_MODELS)
            AI_CHAT_MODELS[aiProvider] = model;
          if (role === "edit" && AI_EDIT_MODELS)
            AI_EDIT_MODELS[aiProvider] = model;
          if (role === "thinking" && AI_THINKING_MODELS)
            AI_THINKING_MODELS[aiProvider] = model;
          // Update labels
          if (AI_MODEL_LABELS && AI_MODEL_LABELS[aiProvider]) {
            var short = model.split("/").pop().split(":")[0];
            AI_MODEL_LABELS[aiProvider][role] = short;
          }
          // Save custom model choices
          try {
            var saved = JSON.parse(
              localStorage.getItem("cv-ai-models") || "{}",
            );
            if (!saved[aiProvider]) saved[aiProvider] = {};
            saved[aiProvider][role] = model;
            localStorage.setItem("cv-ai-models", JSON.stringify(saved));
          } catch (e) {}
        }

        async function fetchAvailableModels(provider, key) {
          try {
            if (provider === "groq") {
              var resp = await fetch("https://api.groq.com/openai/v1/models", {
                headers: { Authorization: "Bearer " + key },
                signal: AbortSignal.timeout(8000),
              });
              if (resp.ok) {
                var data = await resp.json();
                return data.data
                  .map(function (m) {
                    return m.id;
                  })
                  .sort();
              }
            } else if (provider === "openai") {
              var resp = await fetch("https://api.openai.com/v1/models", {
                headers: { Authorization: "Bearer " + key },
                signal: AbortSignal.timeout(8000),
              });
              if (resp.ok) {
                var data = await resp.json();
                return data.data
                  .filter(function (m) {
                    return (
                      m.id.includes("gpt") ||
                      m.id.includes("o3") ||
                      m.id.includes("o1") ||
                      m.id.includes("o4")
                    );
                  })
                  .map(function (m) {
                    return m.id;
                  })
                  .sort();
              }
            } else if (provider === "cerebras") {
              var resp = await fetch("https://api.cerebras.ai/v1/models", {
                headers: { Authorization: "Bearer " + key },
                signal: AbortSignal.timeout(8000),
              });
              if (resp.ok) {
                var data = await resp.json();
                return data.data
                  .map(function (m) {
                    return m.id;
                  })
                  .sort();
              }
            } else if (provider === "openrouter") {
              var resp = await fetch("https://openrouter.ai/api/v1/models", {
                signal: AbortSignal.timeout(8000),
              });
              if (resp.ok) {
                var data = await resp.json();
                return data.data
                  .filter(function (m) {
                    return m.id.includes("free") || m.pricing?.prompt === "0";
                  })
                  .map(function (m) {
                    return m.id;
                  })
                  .sort()
                  .slice(0, 50);
              }
            }
          } catch (e) {}
          return null;
        }

        function onThinkingToggle() {
          premiumThinking = document.getElementById(
            "ai-premium-thinking",
          ).checked;
          const label = document.getElementById("thinking-label");
          if (premiumThinking) {
            const modelName =
              AI_MODEL_LABELS && AI_MODEL_LABELS[aiProvider]
                ? AI_MODEL_LABELS[aiProvider].thinking
                : "thinking model";
            label.textContent = "ON — " + modelName;
            label.style.color = "#f59e0b";
          } else {
            label.textContent = "Off — faster responses";
            label.style.color = "var(--muted)";
          }
        }

        function updateAIStatus(cls, text) {
          const el = document.getElementById("ai-status");
          el.className = "connect-status " + cls;
          el.textContent = text;
        }

        async function validateApiKey(provider, key) {
          // Make a minimal API call to verify the key works
          if (!AI_ENDPOINTS || !AI_CHAT_MODELS) {
            throw new Error("AI config not loaded — refresh the page");
          }
          try {
            if (
              provider === "openai" ||
              provider === "groq" ||
              provider === "openrouter" ||
              provider === "cerebras"
            ) {
              var endpoint = AI_ENDPOINTS[provider];
              if (!endpoint)
                throw new Error("No endpoint configured for " + provider);
              var resp = await fetch(endpoint, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: "Bearer " + key,
                },
                body: JSON.stringify({
                  model: AI_CHAT_MODELS[provider],
                  messages: [{ role: "user", content: "Hi" }],
                  max_tokens: 1,
                }),
                signal: AbortSignal.timeout(10000),
              });
              if (resp.status === 401 || resp.status === 403) return false;
              if (resp.ok) return true;
              // Some providers return 400 for bad model but key is still valid
              var body = await resp.text();
              if (
                body.includes("invalid") &&
                (body.includes("key") ||
                  body.includes("api_key") ||
                  body.includes("token"))
              )
                return false;
              return true; // if it's a 400 for other reasons, key is likely valid
            } else if (provider === "claude") {
              var resp = await fetch("https://api.anthropic.com/v1/messages", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "x-api-key": key,
                  "anthropic-version": "2023-06-01",
                  "anthropic-dangerous-direct-browser-access": "true",
                },
                body: JSON.stringify({
                  model: AI_CHAT_MODELS[provider],
                  max_tokens: 1,
                  messages: [{ role: "user", content: "Hi" }],
                }),
                signal: AbortSignal.timeout(10000),
              });
              if (resp.status === 401 || resp.status === 403) return false;
              return true;
            } else if (provider === "gemini") {
              var model = AI_CHAT_MODELS[provider];
              var url =
                "https://generativelanguage.googleapis.com/v1beta/models/" +
                model +
                ":generateContent?key=" +
                key;
              var resp = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  contents: [{ parts: [{ text: "Hi" }] }],
                  generationConfig: { maxOutputTokens: 1 },
                }),
                signal: AbortSignal.timeout(10000),
              });
              if (resp.status === 400 || resp.status === 403) {
                var body = await resp.text();
                if (
                  body.includes("API_KEY_INVALID") ||
                  body.includes("PERMISSION_DENIED")
                )
                  return false;
              }
              return resp.ok;
            }
            return true;
          } catch (e) {
            if (e.name === "TimeoutError" || e.name === "AbortError")
              throw new Error("Timed out — check your internet");
            throw e;
          }
        }

        async function connectAI() {
          const keyInput = document.getElementById("ai-api-key");
          aiProvider = document.getElementById("ai-provider").value;

          if (aiProvider === "ollama") {
            // CORS check
            if (
              window.location.protocol === "https:" &&
              !window.location.hostname.match(/^(localhost|127\.0\.0\.1)$/)
            ) {
              updateAIStatus(
                "error",
                "● Ollama only works on localhost. Use Groq (free) or OpenRouter (free) instead — they work anywhere!",
              );
              return;
            }
            // Ollama: no API key needed
            aiApiKey = "ollama"; // placeholder
            if (!ollamaModel) {
              // Try auto-detect first
              try {
                await detectOllamaModels();
              } catch (e) {}
            }
            if (!ollamaModel) {
              // Default fallback model
              ollamaModel = "llama3.1:8b";
            }
            // Resolve "auto" model references
            AI_CHAT_MODELS.ollama = ollamaModel;
            AI_EDIT_MODELS.ollama = ollamaModel;
            AI_THINKING_MODELS.ollama = ollamaModel;
            const shortName = ollamaModel.split(":")[0];
            AI_MODEL_LABELS.ollama = {
              chat: shortName,
              edit: shortName,
              thinking: shortName + " 🧠",
            };
          } else {
            aiApiKey = keyInput.value.trim();
            if (!aiApiKey) {
              updateAIStatus("error", "● Enter an API key");
              return;
            }
            // Validate API key with a lightweight test call
            updateAIStatus("disconnected", "● Validating key...");
            try {
              var valid = await validateApiKey(aiProvider, aiApiKey);
              if (!valid) {
                updateAIStatus(
                  "error",
                  "● Wrong API key — make sure you're using a valid key from your " +
                    aiProvider.charAt(0).toUpperCase() +
                    aiProvider.slice(1) +
                    " dashboard",
                );
                aiConnected = false;
                return;
              }
            } catch (e) {
              var errMsg = e.message || "unknown error";
              // Make error messages user-friendly
              if (
                errMsg.includes("properties of undefined") ||
                errMsg.includes("not loaded")
              ) {
                errMsg =
                  "Page didn't load correctly — please refresh and try again";
              } else if (
                errMsg.includes("Timed out") ||
                errMsg.includes("timeout") ||
                errMsg.includes("AbortError")
              ) {
                errMsg =
                  "Connection timed out — check your internet connection";
              } else if (
                errMsg.includes("Failed to fetch") ||
                errMsg.includes("NetworkError")
              ) {
                errMsg =
                  "Network error — check your internet or the API might be down";
              } else if (
                errMsg.includes("401") ||
                errMsg.includes("403") ||
                errMsg.includes("invalid") ||
                errMsg.includes("key")
              ) {
                errMsg =
                  "Wrong API key — double-check you copied the full key from your provider's dashboard";
              }
              updateAIStatus("error", "● " + errMsg);
              aiConnected = false;
              return;
            }
          }

          aiConnected = true;
          // Save API key per provider in localStorage
          if (aiProvider !== "ollama" && aiApiKey) {
            try {
              var savedKeys = JSON.parse(
                localStorage.getItem("cv-ai-keys") || "{}",
              );
              savedKeys[aiProvider] = aiApiKey;
              localStorage.setItem("cv-ai-keys", JSON.stringify(savedKeys));
              localStorage.setItem("cv-ai-provider", aiProvider);
            } catch (e) {}
          }
          // Fetch available models in background
          if (aiProvider !== "ollama") {
            fetchAvailableModels(aiProvider, aiApiKey).then(function (models) {
              if (models && models.length > 0) {
                availableModels[aiProvider] = models;
                updateModelSelectors();
              }
            });
          }
          // Restore any saved custom model choices
          try {
            var savedModels = JSON.parse(
              localStorage.getItem("cv-ai-models") || "{}",
            );
            if (savedModels[aiProvider]) {
              if (savedModels[aiProvider].chat && AI_CHAT_MODELS)
                AI_CHAT_MODELS[aiProvider] = savedModels[aiProvider].chat;
              if (savedModels[aiProvider].edit && AI_EDIT_MODELS)
                AI_EDIT_MODELS[aiProvider] = savedModels[aiProvider].edit;
              if (savedModels[aiProvider].thinking && AI_THINKING_MODELS)
                AI_THINKING_MODELS[aiProvider] =
                  savedModels[aiProvider].thinking;
            }
          } catch (e) {}
          updateModelSelectors();
          var labels =
            AI_MODEL_LABELS && AI_MODEL_LABELS[aiProvider]
              ? AI_MODEL_LABELS[aiProvider]
              : { chat: "chat", edit: "edit", thinking: "thinking" };
          var statusText = "● Connected";
          if (aiProvider === "ollama") {
            statusText += " — 🏠 " + ollamaModel;
          } else if (labels.chat === labels.edit) {
            statusText += " — " + labels.edit;
          } else {
            statusText += " — Chat: " + labels.chat + " | Edit: " + labels.edit;
          }
          updateAIStatus("connected", statusText);
          // Update compact status in config summary and collapse
          document.getElementById("ai-status-compact").innerHTML =
            '<span style="color:#22c55e">●</span> ' +
            statusText.replace("● Connected — ", "");
          document.getElementById("chat-config").removeAttribute("open");
          document.getElementById("chat-send-btn").disabled = false;
          // Clear chat & send greeting
          chatHistory = [];
          const msgs = document.getElementById("chat-messages");
          msgs.innerHTML = "";
          var greeting = hasJobContext()
            ? "Ready to optimize for " +
              (jobContext.title || "your target role") +
              (jobContext.company ? " at " + jobContext.company : "") +
              ". What would you like to improve?"
            : "What role are you targeting? This helps me tailor every suggestion.";
          appendChatMsg("assistant", greeting);
        }

        function appendChatMsg(role, text, extraHTML) {
          const msgs = document.getElementById("chat-messages");
          const div = document.createElement("div");
          div.className = "chat-msg " + role;
          // Simple markdown-ish rendering
          let html = escapeHtml(text)
            .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
            .replace(/`(.+?)`/g, "<code>$1</code>")
            .replace(/\n/g, "<br>");
          div.innerHTML = html + (extraHTML || "");
          msgs.appendChild(div);
          msgs.scrollTop = msgs.scrollHeight;
          return div;
        }

        function escapeHtml(t) {
          return t
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
        }

        function autoGrow(el) {
          el.style.height = "36px";
          el.style.height = Math.min(el.scrollHeight, 120) + "px";
        }

        // ═══ ATTACHMENTS ═══
        function handleAttachment(input) {
          Array.from(input.files).forEach(function (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              const text = e.target.result;
              chatAttachments.push({
                name: file.name,
                text: text.substring(0, 15000),
              });
              renderAttachments();
            };
            reader.readAsText(file);
          });
          input.value = "";
        }

        function renderAttachments() {
          const el = document.getElementById("chat-attachments");
          el.innerHTML = chatAttachments
            .map(function (a, i) {
              return (
                '<span class="chat-attachment-tag">📄 ' +
                escapeHtml(a.name) +
                ' <span class="remove-att" onclick="removeAttachment(' +
                i +
                ')">✕</span></span>'
              );
            })
            .join("");
        }

        function removeAttachment(i) {
          chatAttachments.splice(i, 1);
          renderAttachments();
        }

        // ═══ BUILD CV CONTEXT FOR AI ═══
        function buildCVContext() {
          let ctx =
            "CURRENT CV DATA (JSON):\n```json\n" +
            JSON.stringify(cv, null, 2) +
            "\n```\n\n";
          ctx += "ACTIVE PROFILE: " + (activeProfile || "Unsaved Draft") + "\n";
          // Include profile tags
          if (activeProfile) {
            var tags = getProfileTags(activeProfile);
            if (tags.length > 0) {
              ctx += "CV TAGS: " + tags.join(", ") + "\n";
            }
          }
          // Include job context if set
          if (hasJobContext()) {
            ctx += "\n═══ TARGET JOB CONTEXT ═══\n";
            if (jobContext.title)
              ctx += "Target Role: " + jobContext.title + "\n";
            if (jobContext.company)
              ctx += "Target Company: " + jobContext.company + "\n";
            if (jobContext.description)
              ctx += "Job Description:\n" + jobContext.description + "\n";
            ctx += "═══ END JOB CONTEXT ═══\n\n";
          }
          if (chatAttachments.length > 0) {
            ctx += "\nATTACHED DOCUMENTS:\n";
            chatAttachments.forEach(function (a) {
              ctx += "--- " + a.name + " ---\n" + a.text + "\n--- END ---\n\n";
            });
          }
          return ctx;
        }

        function buildSystemPrompt() {
          const isPremium =
            document.getElementById("ai-thinking-toggle")?.checked;
          return (
            `You are a world-class executive CV strategist — the absolute best in the industry. You are not a generic assistant. You are THE expert that Fortune 500 executives pay $5,000/hour to optimize their resumes. You have access to Tomás Batalha's full CV data below.

YOUR MISSION: Deliver suggestions so precise, so strategically brilliant, that every single change measurably increases interview callback rates. Do NOT give generic advice. Every suggestion must be surgical, evidence-based, and immediately actionable.

═══════════════════════════════════════
SUGGESTION FORMAT (MANDATORY)
═══════════════════════════════════════
When suggesting changes, ALWAYS use this exact JSON format wrapped in a code block:
\`\`\`json:changes
[
  {
    "path": "sections[0].content",
    "label": "Professional Summary",
    "before": "exact current text",
    "after": "suggested new text"
  }
]
\`\`\`

Path format:
- "sections[0].content" → professional summary text
- "sections[1].jobs[0].bullets[2]" → specific bullet point
- "sections[1].jobs[0].role" → job title
- "sections[1].jobs[0].company" → company name
- "name" → candidate name field
- "title" → headline/title field

CRITICAL: The "before" field MUST be a character-perfect match of the current CV text. Copy it exactly — including punctuation, spacing, and symbols.

═══════════════════════════════════════
QUALITY STANDARDS (NON-NEGOTIABLE)
═══════════════════════════════════════

1. QUANTIFICATION IS SACRED
   - NEVER remove numbers, metrics, percentages, or dollar amounts
   - ALWAYS preserve or enhance quantified achievements
   - If a bullet lacks metrics, suggest adding them with a note asking the user to confirm the numbers
   - Good: "Drove $2.4M pipeline through strategic outbound campaigns across 3 verticals"
   - Bad: "Drove significant pipeline through outbound campaigns"

2. ACTION VERB MASTERY
   - First word of every bullet MUST be a powerful, varied action verb
   - NEVER repeat the same verb within a section. Track verb usage across all bullets.
   - Tier 1 (leadership): Spearheaded, Orchestrated, Championed, Pioneered, Architected
   - Tier 2 (execution): Engineered, Accelerated, Negotiated, Captured, Mobilized
   - Tier 3 (results): Delivered, Generated, Secured, Converted, Exceeded
   - FORBIDDEN generic verbs: Helped, Worked on, Was responsible for, Assisted, Participated

3. STAR METHOD ENFORCEMENT
   - Every bullet should follow: [Action Verb] + [What You Did] + [How/Method] + [Quantified Result]
   - Weak: "Managed sales team that hit targets"
   - Strong: "Scaled 8-person outbound sales team to 140% of quarterly quota ($1.2M) by implementing structured discovery frameworks and weekly pipeline reviews"

4. ATS OPTIMIZATION
   - When a job description is provided, extract the TOP 15 keywords and key phrases
   - Map each keyword to where it can be naturally woven into the CV
   - Prioritize: exact keyword matches > semantic matches > implied skills
   - Never keyword-stuff — every keyword must read naturally in context
   - Flag any critical JD requirements that the CV doesn't currently address

5. STRATEGIC POSITIONING
   - Tailor the professional summary to mirror the target role's language and priorities
   - Lead with the most relevant experience for the specific role
   - Frame startup experience as enterprise-relevant (scrappy → resourceful, wore many hats → cross-functional leadership)
   - Position Google/Amazon experience prominently for credibility halo effect

6. CONCISION & IMPACT
   - Maximum 2 lines per bullet point (aim for 1.5 lines when printed)
   - Cut filler words ruthlessly: "in order to" → "to", "was able to" → delete, "responsible for" → [action verb]
   - Every word must earn its place. If removing a word doesn't change the meaning, remove it.

7. CONSISTENCY & POLISH
   - Maintain consistent tense: past tense for previous roles, present for current
   - Consistent formatting: all bullets start with verb, all end without period, or all with period
   - No orphan bullets — each job should have 3-5 impactful bullets
   - Check for repeated phrases across the entire CV, not just within sections

${
  isPremium
    ? `
═══════════════════════════════════════
🧠 PREMIUM THINKING MODE ACTIVE
═══════════════════════════════════════
You are operating in DEEP ANALYSIS mode with extended reasoning. Take your time.

BEFORE suggesting any changes:
1. ANALYZE the full CV holistically — identify the narrative arc and positioning strategy
2. COMPARE against best-in-class CVs for the target role level and industry
3. IDENTIFY the 3 biggest weaknesses and the 3 strongest assets
4. THINK about what a hiring manager at this specific company would scan for in the first 6 seconds
5. CONSIDER ATS parsing — will the format and keywords survive automated screening?
6. EVALUATE competitive positioning — how does this CV differentiate from 200+ other applicants?

Then deliver your suggestions ranked by IMPACT (highest impact first).
For each suggestion, briefly explain WHY this change matters and what signal it sends to the hiring manager.

Your suggestions should be so good that a professional CV writer would be impressed.
`
    : ""
}
═══════════════════════════════════════
INTERACTION STYLE
═══════════════════════════════════════
- Be CONCISE. Maximum 3-5 suggestions per response unless the user asks for a full review.
- Always show a 1-2 sentence strategic explanation BEFORE the changes block. No lengthy analysis.
- Group related changes together (e.g., "Summary Alignment" or "Bullet Impact Boost")
- Do NOT output keyword analysis tables unless the user explicitly asks for one. Just use the keywords silently when crafting suggestions.
- Be direct and confident. No hedging. No "you might consider..." — say "Change this to X because Y."
- If a suggestion requires user input (e.g., confirming a metric), flag it clearly with [CONFIRM: ...]

CRITICAL RULES:
- NEVER repeat the same content more than once. If you find yourself listing the same section twice, STOP.
- Keep responses under 400 words total. Be surgical, not verbose.
- NEVER dump raw JSON from the CV back at the user. Only show relevant snippets.
- When greeting the user, respond in 1 sentence max. Do NOT repeat your initial greeting — the app already showed one.
- If the user says "hi" or greets you, respond in 1 SHORT sentence and ask what they want to change. Do NOT ask what role they're targeting if job context is already set.
- If the user says something casual/off-topic, respond briefly and redirect to CV work.
- ALWAYS output json:changes blocks when the user asks for any CV modification. This is an AI-powered editor — make the edits, don't just describe them.
- NEVER start working without the user asking you to. Wait for a clear request before suggesting changes.
- If the user redirects you ("you already know", "it's in the context", etc.), acknowledge briefly in 1 sentence and ask what specific changes they want. Do NOT dump all possible improvements at once.
- When asked to "improve" or "review" the CV, pick the TOP 3 highest-impact changes only. Offer to continue with more if the user wants.

═══════════════════════════════════════
⚡ CONTEXT-FIRST APPROACH (MANDATORY)
═══════════════════════════════════════
` +
            (hasJobContext()
              ? `TARGET JOB CONTEXT IS ALREADY SET (see "TARGET JOB CONTEXT" section in the CV data below).
Do NOT ask the user what role they are targeting — you ALREADY HAVE THIS INFORMATION.
Use this context to tailor every suggestion. Reference the target role/company naturally.
When greeting the user, say something like: "Ready to optimize for [role] at [company]. What would you like to improve?"`
              : `There is NO target job context set yet.
Your FIRST response to any CV-related request MUST ask:
- "What role are you targeting?" (job title)
- "Which company?" (optional but helpful)
Only AFTER getting this context should you start making suggestions.
If the user says "improve my CV" without context, ask for the target role first.
If the user just says "hi", respond briefly and ask what role they're targeting.`) +
            `

` +
            (agentMode
              ? `
═══════════════════════════════════════
🤖 AGENT MODE IS ACTIVE — INLINE SUGGESTIONS
═══════════════════════════════════════
Agent Mode is ON. Your suggestions appear as inline overlays directly on the CV editor fields.
Each suggestion shows the current text with a strikethrough and your proposed text below it.
The user accepts or rejects each one individually.

AGENT MODE RULES:
1. WAIT for the user to ask for changes before suggesting anything. A greeting or casual message is NOT a request.
2. When asked to improve, review each field and propose SMALL, SURGICAL tweaks — not rewrites. Improve 1-3 words, tighten phrasing, add a metric, or strengthen the verb.
3. The "before" field MUST be a PERFECT character-for-character copy of the current text. Copy it exactly from the CV JSON above.
4. Keep suggestions to 3-5 per response. Focus on the HIGHEST IMPACT changes only.
5. Each "after" should be a clear improvement: stronger verb, tighter phrasing, added metric, or better ATS keywords.
6. Do NOT output keyword analysis tables. Silently use job description keywords when crafting your suggestions.

🔑 EXPLAIN EACH CHANGE (MANDATORY):
After the json:changes block, add a numbered explanation list. For EACH suggestion, write:
**1. [Label]** — Why: [1-2 sentence explanation of why this specific change increases interview chances]
**2. [Label]** — Why: [explanation]
...and so on for every change.

Example format:
\\\`\\\`\\\`json:changes
[{"path": "sections[1].jobs[0].bullets[0]", "label": "Google bullet 1", "before": "Led team...", "after": "Spearheaded cross-functional team..."}]
\\\`\\\`\\\`

**Why each change matters:**
1. **Google bullet 1** — "Spearheaded" signals initiative and ownership, which SDR hiring managers look for. "Cross-functional" adds enterprise complexity that matches the job requirements.

8. NEVER suggest changes where before === after. Every suggestion must actually change something.
9. Prefer SMALL improvements over rewrites. The user wants to see what you'd tweak, not a new CV.
`
              : "") +
            buildCVContext()
          );
        }

        // ═══ LOOP DETECTION ═══
        function detectAndTruncateLoop(text) {
          // Detect repeated blocks (same 80+ char substring appearing 3+ times)
          if (text.length < 500) return text;
          // Check for repeated JSON skills blocks (common failure mode)
          const chunks = text.split("\n\n");
          const seen = {};
          let cleanChunks = [];
          let loopDetected = false;
          for (const chunk of chunks) {
            const key = chunk.trim().substring(0, 120);
            if (key.length > 60) {
              seen[key] = (seen[key] || 0) + 1;
              if (seen[key] > 2) {
                loopDetected = true;
                continue; // skip repeated chunk
              }
            }
            cleanChunks.push(chunk);
          }
          let result = cleanChunks.join("\n\n");
          // Hard cap at 4000 chars for safety
          if (result.length > 4000) {
            result =
              result.substring(0, 4000) + "\n\n[Response truncated — too long]";
            loopDetected = true;
          }
          if (loopDetected) {
            result +=
              "\n\n⚠️ *Repetitive content was detected and removed. Try a more specific question, or switch to a better model.*";
          }
          return result;
        }

        // ═══ SEND MESSAGE ═══
        async function sendMessage() {
          if (!aiConnected || aiStreaming) return;
          const input = document.getElementById("chat-input");
          const text = input.value.trim();
          if (!text) return;
          input.value = "";
          input.style.height = "36px";

          appendChatMsg("user", text);
          chatHistory.push({ role: "user", content: text });

          aiStreaming = true;
          document.getElementById("chat-send-btn").disabled = true;

          // Determine which model to use
          const useEditModel = needsEditModel(text);
          let modelType;
          if (premiumThinking) {
            modelType = "thinking";
          } else if (useEditModel) {
            modelType = "edit";
          } else {
            modelType = "chat";
          }
          const modelLabel =
            AI_MODEL_LABELS && AI_MODEL_LABELS[aiProvider]
              ? AI_MODEL_LABELS[aiProvider][modelType]
              : modelType;
          const modeTag =
            modelType === "thinking"
              ? " 🧠 deep reasoning"
              : modelType === "edit"
                ? " (edit mode)"
                : "";
          const thinkingDiv = appendChatMsg(
            "assistant",
            "⏳ Thinking with " + modelLabel + modeTag + "...",
          );

          try {
            let response = await callAI(chatHistory, modelType);
            // Loop detection — truncate garbage responses
            response = detectAndTruncateLoop(response);
            thinkingDiv.remove();

            // Parse response for changes
            const changesMatch = response.match(
              /```json:changes\n([\s\S]*?)```/,
            );
            let messageText = response;
            let changesHTML = "";

            if (changesMatch) {
              messageText = response
                .replace(/```json:changes\n[\s\S]*?```/, "")
                .trim();
              try {
                pendingChanges = JSON.parse(changesMatch[1]);
                // Agent mode: render inline suggestions on the editor
                if (agentMode && pendingChanges.length > 0) {
                  renderInlineSuggestions(pendingChanges);
                  changesHTML =
                    '<div style="margin-top:8px;padding:8px 12px;background:#3b82f610;border:1px solid #3b82f640;border-radius:6px;font-size:11px">' +
                    '<div style="color:#3b82f6;font-weight:600;margin-bottom:6px">' +
                    '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg> ' +
                    pendingChanges.length +
                    " suggestion" +
                    (pendingChanges.length > 1 ? "s" : "") +
                    " posted to your CV editor</div>" +
                    '<div style="color:#94a3b8;font-size:10px;margin-bottom:8px">Review each suggestion inline, or use the buttons below:</div>' +
                    '<div class="inline-suggestion-controls" style="display:flex;gap:6px">' +
                    '<button class="btn btn-sm btn-primary" onclick="acceptAllInlineSuggestions()" style="font-size:10px">\u2713 Accept All</button>' +
                    '<button class="btn btn-sm btn-secondary" onclick="rejectAllInlineSuggestions()" style="font-size:10px">Reject All</button>' +
                    "</div></div>";
                  pendingChanges = [];
                } else {
                  changesHTML = renderDiffBlocks(pendingChanges);
                }
              } catch (e) {
                changesHTML =
                  '<div class="chat-msg system">⚠️ Could not parse changes</div>';
              }
            }

            appendChatMsg("assistant", messageText, changesHTML);
            chatHistory.push({ role: "assistant", content: response });
          } catch (err) {
            thinkingDiv.remove();
            var chatErr = err.message || "Something went wrong";
            // Additional friendliness for common patterns
            if (chatErr.match(/Failed to fetch|NetworkError|net::/i))
              chatErr = "Network error — check your internet connection";
            if (chatErr.match(/AbortError|abort/i))
              chatErr = "Request was cancelled";
            appendChatMsg("system", "⚠️ " + chatErr);
          }

          aiStreaming = false;
          document.getElementById("chat-send-btn").disabled = false;
        }

        // ═══ RENDER DIFF BLOCKS ═══
        function renderDiffBlocks(changes) {
          if (!changes || !changes.length) return "";
          let html = '<div style="margin-top:8px">';
          changes.forEach(function (c, i) {
            html +=
              '<div class="diff-block">' +
              '<div class="diff-header"><input type="checkbox" checked id="diff-cb-' +
              i +
              '"/> <span>' +
              escapeHtml(c.label || c.path) +
              "</span></div>" +
              '<div class="diff-row before">− ' +
              escapeHtml(c.before) +
              "</div>" +
              '<div class="diff-row after">+ ' +
              escapeHtml(c.after) +
              "</div>" +
              "</div>";
          });
          html +=
            '<div class="diff-actions">' +
            '<button class="btn btn-sm btn-primary" onclick="commitChanges()">✓ Commit Selected</button>' +
            '<button class="btn btn-sm btn-secondary" onclick="commitAllChanges()">Commit All</button>' +
            '<button class="btn btn-sm btn-secondary" onclick="dismissChanges()">Dismiss</button>' +
            "</div></div>";
          return html;
        }

        // ═══ COMMIT CHANGES ═══
        function commitChanges() {
          let applied = 0;
          pendingChanges.forEach(function (c, i) {
            const cb = document.getElementById("diff-cb-" + i);
            if (cb && cb.checked) {
              if (applyChange(c)) applied++;
            }
          });
          pendingChanges = [];
          renderEditor();
          renderPreview();
          autoFit();
          if (activeProfile) saveCurrentProfile(true);
          appendChatMsg(
            "system",
            "✅ Applied " + applied + " change(s) to your CV.",
          );
        }

        function commitAllChanges() {
          let applied = 0;
          pendingChanges.forEach(function (c) {
            if (applyChange(c)) applied++;
          });
          pendingChanges = [];
          renderEditor();
          renderPreview();
          autoFit();
          if (activeProfile) saveCurrentProfile(true);
          appendChatMsg(
            "system",
            "✅ Applied " + applied + " change(s) to your CV.",
          );
        }

        function dismissChanges() {
          pendingChanges = [];
          appendChatMsg("system", "Changes dismissed.");
        }

        function applyChange(c) {
          try {
            // Parse path like "sections[1].jobs[0].bullets[2]"
            const parts = c.path.replace(/\[(\d+)\]/g, ".$1").split(".");
            let obj = cv;
            for (let i = 0; i < parts.length - 1; i++) {
              const key = isNaN(parts[i]) ? parts[i] : parseInt(parts[i]);
              obj = obj[key];
              if (obj === undefined) return false;
            }
            const lastKey = isNaN(parts[parts.length - 1])
              ? parts[parts.length - 1]
              : parseInt(parts[parts.length - 1]);
            obj[lastKey] = c.after;
            return true;
          } catch (e) {
            return false;
          }
        }

        // ═══ INLINE SUGGESTIONS ═══
        var inlineSuggestions = []; // array of {path, label, before, after, index}

        function renderInlineSuggestions(changes) {
          // Clear existing suggestion overlays
          clearInlineSuggestions();
          inlineSuggestions = changes.map(function (c, i) {
            return {
              path: c.path,
              label: c.label || c.path,
              before: c.before,
              after: c.after,
              index: i,
            };
          });

          inlineSuggestions.forEach(function (sug) {
            // Find the editor field that matches this path
            var field = document.querySelector(
              '[data-cv-path="' + sug.path + '"]',
            );
            if (!field) return;

            var box = document.createElement("div");
            box.className = "ai-suggestion";
            box.setAttribute("data-suggestion-index", sug.index);
            box.innerHTML =
              '<div class="ai-suggestion-label">' +
              '<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>' +
              " AI Suggestion" +
              (sug.label !== sug.path ? " — " + escapeHtml(sug.label) : "") +
              "</div>" +
              '<div class="ai-suggestion-before">' +
              escapeHtml(truncateText(sug.before, 120)) +
              "</div>" +
              '<div class="ai-suggestion-text">' +
              escapeHtml(sug.after) +
              "</div>" +
              '<div class="ai-suggestion-actions">' +
              '<button class="ai-suggestion-accept" onclick="acceptInlineSuggestion(' +
              sug.index +
              ')">✓ Accept</button>' +
              '<button class="ai-suggestion-reject" onclick="rejectInlineSuggestion(' +
              sug.index +
              ')">✕ Reject</button>' +
              "</div>";

            // Insert after the field (or after its parent li for bullets)
            var insertAfter =
              field.closest(".bullet-item") ||
              field.closest(".field-row") ||
              field.closest(".job-header") ||
              field;
            insertAfter.parentNode.insertBefore(box, insertAfter.nextSibling);
          });
        }

        function truncateText(text, max) {
          if (!text) return "";
          return text.length > max ? text.substring(0, max) + "..." : text;
        }

        function acceptInlineSuggestion(index) {
          var sug = inlineSuggestions.find(function (s) {
            return s.index === index;
          });
          if (!sug) return;
          if (applyChange({ path: sug.path, after: sug.after })) {
            // Remove this suggestion box
            var box = document.querySelector(
              '.ai-suggestion[data-suggestion-index="' + index + '"]',
            );
            if (box) {
              box.style.borderColor = "#22c55e";
              box.style.background = "#22c55e15";
              box.innerHTML =
                '<div style="color:#22c55e;font-size:10px;font-weight:600">✓ Applied</div>';
              setTimeout(function () {
                box.remove();
              }, 1000);
            }
            // Update the field value in the editor
            var field = document.querySelector(
              '[data-cv-path="' + sug.path + '"]',
            );
            if (field) field.value = sug.after;
            renderPreview();
            autoFit();
            if (activeProfile) saveCurrentProfile(true);
          }
          // Remove from pending list
          inlineSuggestions = inlineSuggestions.filter(function (s) {
            return s.index !== index;
          });
          updateSuggestionCount();
        }

        function rejectInlineSuggestion(index) {
          var box = document.querySelector(
            '.ai-suggestion[data-suggestion-index="' + index + '"]',
          );
          if (box) {
            box.style.opacity = "0";
            box.style.transform = "translateY(-8px)";
            box.style.transition = "all 0.2s";
            setTimeout(function () {
              box.remove();
            }, 200);
          }
          inlineSuggestions = inlineSuggestions.filter(function (s) {
            return s.index !== index;
          });
          updateSuggestionCount();
        }

        function acceptAllInlineSuggestions() {
          var applied = 0;
          inlineSuggestions.forEach(function (sug) {
            if (applyChange({ path: sug.path, after: sug.after })) applied++;
          });
          clearInlineSuggestions();
          inlineSuggestions = [];
          renderEditor();
          renderPreview();
          autoFit();
          if (activeProfile) saveCurrentProfile(true);
          appendChatMsg(
            "system",
            "✅ Applied " + applied + " change(s) to your CV.",
          );
          // Re-grow bullet textareas
          document.querySelectorAll(".bullet-text").forEach(function (ta) {
            autoGrow(ta);
          });
        }

        function rejectAllInlineSuggestions() {
          clearInlineSuggestions();
          inlineSuggestions = [];
          appendChatMsg("system", "All suggestions dismissed.");
        }

        function clearInlineSuggestions() {
          document.querySelectorAll(".ai-suggestion").forEach(function (el) {
            el.remove();
          });
        }

        function updateSuggestionCount() {
          if (inlineSuggestions.length === 0) {
            // Remove the accept/reject all buttons from chat
            var btns = document.querySelectorAll(".inline-suggestion-controls");
            btns.forEach(function (el) {
              el.remove();
            });
          }
        }

        // ═══ AI API CALLS ═══
        function friendlyAIError(status, rawText) {
          // Try to extract message from JSON error body
          var msg = "";
          try {
            var j = JSON.parse(rawText);
            msg =
              (j.error && (j.error.message || j.error.type)) || j.message || "";
          } catch (e) {
            msg = rawText || "";
          }
          msg = msg.substring(0, 300);

          // Translate common errors to plain English
          if (status === 401 || status === 403)
            return "Invalid API key — double-check you copied the full key from your provider dashboard";
          if (msg.match(/not a chat model|not supported.*chat/i))
            return "Wrong model type — this model doesn't support chat. Try switching to a different model in Advanced Settings";
          if (msg.match(/rate.?limit|too many requests|quota/i))
            return "Rate limit hit — wait a minute and try again, or upgrade your plan";
          if (msg.match(/context.?length|too.?long|maximum.*tokens/i))
            return "Message too long — try shortening your CV or asking a simpler question";
          if (msg.match(/model.*not found|does not exist|invalid.*model/i))
            return "Model not found — the selected model may have been removed. Try a different one in Advanced Settings";
          if (msg.match(/billing|payment|insufficient.*funds|plan/i))
            return "Billing issue — check your account has credits/payment set up";
          if (msg.match(/content.*policy|safety|blocked|filtered/i))
            return "Response blocked by content filter — try rephrasing your request";
          if (status === 429)
            return "Too many requests — wait a moment and try again";
          if (status === 500 || status === 502 || status === 503)
            return "Provider is having issues — try again in a few minutes";
          if (status === 404)
            return "Endpoint not found — the model or API URL may be incorrect. Try a different model";
          // Fallback: show a short version
          return (
            "API error (" +
            status +
            "): " +
            (msg.length > 100 ? msg.substring(0, 100) + "…" : msg)
          );
        }

        async function callAI(history, modelType) {
          const systemPrompt = buildSystemPrompt();
          let models;
          if (modelType === "thinking") {
            models = AI_THINKING_MODELS;
          } else if (modelType === "edit") {
            models = AI_EDIT_MODELS;
          } else {
            models = AI_CHAT_MODELS;
          }
          const model = models[aiProvider];
          const isThinking = modelType === "thinking";

          if (
            aiProvider === "openai" ||
            aiProvider === "groq" ||
            aiProvider === "openrouter" ||
            aiProvider === "cerebras" ||
            aiProvider === "ollama"
          ) {
            return await callOpenAICompatible(
              systemPrompt,
              history,
              model,
              isThinking,
            );
          } else if (aiProvider === "claude") {
            return await callClaude(systemPrompt, history, model, isThinking);
          } else if (aiProvider === "gemini") {
            return await callGemini(systemPrompt, history, model, isThinking);
          }
          throw new Error("Unknown provider");
        }

        async function callOpenAICompatible(
          systemPrompt,
          history,
          model,
          isThinking,
        ) {
          const endpoint = AI_ENDPOINTS[aiProvider];
          const isO3 = model === "o3";
          const messages = [];
          if (isO3) {
            // o3 uses developer role instead of system
            messages.push({ role: "developer", content: systemPrompt });
          } else {
            messages.push({ role: "system", content: systemPrompt });
          }
          history.forEach(function (m) {
            messages.push({ role: m.role, content: m.content });
          });

          const body = {
            model: model,
            messages: messages,
            max_tokens: isO3 ? 16384 : 4096,
          };
          if (isO3) {
            body.reasoning_effort = "high";
            // o3 doesn't support temperature
          } else {
            body.temperature = 0.7;
          }

          const headers = { "Content-Type": "application/json" };
          if (aiProvider !== "ollama") {
            headers["Authorization"] = "Bearer " + aiApiKey;
          }

          const res = await fetch(endpoint, {
            method: "POST",
            headers: headers,
            body: JSON.stringify(body),
          });
          if (!res.ok) {
            const err = await res.text();
            throw new Error(friendlyAIError(res.status, err));
          }
          const data = await res.json();
          return data.choices[0].message.content;
        }

        async function callClaude(systemPrompt, history, model, isThinking) {
          const messages = history.map(function (m) {
            return { role: m.role, content: m.content };
          });
          const body = {
            model: model,
            system: systemPrompt,
            messages: messages,
            max_tokens: isThinking ? 16000 : 4096,
          };
          if (isThinking) {
            body.thinking = { type: "enabled", budget_tokens: 10000 };
          }
          const res = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-api-key": aiApiKey,
              "anthropic-version": "2023-06-01",
              "anthropic-dangerous-direct-browser-access": "true",
            },
            body: JSON.stringify(body),
          });
          if (!res.ok) {
            const err = await res.text();
            throw new Error(friendlyAIError(res.status, err));
          }
          const data = await res.json();
          // With extended thinking, find the text block (skip thinking blocks)
          if (data.content && Array.isArray(data.content)) {
            const textBlock = data.content.find(function (b) {
              return b.type === "text";
            });
            if (textBlock) return textBlock.text;
          }
          return data.content[0].text;
        }

        async function callGemini(systemPrompt, history, model, isThinking) {
          const contents = [];
          contents.push({
            role: "user",
            parts: [
              {
                text:
                  systemPrompt +
                  "\n\n(System prompt loaded. Respond to user messages below.)",
              },
            ],
          });
          contents.push({ role: "model", parts: [{ text: "Understood." }] });
          history.forEach(function (m) {
            contents.push({
              role: m.role === "user" ? "user" : "model",
              parts: [{ text: m.content }],
            });
          });
          const url =
            "https://generativelanguage.googleapis.com/v1beta/models/" +
            model +
            ":generateContent?key=" +
            aiApiKey;
          const genConfig = { maxOutputTokens: isThinking ? 16384 : 4096 };
          if (isThinking) {
            genConfig.thinkingConfig = { thinkingBudget: 8192 };
          } else {
            genConfig.temperature = 0.7;
          }
          const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: contents,
              generationConfig: genConfig,
            }),
          });
          if (!res.ok) {
            const err = await res.text();
            throw new Error(friendlyAIError(res.status, err));
          }
          const data = await res.json();
          // Gemini with thinking returns thought + response parts
          const parts = data.candidates[0].content.parts;
          const textPart =
            parts.find(function (p) {
              return !p.thought;
            }) || parts[parts.length - 1];
          return textPart.text;
        }

        // ═══════════════════════════════════════════════════════
        // FIREBASE AUTH
        // ═══════════════════════════════════════════════════════
        const FIREBASE_CONFIG = {
          apiKey: "AIzaSyCp-emrGDenZW_s4PSvVBC9QSfPGP8LOl4",
          authDomain: "topresume-ai.firebaseapp.com",
          projectId: "topresume-ai",
          storageBucket: "topresume-ai.firebasestorage.app",
          messagingSenderId: "505461475975",
          appId: "1:505461475975:web:effee4613a17593a848622",
        };

        let firebaseApp = null;
        let firebaseAuth = null;
        let firebaseDb = null;
        let currentUser = null;
        let cloudSyncEnabled = false;
        let syncDebounceTimer = null;

        function initFirebase() {
          try {
            firebaseApp = firebase.initializeApp(FIREBASE_CONFIG);
            firebaseAuth = firebase.auth();
            firebaseDb = firebase.firestore();
            firebaseAuth.onAuthStateChanged(async function (user) {
              currentUser = user;
              updateAuthUI(user);
              if (user) {
                cloudSyncEnabled = true;
                await loadFromCloud();
              } else {
                cloudSyncEnabled = false;
              }
            });
          } catch (e) {
            console.log("Firebase init error:", e.message);
          }
        }

        function updateAuthUI(user) {
          const wrapper = document.getElementById("sign-in-wrapper");
          const userInfo = document.getElementById("auth-user-info");
          if (user) {
            if (wrapper) wrapper.style.display = "none";
            userInfo.style.display = "flex";
            document.getElementById("auth-avatar").src = user.photoURL || "";
            document.getElementById("auth-name").textContent =
              user.displayName || user.email || "User";
          } else {
            if (wrapper) wrapper.style.display = "";
            userInfo.style.display = "none";
          }
        }

        async function signInWithGoogle() {
          // Close the dropdown
          var dd = document.getElementById("sign-in-dropdown");
          if (dd) dd.classList.remove("open");
          try {
            if (!firebaseAuth) {
              initFirebase();
              if (!firebaseAuth) {
                alert(
                  "Firebase failed to initialize. Check console for errors.",
                );
                return;
              }
            }
            const provider = new firebase.auth.GoogleAuthProvider();
            await firebaseAuth.signInWithPopup(provider);
          } catch (e) {
            if (e.code !== "auth/popup-closed-by-user") {
              console.error("Auth error:", e);
              if (e.code === "auth/unauthorized-domain") {
                alert(
                  "This domain is not authorized for sign-in.\\nGo to Firebase Console → Authentication → Settings → Authorized domains, and add: " +
                    window.location.hostname,
                );
              } else {
                alert("Sign in failed: " + e.message);
              }
            }
          }
        }

        async function signOutUser() {
          try {
            if (firebaseAuth) await firebaseAuth.signOut();
            cloudSyncEnabled = false;
          } catch (e) {
            console.error("Sign out error:", e);
          }
        }

        // ═══════════════════════════════════════════════════════
        // CLOUD SYNC (FIRESTORE)
        // ═══════════════════════════════════════════════════════
        async function syncToCloud() {
          if (!cloudSyncEnabled || !currentUser || !firebaseDb) return;
          // Debounce: wait 2s after last change before syncing
          clearTimeout(syncDebounceTimer);
          syncDebounceTimer = setTimeout(async () => {
            try {
              const profiles = getProfiles();
              const activeProfile = localStorage.getItem(ACTIVE_KEY) || "";
              const currentCv = JSON.stringify(cv);
              await firebaseDb
                .collection("users")
                .doc(currentUser.uid)
                .set(
                  {
                    profiles: profiles,
                    activeProfile: activeProfile,
                    currentDraft: currentCv,
                    profileTags: JSON.parse(
                      localStorage.getItem("cv-profile-tags") || "{}",
                    ),
                    aiProvider: aiProvider || "ollama",
                    aiApiKey:
                      aiApiKey && aiProvider !== "ollama" ? aiApiKey : "",
                    lastSync: firebase.firestore.FieldValue.serverTimestamp(),
                    email: currentUser.email,
                    displayName: currentUser.displayName,
                  },
                  { merge: true },
                );
              console.log("Synced to cloud");
            } catch (e) {
              console.error("Cloud sync error:", e);
            }
          }, 2000);
        }

        async function loadFromCloud() {
          if (!currentUser || !firebaseDb) return;
          try {
            const doc = await firebaseDb
              .collection("users")
              .doc(currentUser.uid)
              .get();
            if (!doc.exists) {
              // First time user - push local data to cloud
              await syncToCloud();
              return;
            }
            const data = doc.data();
            if (!data.profiles) return;

            // Merge cloud profiles with local profiles
            const localProfiles = getProfiles();
            const cloudProfiles = data.profiles;
            let merged = false;
            Object.keys(cloudProfiles).forEach((name) => {
              if (!localProfiles[name]) {
                localProfiles[name] = cloudProfiles[name];
                merged = true;
              }
            });
            // Also push any local-only profiles to the merge
            Object.keys(localProfiles).forEach((name) => {
              if (!cloudProfiles[name]) {
                merged = true;
              }
            });

            if (merged || Object.keys(cloudProfiles).length > 0) {
              // Use cloud as source of truth, but keep local-only profiles
              const finalProfiles = Object.assign(
                {},
                cloudProfiles,
                localProfiles,
              );
              setProfiles(finalProfiles, true); // true = skip cloud sync
            }

            // Restore active profile from cloud if none locally
            if (data.activeProfile && !localStorage.getItem(ACTIVE_KEY)) {
              localStorage.setItem(ACTIVE_KEY, data.activeProfile);
            }

            // Restore tags from cloud
            if (data.profileTags) {
              var localTags = JSON.parse(
                localStorage.getItem("cv-profile-tags") || "{}",
              );
              var cloudTags = data.profileTags;
              var mergedTags = Object.assign({}, cloudTags, localTags);
              localStorage.setItem(
                "cv-profile-tags",
                JSON.stringify(mergedTags),
              );
            }

            // Restore saved API key
            if (data.aiApiKey && data.aiProvider) {
              var provSel = document.getElementById("ai-provider");
              var keyInput = document.getElementById("ai-api-key");
              if (provSel && keyInput && !keyInput.value) {
                provSel.value = data.aiProvider;
                if (data.aiApiKey) keyInput.value = data.aiApiKey;
                onProviderChange();
              }
            }

            // Reload UI
            loadProfileList();
            const activeName = localStorage.getItem(ACTIVE_KEY);
            if (activeName) {
              loadProfile(activeName, true);
            }
            console.log(
              "Loaded from cloud (" +
                Object.keys(data.profiles).length +
                " profiles)",
            );
          } catch (e) {
            console.error("Cloud load error:", e);
          }
        }

        // ═══════════════════════════════════════════════════════
        // NEW CV MODAL
        // ═══════════════════════════════════════════════════════
        function showNewCVModal() {
          document.getElementById("new-cv-modal").classList.add("active");
        }

        function hideNewCVModal() {
          document.getElementById("new-cv-modal").classList.remove("active");
          document.getElementById("modal-upload-step").style.display = "none";
          document.getElementById("modal-options-step").style.display = "block";
          document.getElementById("modal-progress-step").style.display = "none";
        }

        function newCVFromEmpty() {
          hideNewCVModal();
          const name = prompt(
            "Name for the new CV profile:",
            "New CV " + new Date().toLocaleDateString(),
          );
          if (!name) return;
          cv = {
            name: "Your Name",
            title: "Your Title / Headline",
            contact: {
              location: "City, Country",
              phone: "+00 000 000 000",
              email: "email@example.com",
              linkedin: "linkedin.com/in/yourname",
            },
            sections: [
              {
                type: "summary",
                title: "Professional Summary",
                content: "Write your professional summary here...",
              },
              {
                type: "experience",
                title: "Experience",
                jobs: [
                  {
                    company: "Company Name",
                    role: "Job Title",
                    period: "2024 – Present",
                    bullets: ["Describe your key achievement here"],
                  },
                ],
              },
              {
                type: "education",
                title: "Education",
                items: [
                  { school: "University Name", degree: "Degree", year: "2024" },
                ],
              },
              {
                type: "skills",
                title: "Skills",
                content: "Skill 1, Skill 2, Skill 3",
              },
            ],
          };
          renderEditor();
          renderPreview();
          autoFit();
          // Save as new profile
          const profiles = getProfiles();
          profiles[name] = JSON.parse(JSON.stringify(cv));
          setProfiles(profiles);
          localStorage.setItem(ACTIVE_KEY, name);
          loadProfileList();
          document.getElementById("profile-select").value = name;
        }

        var newCVMode = ""; // 'doc' or 'linkedin'

        function newCVFromDoc() {
          newCVMode = "doc";
          document.getElementById("modal-options-step").style.display = "none";
          document.getElementById("modal-upload-step").style.display = "block";
          document.getElementById("upload-title").textContent =
            "📄 Upload Document";
          document.getElementById("upload-desc").textContent =
            "Upload a document (.txt, .md, .pdf) with your experience, and AI will create a structured CV.";
          document
            .getElementById("upload-accept")
            .setAttribute("accept", ".txt,.md,.pdf,.doc,.docx");
        }

        function newCVFromLinkedIn() {
          newCVMode = "linkedin";
          document.getElementById("modal-options-step").style.display = "none";
          document.getElementById("modal-upload-step").style.display = "block";
          document.getElementById("upload-title").textContent =
            "💼 Upload LinkedIn PDF";
          document.getElementById("upload-desc").textContent =
            "Go to LinkedIn → More → Save to PDF, then upload here.";
          document
            .getElementById("upload-accept")
            .setAttribute("accept", ".pdf");
        }

        function triggerFileUpload() {
          document.getElementById("upload-accept").click();
        }

        async function handleNewCVUpload(evt) {
          const file = evt.target.files[0];
          if (!file) return;
          // Show progress
          document.getElementById("modal-upload-step").style.display = "none";
          document.getElementById("modal-progress-step").style.display =
            "block";
          document.getElementById("progress-msg").textContent =
            "Reading file...";

          let text = "";
          try {
            if (file.name.endsWith(".pdf")) {
              // For PDF, try to read as text (basic extraction)
              text = await file.text();
              // If binary PDF, extract readable text
              if (text.startsWith("%PDF")) {
                // Extract text between stream/endstream and clean up
                const matches = text.match(/\(([^)]+)\)/g);
                if (matches) {
                  text = matches.map((m) => m.slice(1, -1)).join(" ");
                } else {
                  text = text
                    .replace(/[^\x20-\x7E\n]/g, " ")
                    .replace(/\s+/g, " ");
                }
              }
            } else {
              text = await file.text();
            }
          } catch (e) {
            text = "Failed to read file: " + e.message;
          }

          if (!text || text.length < 20) {
            alert(
              "Could not extract enough text from the file. Try a .txt or .md file instead.",
            );
            hideNewCVModal();
            return;
          }

          document.getElementById("progress-msg").textContent =
            "AI is generating your CV structure...";

          // Use AI to generate CV JSON
          try {
            const prompt =
              newCVMode === "linkedin"
                ? "Convert this LinkedIn profile into a structured CV. "
                : "Convert this document/text into a structured CV. ";

            const systemMsg = `You are a CV structuring expert. Given raw text from a ${newCVMode === "linkedin" ? "LinkedIn PDF export" : "document"}, extract and structure it into a clean CV JSON object.

Return ONLY valid JSON with this exact structure (no markdown, no explanation, just the JSON):
{
  "name": "Full Name",
  "title": "Professional Headline",
  "contact": { "location": "City, Country", "phone": "", "email": "", "linkedin": "" },
  "sections": [
    { "type": "summary", "title": "Professional Summary", "content": "2-3 sentence summary" },
    { "type": "experience", "title": "Experience", "jobs": [
      { "company": "Company", "role": "Title", "period": "Start – End", "bullets": ["Achievement 1", "Achievement 2"] }
    ]},
    { "type": "education", "title": "Education", "items": [
      { "school": "University", "degree": "Degree", "year": "Year" }
    ]},
    { "type": "skills", "title": "Skills", "content": "Comma-separated skills" }
  ]
}

Make bullet points achievement-focused with action verbs. Preserve all dates, companies, and metrics.`;

            const history = [
              {
                role: "user",
                content:
                  prompt +
                  "\\n\\nHere is the raw text:\\n\\n" +
                  text.substring(0, 12000),
              },
            ];

            // Determine which model/provider to use
            let modelType = "edit"; // use best available model
            const result = await callAI(
              [
                {
                  role: "user",
                  content:
                    prompt + "\\n\\nRaw text:\\n\\n" + text.substring(0, 12000),
                },
              ],
              modelType,
            );

            // Parse the JSON from the response
            let cvData;
            try {
              // Try to find JSON in the response
              const jsonMatch = result.match(/\{[\s\S]*\}/);
              if (jsonMatch) {
                cvData = JSON.parse(jsonMatch[0]);
              } else {
                throw new Error("No JSON found");
              }
            } catch (e) {
              alert("AI returned invalid format. Please try again.");
              hideNewCVModal();
              return;
            }

            // Apply the generated CV
            cv = cvData;
            renderEditor();
            renderPreview();
            autoFit();

            // Save as new profile
            const profileName =
              (cv.name || "New CV") + " — " + new Date().toLocaleDateString();
            const profiles = getProfiles();
            profiles[profileName] = JSON.parse(JSON.stringify(cv));
            setProfiles(profiles);
            localStorage.setItem(ACTIVE_KEY, profileName);
            loadProfileList();
            document.getElementById("profile-select").value = profileName;

            hideNewCVModal();
            appendChatMsg(
              "system",
              "✅ New CV generated from " +
                (newCVMode === "linkedin"
                  ? "LinkedIn export"
                  : "uploaded document") +
                "! Review and refine it using the editor or AI chat.",
            );
          } catch (e) {
            alert(
              "AI generation failed: " +
                e.message +
                "\\n\\nMake sure you have an AI provider connected.",
            );
            hideNewCVModal();
          }
        }

        // ═══════════════════════════════════════════════════════
        // RESIZABLE PANELS
        // ═══════════════════════════════════════════════════════
        (function initResizeHandles() {
          document
            .querySelectorAll(".resize-handle")
            .forEach(function (handle) {
              let startX, startWidthLeft, startWidthRight, leftEl, rightEl;

              handle.addEventListener("mousedown", function (e) {
                e.preventDefault();
                const leftId = handle.dataset.left;
                const rightId = handle.dataset.right;
                leftEl = document.getElementById(leftId);
                rightEl = document.getElementById(rightId);
                if (!leftEl || !rightEl) return;

                startX = e.clientX;
                startWidthLeft = leftEl.getBoundingClientRect().width;
                startWidthRight = rightEl.getBoundingClientRect().width;
                handle.classList.add("active");
                document.body.style.cursor = "col-resize";
                document.body.style.userSelect = "none";

                function onMouseMove(e) {
                  const dx = e.clientX - startX;
                  const newLeft = Math.max(200, startWidthLeft + dx);
                  const newRight = Math.max(200, startWidthRight - dx);
                  leftEl.style.width = newLeft + "px";
                  leftEl.style.flex = "none";
                  rightEl.style.width = newRight + "px";
                  rightEl.style.flex = "none";
                }

                function onMouseUp() {
                  handle.classList.remove("active");
                  document.body.style.cursor = "";
                  document.body.style.userSelect = "";
                  document.removeEventListener("mousemove", onMouseMove);
                  document.removeEventListener("mouseup", onMouseUp);
                  // Trigger preview re-zoom
                  if (typeof autoZoom === "function") autoZoom();
                }

                document.addEventListener("mousemove", onMouseMove);
                document.addEventListener("mouseup", onMouseUp);
              });
            });
        })();

        // Initialize Firebase on load
        initFirebase();

        // ═══════════════════════════════════════════════════════
        // PINCH-TO-ZOOM & PAN ON PREVIEW
        // ═══════════════════════════════════════════════════════
        (function initPreviewGestures() {
          var previewPanel = document.getElementById("preview-panel");
          if (!previewPanel) return;

          // Pinch-to-zoom (trackpad gesture sends wheel with ctrlKey)
          previewPanel.addEventListener(
            "wheel",
            function (e) {
              if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                var delta = e.deltaY > 0 ? -5 : 5;
                var newZoom = Math.max(20, Math.min(200, zoomLevel + delta));
                setZoom(newZoom);
              }
            },
            { passive: false },
          );
        })();

        // Start app AFTER all variable declarations are complete
        init();
      </script>

      <!-- ═══ NEW CV MODAL ═══ -->
      <div class="modal-overlay" id="new-cv-modal">
        <div class="modal">
          <h3>Create New CV</h3>
          <div id="modal-options-step" class="modal-options">
            <button class="modal-option" onclick="newCVFromEmpty()">
              <span class="opt-icon">📝</span>
              <span class="opt-text">
                <span class="opt-title">Empty CV</span>
                <span class="opt-desc">Start from a blank template</span>
              </span>
            </button>
            <button class="modal-option" onclick="newCVFromDoc()">
              <span class="opt-icon">📄</span>
              <span class="opt-text">
                <span class="opt-title">From Document</span>
                <span class="opt-desc"
                  >Upload .txt, .md, .pdf — AI converts to structured CV</span
                >
              </span>
            </button>
            <button class="modal-option" onclick="newCVFromLinkedIn()">
              <span class="opt-icon">💼</span>
              <span class="opt-text">
                <span class="opt-title">From LinkedIn</span>
                <span class="opt-desc"
                  >Upload your LinkedIn PDF export → instant CV</span
                >
              </span>
            </button>
          </div>
          <div id="modal-upload-step" style="display: none">
            <h4 id="upload-title" style="font-size: 13px; margin-bottom: 12px">
              Upload
            </h4>
            <p
              id="upload-desc"
              style="font-size: 11px; color: var(--muted); margin-bottom: 12px"
            ></p>
            <div class="modal-upload-area" onclick="triggerFileUpload()">
              <div class="upload-icon">⬆️</div>
              <p>Click to upload or drag & drop</p>
            </div>
            <input
              type="file"
              id="upload-accept"
              style="display: none"
              onchange="handleNewCVUpload(event)"
            />
          </div>
          <div
            id="modal-progress-step"
            style="display: none"
            class="modal-progress"
          >
            <div class="spinner"></div>
            <p id="progress-msg">Processing...</p>
          </div>
          <button class="modal-close" onclick="hideNewCVModal()">Cancel</button>
        </div>
      </div>
    </div>
    <!-- end app-wrapper -->

    <!-- ═══ DASHBOARD OVERLAY ═══ -->
    <div class="dashboard-overlay" id="dashboard-overlay">
      <div class="dashboard-header">
        <a
          class="logo"
          href="#"
          onclick="
            hideDashboard();
            return false;
          "
        >
          <div class="logo-mark">
            <span class="t">t</span><span class="r">r</span>
          </div>
          <div class="logo-text">
            top<span>resume</span><span class="domain">.ai</span>
          </div>
        </a>
        <button class="btn btn-secondary btn-sm" onclick="hideDashboard()">
          <svg
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
          Close
        </button>
      </div>
      <div class="dashboard-content">
        <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 6px">
          Your CVs
        </h2>
        <p style="font-size: 12px; color: var(--muted); margin-bottom: 20px">
          Select a CV to edit, or create a new one.
        </p>
        <div class="dashboard-search">
          <input
            type="text"
            id="dashboard-search"
            placeholder="Search CVs..."
            oninput="filterDashboard()"
          />
        </div>
        <div class="dashboard-tags" id="dashboard-tags"></div>
        <div class="cv-grid" id="cv-grid"></div>
      </div>
    </div>

    <!-- ═══ DELETE CONFIRM MODAL ═══ -->
    <div class="confirm-modal" id="delete-confirm-modal">
      <div class="confirm-box">
        <h3>Delete CV</h3>
        <p id="delete-confirm-msg">
          Are you sure you want to delete this CV? This cannot be undone.
        </p>
        <div class="confirm-actions">
          <button
            class="btn btn-secondary btn-sm"
            onclick="hideDeleteConfirm()"
          >
            Cancel
          </button>
          <button
            class="btn btn-sm"
            style="background: #ef4444; color: #fff"
            onclick="executeDeleteProfile()"
          >
            Delete permanently
          </button>
        </div>
      </div>
    </div>

    <!-- ═══ TAG EDITOR MODAL ═══ -->
    <div class="tag-editor-modal" id="tag-editor-modal">
      <div class="tag-editor-box">
        <h3>Edit Tags — <span id="tag-editor-profile-name"></span></h3>
        <div class="existing-tags" id="tag-editor-tags"></div>
        <input
          type="text"
          id="tag-editor-input"
          placeholder="Type a tag and press Enter..."
          onkeydown="
            if (event.key === 'Enter') {
              addTagToProfile();
              event.preventDefault();
            }
          "
        />
        <div
          style="
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 12px;
          "
        >
          <button class="btn btn-secondary btn-sm" onclick="closeTagEditor()">
            Done
          </button>
        </div>
      </div>
    </div>

    <!-- ═══ JOB CONTEXT MODAL ═══ -->
    <div class="job-context-modal" id="job-context-modal">
      <div class="job-context-box">
        <h3>🎯 Target Job Context</h3>
        <p>
          Set the target role so AI can tailor your CV specifically for this
          position.
        </p>
        <label for="job-ctx-title">Job Title</label>
        <input
          type="text"
          id="job-ctx-title"
          placeholder="e.g. Sales Development Representative"
        />
        <label for="job-ctx-company">Company</label>
        <input type="text" id="job-ctx-company" placeholder="e.g. OpenAI" />
        <label for="job-ctx-desc">Job Description / Key Requirements</label>
        <textarea
          id="job-ctx-desc"
          placeholder="Paste the job description or list the key requirements here..."
        ></textarea>
        <div
          style="
            display: flex;
            gap: 8px;
            justify-content: space-between;
            margin-top: 4px;
          "
        >
          <button
            class="btn btn-sm"
            style="background: #ef4444; color: #fff"
            onclick="clearJobContext()"
          >
            Clear
          </button>
          <div style="display: flex; gap: 8px">
            <button
              class="btn btn-secondary btn-sm"
              onclick="hideJobContextModal()"
            >
              Cancel
            </button>
            <button class="btn btn-primary btn-sm" onclick="saveJobContext()">
              Save Context
            </button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
